<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stoclix - Trading Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme (Default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #2c333a;
            --text-muted: #3e444a;
            --border-color: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --accent-color: #007bff;
            --chart-text: #212529; /* Chart text color for light theme */
            
            /* Tooltip Variables - Dark theme for all tooltips */
            --tooltip-bg: #111827;
            --tooltip-text: #ffffff;
            --tooltip-border: rgba(255, 255, 255, 0.06);
            --tooltip-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-theme="dark"] {
            --bg-primary: #0d1b2a;
            --bg-secondary: #1b263b;
            --bg-tertiary: #404040;
            --text-primary: #ffffff; /* Brighter */
            --text-secondary: #d1d5db; /* Brighter */
            --text-muted: #d1d5db; /* Brighter for better contrast */
            --border-color: #555555;
            --shadow: rgba(0, 0, 0, 0.3);
            --accent-color: #00d4aa;
            --chart-text: #ffffff; /* Chart text color for dark theme */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Chart-specific styles for better theme integration */
        canvas {
            transition: filter 0.3s ease;
        }

        /* Ensure chart tooltips use theme colors */
        .chartjs-tooltip {
            color: var(--chart-text) !important;
        }

        /* Global Tooltip Styling - Force dark theme for all tooltips */
        .chartjs-tooltip,
        .apexcharts-tooltip,
        .recharts-tooltip-wrapper,
        .echarts-tooltip,
        [class*="tooltip"],
        [id*="tooltip"] {
            background: var(--tooltip-bg) !important;
            color: var(--tooltip-text) !important;
            border: 1px solid var(--tooltip-border) !important;
            box-shadow: var(--tooltip-shadow) !important;
            border-radius: 6px !important;
        }

        /* Chart.js specific tooltip overrides */
        .chartjs-tooltip {
            background: var(--tooltip-bg) !important;
            color: var(--tooltip-text) !important;
            border: 1px solid var(--tooltip-border) !important;
            box-shadow: var(--tooltip-shadow) !important;
        }

        /* ApexCharts tooltip overrides */
        .apexcharts-tooltip {
            background: var(--tooltip-bg) !important;
            color: var(--tooltip-text) !important;
            border: 1px solid var(--tooltip-border) !important;
            box-shadow: var(--tooltip-shadow) !important;
        }

        .apexcharts-tooltip .apexcharts-tooltip-title {
            background: var(--tooltip-bg) !important;
            color: var(--tooltip-text) !important;
            border-bottom: 1px solid var(--tooltip-border) !important;
        }

        .apexcharts-tooltip .apexcharts-tooltip-series-group {
            background: var(--tooltip-bg) !important;
            color: var(--tooltip-text) !important;
        }

        /* Recharts tooltip overrides */
        .recharts-tooltip-wrapper {
            background: var(--tooltip-bg) !important;
            color: var(--tooltip-text) !important;
            border: 1px solid var(--tooltip-border) !important;
            box-shadow: var(--tooltip-shadow) !important;
        }

        .recharts-tooltip-wrapper .recharts-tooltip-label {
            color: var(--tooltip-text) !important;
        }

        .recharts-tooltip-wrapper .recharts-tooltip-item {
            color: var(--tooltip-text) !important;
        }

        /* ECharts tooltip overrides */
        .echarts-tooltip {
            background: var(--tooltip-bg) !important;
            color: var(--tooltip-text) !important;
            border: 1px solid var(--tooltip-border) !important;
            box-shadow: var(--tooltip-shadow) !important;
        }

        /* Custom tooltip container for accessibility */
        #chartjs-custom-tooltip {
            background: var(--tooltip-bg) !important;
            color: var(--tooltip-text) !important;
            border: 1px solid var(--tooltip-border) !important;
            box-shadow: var(--tooltip-shadow) !important;
            border-radius: 6px !important;
            padding: 8px 12px !important;
            font-size: 12px !important;
            font-family: 'Inter', sans-serif !important;
            pointer-events: none !important;
            z-index: 1000 !important;
            position: absolute !important;
            opacity: 0 !important;
            transition: opacity 0.2s ease !important;
            max-width: 200px !important;
            word-wrap: break-word !important;
        }

        #chartjs-custom-tooltip.show {
            opacity: 1 !important;
        }

        /* External tooltip content styling */
        #chartjs-custom-tooltip .tooltip-title {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 4px;
            color: var(--tooltip-text) !important;
        }

        #chartjs-custom-tooltip .tooltip-body {
            font-size: 12px;
            margin-bottom: 2px;
            color: var(--tooltip-text) !important;
        }

        #chartjs-custom-tooltip .tooltip-color {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            margin-right: 6px;
            vertical-align: middle;
        }

        .btn-primary {
            background-color: #3b82f6;
            /* blue-500 */
            color: white;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }

        .nav-item {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .nav-item.active {
            background-color: #3b82f6;
            /* blue-500 */
            color: white;
            border-radius: 0.5rem;
        }

        .nav-item:not(.active):hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .nav-item.active svg, .nav-item.active i {
             stroke: white;
             color: white; /* Added for the Rupee icon */
        }
        
        /* For Webkit browsers */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 20px;
            border: 3px solid transparent;
            background-clip: content-box;
        }
        
        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background-color: #475569;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0;
 transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0);
 }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg);
 }
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: 0.15em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin .75s linear infinite;
        }

        .page.active {
            animation: fadeIn 0.5s ease-in-out;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .calendar-day {
            min-height: 100px;
        }
        
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 250px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-success { background-color: #22c55e;
 }
        .toast-error { background-color: #ef4444;
 }
        .toast-info { background-color: #3b82f6;
 }
        
        /* --- Colorful Icons --- */
        .nav-item:not(.active) .feather-home { stroke: #3b82f6; /* blue-500 */ }
        .nav-item:not(.active) .feather-plus-circle { stroke: #22c55e; /* green-500 */ }
        .nav-item:not(.active) .feather-calendar { stroke: #8b5cf6; /* violet-500 */ }
        .nav-item:not(.active) .feather-list { stroke: #6366f1; /* indigo-500 */ }
        .nav-item:not(.active) .feather-bar-chart-2 { stroke: #f97316; /* orange-500 */ }
        .nav-item:not(.active) .feather-file-text { stroke: #0ea5e9; /* sky-500 */ }
        .nav-item:not(.active) .feather-user { stroke: #64748b; /* slate-500 */ }
        .nav-item:not(.active) .feather-award { stroke: #f59e0b; /* amber-500 */ }
        
        /* Special case for the Rupee symbol which is not a feather icon */
        .nav-item[data-page="fund-management"]:not(.active) i { color: #10b981; /* emerald-500 */ }

        /* Light background for weekday headers (Sun–Sat) */
        .weekday-header {
          background-color: #f5f5f5 !important;
          border: 2px solid #ccc !important; /* stronger outline */
          color: #333;
          border-radius: 6px;
        }

        /* Light background + visible outline for date boxes */
        .date-box {
          background-color: #fafafa !important;
          border: 2px solid #bbb !important; /* more visible border */
          border-radius: 6px;
          position: relative; /* For popup positioning */
          transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .date-box:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px var(--shadow);
            z-index: 10;
        }
        
        .date-box.has-trades {
            cursor: pointer;
        }

        /* Light background + visible outline for weekly summary boxes */
        .week-summary {
          background-color: #fafafa !important;
          border: 2px solid #bbb !important; /* match date-box border */
          border-radius: 6px; /* match date-box border-radius */
          padding: 8px;
          position: relative;
          transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        /* Brighter Calendar Text */
        .weekday-header {
            font-weight: 600;
        }
        .date-box .date-number {
            font-weight: 600;
            font-size: 0.875rem; /* 14px */
            color: var(--text-primary);
        }
        .week-summary .week-label {
            font-weight: 600;
            font-size: 0.875rem; /* 14px */
            color: var(--text-secondary);
        }

        /* Dark Theme Overrides for Calendar Visibility */
        [data-theme="dark"] .weekday-header {
            background-color: #2a3a4b !important;
            border-color: #4a5a6b !important;
            color: #e5e7eb; /* Brighter text for dark mode */
        }
        [data-theme="dark"] .date-box {
            background-color: #1b263b !important;
            border-color: #444 !important;
        }
        [data-theme="dark"] .week-summary {
            background-color: #1b263b !important;
            border-color: #444 !important;
        }
        [data-theme="dark"] .date-box .date-number,
        [data-theme="dark"] .week-summary .week-label {
             color: #f9fafb;
        }

        /* Profit/Loss text inside date boxes */
        .date-box .pl-amount {
            display: block;
            font-size: 12px;
            font-weight: bold;
            margin-top: 4px;
        }

        /* Green for profit */
        .date-box .pl-amount.profit {
            color: #2e7d32;
        }

        /* Red for loss */
        .date-box .pl-amount.loss {
            color: #c62828;
        }
        
        /* Large modal popup */
        .trade-details-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 600px;
            min-width: 320px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            color: var(--text-primary); /* Default text color for dark modal */
            background-color: #1e293b; /* Dark background from image */
        }
        
        [data-theme="light"] .trade-details-modal {
             background-color: var(--bg-primary);
             color: var(--text-primary);
        }
        
        /* Calendar date hover effects */
        .calendar-date-cell {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .calendar-date-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10;
        }
        
        .calendar-date-cell.has-trades {
            position: relative;
        }
        
        .calendar-date-cell.has-trades::after {
            content: 'Click to view details';
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 20;
        }
        
        .calendar-date-cell.has-trades:hover::after {
            opacity: 1;
        }
        
        .trade-details-modal .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #334155;
        }
        
        [data-theme="light"] .trade-details-modal .modal-header {
            border-bottom-color: var(--border-color);
        }

        .trade-details-modal .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            line-height: 1;
            padding: 4px;
            color: var(--text-muted);
        }

        .trade-details-modal .modal-content {
            padding: 1.25rem;
        }
        
        .modal-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        
        .stat-card {
            background-color: #334155; /* Card background from image */
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        [data-theme="light"] .stat-card {
            background-color: var(--bg-secondary);
        }

        .stat-card-label {
            font-size: 0.875rem;
            color: var(--text-muted); /* Muted text color from image */
        }
        [data-theme="light"] .stat-card-label { color: var(--text-muted); }

        .stat-card-value {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .stat-card-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .trades-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .trades-table th, .trades-table td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-size: 0.875rem;
            word-wrap: break-word;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Column-specific alignment */
        .trades-table th:nth-child(1), .trades-table td:nth-child(1) { text-align: left; } /* Symbol */
        .trades-table th:nth-child(2), .trades-table td:nth-child(2) { text-align: center; } /* Side */
        .trades-table th:nth-child(3), .trades-table td:nth-child(3) { text-align: center; } /* Size */
        .trades-table th:nth-child(4), .trades-table td:nth-child(4) { text-align: right; } /* Entry */
        .trades-table th:nth-child(5), .trades-table td:nth-child(5) { text-align: right; } /* Exit */
        .trades-table th:nth-child(6), .trades-table td:nth-child(6) { text-align: right; } /* P&L */
        
        /* Responsive adjustments for smaller screens */
        @media (max-width: 640px) {
            .trade-details-modal {
                width: 98%;
                max-width: none;
                margin: 1rem;
            }
            
            .trades-table th, .trades-table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.75rem;
            }
            
            .trades-table th:nth-child(1), .trades-table td:nth-child(1) { width: 20%; text-align: left; } /* Symbol */
            .trades-table th:nth-child(2), .trades-table td:nth-child(2) { width: 10%; text-align: center; } /* Side */
            .trades-table th:nth-child(3), .trades-table td:nth-child(3) { width: 10%; text-align: center; } /* Size */
            .trades-table th:nth-child(4), .trades-table td:nth-child(4) { width: 20%; text-align: right; } /* Entry */
            .trades-table th:nth-child(5), .trades-table td:nth-child(5) { width: 20%; text-align: right; } /* Exit */
            .trades-table th:nth-child(6), .trades-table td:nth-child(6) { width: 20%; text-align: right; } /* P&L */
        }
        .trades-table th:nth-child(1), .trades-table td:nth-child(1) { width: 18%; } /* Symbol */
        .trades-table th:nth-child(2), .trades-table td:nth-child(2) { width: 12%; } /* Side */
        .trades-table th:nth-child(3), .trades-table td:nth-child(3) { width: 12%; } /* Size */
        .trades-table th:nth-child(4), .trades-table td:nth-child(4) { width: 18%; } /* Entry */
        .trades-table th:nth-child(5), .trades-table td:nth-child(5) { width: 18%; } /* Exit */
        .trades-table th:nth-child(6), .trades-table td:nth-child(6) { width: 22%; } /* P&L */
        .trades-table thead {
             border-bottom: 1px solid #334155;
        }
        [data-theme="light"] .trades-table thead { border-bottom-color: var(--border-color); }
        
        .trades-table th {
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
        }
        [data-theme="light"] .trades-table th { color: var(--text-muted); }

        .trades-table tbody tr:not(:last-child) {
            border-bottom: 1px solid #334155;
        }
        [data-theme="light"] .trades-table tbody tr:not(:last-child) { border-bottom-color: var(--border-color); }

        /* New Add Trade Form Styles */
        .form-btn-group button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .form-btn-group button:hover {
            background-color: var(--bg-secondary);
            border-color: var(--accent-color);
        }
        .form-btn-group button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
         [data-theme="dark"] .form-btn-group button.active {
             color: #0d1b2a;
         }

        /* Direction Button Styles */
        #direction-group button {
            background-color: #f0f0f0; /* Lighter grey for better text contrast */
            color: #333;
            border: 1px solid #ccc;
        }
        #direction-group button.active-long {
            background-color: #006400;
            color: white;
            border-color: #005000;
        }
        #direction-group button.active-short {
            background-color: #ff0000;
            color: white;
            border-color: #cc0000;
        }

        /* Segment & Style Button Styles */
        #segment-group button,
        #trading-style-group button {
            background-color: #d3d3d3;
            color: #333;
            border: 1px solid #bbb;
        }
        #segment-group button.active-green,
        #trading-style-group button.active-green {
            background-color: #006400;
            color: white;
            border-color: #005000;
        }

        /* Date Filter Styles */
        #dateFilter, #startDate, #endDate {
            transition: all 0.2s ease-in-out;
        }

        #dateFilter:focus, #startDate:focus, #endDate:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }


        /* Custom date range animation */
        #customDateRange {
            transition: all 0.3s ease-in-out;
        }

        #customDateRange.hidden {
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }

        #customDateRange:not(.hidden) {
            opacity: 1;
            max-height: 100px;
        }

        /* Mobile responsiveness for date filter */
        @media (max-width: 640px) {
            .flex-col.sm\\:flex-row {
                align-items: stretch;
            }
            
            #dateFilter, #startDate, #endDate {
                width: 100%;
                min-width: auto;
            }
        }
        
        /* Info Tooltip Styles */
        .info-tooltip {
            pointer-events: none;
            word-wrap: break-word;
            white-space: normal;
        }
        
        .info-tooltip-trigger:hover + .info-tooltip,
        .info-tooltip-trigger:focus + .info-tooltip {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .info-tooltip.show {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Responsive tooltip positioning */
        @media (max-width: 640px) {
            .info-tooltip {
                left: 0 !important;
                transform: none !important;
                margin-left: 0 !important;
                width: 280px !important;
                max-width: calc(100vw - 2rem);
            }
            
            .info-tooltip .absolute {
                left: 1rem !important;
                transform: none !important;
            }
        }
        
        @media (max-width: 480px) {
            .info-tooltip {
                width: 240px !important;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body class="antialiased">

    <div id="toast-container"></div>

    <!-- NEW: Auth Container -->
    <div id="auth-container" class="hidden min-h-screen flex items-center justify-center">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-lg shadow-lg" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
            <form id="auth-form">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold">
                        <span style="color: #22c55e;">Stoc</span><span style="color: #ef4444;">lix</span>
                    </h1>
                    <h2 id="auth-title" class="text-2xl font-semibold mt-4" style="color: var(--text-primary);">Sign In</h2>
                    <p class="text-sm" style="color: var(--text-secondary);">Welcome back to your trading journal</p>
                </div>
                
                <div>
                    <label for="auth-email" class="block text-sm font-medium" style="color: var(--text-secondary);">Email Address</label>
                    <input type="email" id="auth-email" required class="mt-1 w-full px-4 py-2 rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium" style="color: var(--text-secondary);">Password</label>
                    <input type="password" id="auth-password" required class="mt-1 w-full px-4 py-2 rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                </div>
                
                <p id="auth-message" class="text-sm text-center h-4"></p>
                
                <button type="submit" id="auth-submit-btn" class="w-full btn-primary font-semibold py-2 px-6 rounded-md shadow-sm flex items-center justify-center">
                    <span class="btn-text">Sign In</span>
                    <span class="spinner hidden"></span>
                </button>
                
                <div class="text-center text-sm mt-4">
                    <a href="#" id="auth-toggle-link" class="font-medium text-blue-600 hover:underline">Don't have an account? Sign up</a>
                </div>
            </form>
        </div>
    </div>


    <!-- Main App Wrapper -->
    <div id="app-container" class="hidden relative h-screen md:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 flex-shrink-0 flex-col fixed inset-y-0 left-0 z-40 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out flex" style="background-color: var(--bg-primary); border-right: 1px solid var(--border-color);">
            <div class="h-16 flex items-center justify-center px-4" style="border-bottom: 1px solid var(--border-color);">
                <img src="logo.png" alt="Stoclix Trading Journal" class="h-10 w-auto object-contain" />
            </div>
            <nav class="flex-1 px-4 py-4 space-y-2">
                <a href="#" data-page="dashboard" class="nav-item flex items-center px-4 py-2 rounded-md active" style="color: var(--text-secondary);">
                    <i data-feather="home" class="mr-3 h-5 w-5"></i> <span>Dashboard</span>
                </a>
                <a href="#" data-page="add-trade" class="nav-item flex items-center px-4 py-2 rounded-md" style="color: var(--text-secondary);">
                    <i data-feather="plus-circle" class="mr-3 h-5 w-5"></i> <span>Add Trade</span>
                </a>
                <a href="#" data-page="trade-calendar" class="nav-item flex items-center px-4 py-2 rounded-md" style="color: var(--text-secondary);">
                    <i data-feather="calendar" class="mr-3 h-5 w-5"></i> <span>Trading Calendar</span>
                </a>
                <a href="#" data-page="trade-history" class="nav-item flex items-center px-4 py-2 rounded-md" style="color: var(--text-secondary);">
                    <i data-feather="list" class="mr-3 h-5 w-5"></i> <span>Trade History</span>
                </a>
                <a href="#" data-page="fund-management" class="nav-item flex items-center px-4 py-2 rounded-md" style="color: var(--text-secondary);">
                    <i class="mr-3 h-5 w-5 flex items-center justify-center font-bold text-lg not-italic">₹</i>
                    <span>Fund Management</span>
                </a>
                <a href="#" data-page="reports" class="nav-item flex items-center px-4 py-2 rounded-md" style="color: var(--text-secondary);">
                    <i data-feather="bar-chart-2" class="mr-3 h-5 w-5"></i> <span>Reports</span>
                </a>
                <a href="#" data-page="trade-statement" class="nav-item flex items-center px-4 py-2 rounded-md" style="color: var(--text-secondary);">
                    <i data-feather="file-text" class="mr-3 h-5 w-5"></i> <span>Trade Statement</span>
                </a>
                <a href="#" data-page="challenge" class="nav-item flex items-center px-4 py-2 rounded-md" style="color: var(--text-secondary);">
                    <i data-feather="award" class="mr-3 h-5 w-5"></i> <span>Challenge</span>
                </a>
                <a href="#" data-page="profile" class="nav-item flex items-center px-4 py-2 rounded-md" style="color: var(--text-secondary);">
                    <i data-feather="user" class="mr-3 h-5 w-5"></i> <span>User Profile</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex flex-col flex-1 w-full overflow-hidden">
             <header class="sticky top-0 backdrop-blur-lg z-30 h-16 flex items-center justify-between px-4 md:px-8" style="background-color: var(--bg-primary); border-bottom: 1px solid var(--border-color);">
                <div class="flex items-center space-x-4">
                    <button id="menu-toggle-btn" class="md:hidden p-2 rounded-full" style="background-color: var(--bg-secondary); color: var(--text-primary);">
                        <i data-feather="menu" class="h-6 w-6"></i>
                    </button>
                    <h2 id="page-title" class="text-xl font-semibold" style="color: var(--text-primary);">Dashboard</h2>
                </div>

                <div class="flex items-center space-x-2 md:space-x-4">
                    <p id="user-display-name" class="hidden md:block text-sm font-medium" style="color: var(--text-secondary);"></p>
                    <div class="flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-yellow-500"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <label for="theme-toggle-input" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" id="theme-toggle-input" class="sr-only peer">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </div>
                     <button class="logout-btn p-2 rounded-full" style="background-color: var(--bg-secondary); color: var(--text-primary);" title="Logout">
                         <i data-feather="log-out" class="h-5 w-5"></i>
                    </button>
                </div>
            </header>
            
            <main id="main-content" class="flex-1 overflow-y-auto">
                <div class="p-4 md:p-8">
                    <!-- Dashboard Page -->
                    <div id="dashboard" class="page active">
                        
                        <!-- Analytics Section with Date Filter -->
                        <div class="flex flex-col sm:flex-row gap-4 mb-6 items-start sm:items-center justify-between">
                            <h2 class="text-2xl font-bold" style="color: var(--text-primary);">Analytics</h2>
                            
                            <!-- Date Filter Section -->
                            <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                                <label class="text-sm font-medium" style="color: var(--text-secondary);">Filter by:</label>
                                <div class="relative">
                                    <select id="dateFilter" class="px-4 py-2 rounded-lg border text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary); min-width: 180px;">
                                        <option value="all-time">All Time</option>
                                        <option value="today">Today</option>
                                        <option value="yesterday">Yesterday</option>
                                        <option value="last-7-days">Last 7 Days</option>
                                        <option value="last-30-days">Last 30 Days</option>
                                        <option value="last-3-months">Last 3 Months</option>
                                        <option value="last-6-months">Last 6 Months</option>
                                        <option value="last-1-year">Last 1 Year</option>
                                        <option value="custom">Custom Date Range</option>
                                    </select>
                                </div>
                                
                                <!-- Custom Date Range Inputs (Hidden by default) -->
                                <div id="customDateRange" class="hidden flex flex-col sm:flex-row gap-2 items-start sm:items-center">
                                    <input type="date" id="startDate" class="px-3 py-2 rounded-lg border text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
                                    <span class="text-sm" style="color: var(--text-secondary);">to</span>
                                    <input type="date" id="endDate" class="px-3 py-2 rounded-lg border text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="p-5 rounded-lg shadow-sm text-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <h3 class="text-sm font-medium" style="color: var(--text-secondary);">Net P&L</h3>
                                <p id="db-net-pnl" class="text-2xl font-bold mt-2" style="color: var(--text-primary);">₹0.00</p>
                                <p id="db-total-trades" class="text-xs" style="color: var(--text-muted);">0 trades</p>
                            </div>
                            <div class="p-5 rounded-lg shadow-sm text-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <h3 class="text-sm font-medium" style="color: var(--text-secondary);">Win Rate</h3>
                                <p id="db-win-rate" class="text-2xl font-bold mt-2" style="color: var(--text-primary);">0%</p>
                                <div class="flex items-center justify-center text-xs" style="color: var(--text-muted);">
                                    <span id="db-won-trades" class="text-green-500 mr-2">0 won</span>
                                    <span id="db-lost-trades" class="text-red-500">0 lost</span>
                                </div>
                            </div>
                            <div class="p-5 rounded-lg shadow-sm text-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <h3 class="text-sm font-medium" style="color: var(--text-secondary);">Profit Factor</h3>
                                <p id="db-profit-factor" class="text-2xl font-bold mt-2" style="color: var(--text-primary);">0.00</p>
                                <p class="text-xs" style="color: var(--text-muted);">Gross P&L split</p>
                            </div>
                            <div class="p-5 rounded-lg shadow-sm text-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <h3 class="text-sm font-medium" style="color: var(--text-secondary);">Avg win/loss trade</h3>
                                <p id="db-avg-win-loss" class="text-2xl font-bold mt-2" style="color: var(--text-primary);">0.00</p>
                                <div class="flex items-center justify-center text-xs" style="color: var(--text-muted);">
                                    <span id="db-avg-win" class="text-green-500 mr-2">+₹0.00</span>
                                    <span id="db-avg-loss" class="text-red-500">-₹0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Account Summary -->
                        <div class="rounded-lg shadow-sm p-6 mb-8" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <h3 class="text-xl font-bold mb-4" style="color: var(--text-primary);">Account Summary</h3>
                            <div id="db-account-summary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div><p class="text-sm" style="color: var(--text-secondary);">NET ACCOUNT VALUE</p><p class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p></div>
                                <div><p class="text-sm" style="color: var(--text-secondary);">NET REALIZED P&L</p><p class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p></div>
                                <div><p class="text-sm" style="color: var(--text-secondary);">AVAILABLE CASH</p><p class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p></div>
                                <div><p class="text-sm" style="color: var(--text-secondary);">DEPLOYED CAPITAL</p><p class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p></div>
                                <div><p class="text-sm" style="color: var(--text-secondary);">TOTAL DEPOSITS</p><p class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p></div>
                                <div><p class="text-sm" style="color: var(--text-secondary);">TOTAL WITHDRAWN</p><p class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p></div>
                                <div><p class="text-sm" style="color: var(--text-secondary);">STARTING BALANCE</p><p class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p></div>
                                <div><p class="text-sm font-medium" style="color: var(--text-secondary);">TOTAL OPEN RISK <span class="text-xs">(0.0%)</span></p><p class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p></div>
                            </div>
                            <p class="text-xs" style="color: var(--text-muted);">Returns are shown once deposits are made.</p>
                        </div>
                        
                        <!-- Open Positions Overview -->
                        <div class="rounded-lg shadow-sm p-6 mb-8" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <h3 class="text-xl font-bold mb-2" style="color: var(--text-primary);">Open Positions Overview</h3>
                            <p class="text-sm mb-6" style="color: var(--text-secondary);">Analysis of your current <span id="open-positions-count">0</span> open position<span id="open-positions-plural">s</span></p>
                            
                            <!-- Open Positions Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <!-- Capital Deployed -->
                                <div class="rounded-lg p-4" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                                    <p class="text-sm font-medium" style="color: var(--text-secondary);">Capital Deployed</p>
                                    <p id="capital-deployed-amount" class="text-2xl font-bold mt-1" style="color: var(--text-primary);">₹0.00</p>
                                    <p id="capital-deployed-description" class="text-xs mt-1" style="color: var(--text-muted);">0 open trade<span id="capital-deployed-plural">s</span></p>
                                </div>
                                
                                <!-- Total Open Risk -->
                                <div class="rounded-lg p-4" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                                    <p class="text-sm font-medium" style="color: var(--text-secondary);">Total Open Risk</p>
                                    <p id="total-open-risk-amount-overview" class="text-2xl font-bold mt-1" style="color: var(--text-primary);">₹0.00</p>
                                    <p class="text-xs mt-1" style="color: var(--text-muted);">At trailing SL / SL</p>
                                </div>
                                
                                <!-- Avg. Time Open -->
                                <div class="rounded-lg p-4" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                                    <p class="text-sm font-medium" style="color: var(--text-secondary);">Avg. Time Open</p>
                                    <p id="avg-time-open" class="text-2xl font-bold mt-1" style="color: var(--text-primary);">0</p>
                                    <p class="text-xs mt-1" style="color: var(--text-muted);">Days per position</p>
                                </div>
                                
                                <!-- Strategy Mix -->
                                <div class="rounded-lg p-4" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                                    <p class="text-sm font-medium mb-3" style="color: var(--text-secondary);">Strategy Mix</p>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div id="long-dot" class="w-3 h-3 rounded-full" style="background-color: #000;"></div>
                                                <span class="text-sm" style="color: var(--text-primary);">Long</span>
                                            </div>
                                            <span id="long-percentage" class="text-sm font-medium" style="color: var(--text-primary);">0%</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center space-x-2">
                                                <div id="short-dot" class="w-3 h-3 rounded-full" style="background-color: #9ca3af;"></div>
                                                <span class="text-sm" style="color: var(--text-primary);">Short</span>
                                            </div>
                                            <span id="short-percentage" class="text-sm font-medium" style="color: var(--text-primary);">0%</span>
                                        </div>
                                        <div class="mt-2">
                                            <div id="long-bar" class="h-2 rounded-full" style="background-color: #000; width: 0%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Open Positions List -->
                            <div class="mt-8">
                                <h4 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">Open Positions</h4>
                                <div id="open-positions-list" class="space-y-3">
                                    <!-- Open positions will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="space-y-8">
                            <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <h3 class="font-semibold" style="color: var(--text-primary);">Account Balance</h3>
                                <p class="text-sm" style="color: var(--text-secondary);">Account Value over time</p>
                                <div class="relative h-64 mt-4">
                                <canvas id="accountBalanceChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Equity Curve and Top Trades Side by Side -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">Equity Curve</h3>
                                    <div class="relative h-80 w-full">
                                    <canvas id="equityCurveChart"></canvas>
                                    </div>
                                </div>
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <div class="flex justify-between items-center mb-4">
                                       <h3 class="text-xl font-bold" style="color: var(--text-primary);">Top Trades</h3>
                                       <a href="#" data-page="trade-history" class="nav-item text-sm font-medium text-blue-600 hover:underline">View All</a>
                                    </div>
                                    <div id="top-trades-widget">
                                        <!-- Top trades will be rendered here -->
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">Monthly Performance</h3>
                                    <div class="relative h-64">
                                    <canvas id="monthlyPerformanceChart"></canvas>
                                    </div>
                                </div>
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">Daily P&L</h3>
                                    <div class="relative h-64">
                                    <canvas id="dailyPnlChart"></canvas>
                                    <p id="dailyPnlMessage" class="hidden absolute inset-0 flex items-center justify-center" style="color: var(--text-muted);">No P&L data yet</p>
                                    </div>
                                </div>
                            </div>
                            <!-- P&L by Trading Style and P&L by Segment Side by Side -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">P&L by Trading Style</h3>
                                    <div class="relative h-64">
                                    <canvas id="pnlByTradingStyleChart"></canvas>
                                    </div>
                                </div>
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">P&L by Segment</h3>
                                    <div class="relative h-64">
                                    <canvas id="pnlBySegmentChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <!-- Win/Loss Distribution and Strategy vs P&L Side by Side -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">Win/Loss Distribution</h3>
                                    <div class="h-64 flex items-center justify-center relative">
                                        <canvas id="winLossDistributionChart"></canvas>
                                        <p id="winLossMessage" class="hidden absolute text-center" style="color: var(--text-muted);">No trades yet</p>
                                    </div>
                                </div>
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">Strategy vs P&L</h3>
                                    <div class="relative h-64">
                                    <canvas id="strategyPnlChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Monthly Commission/Charges and Performance by Day of Week Side by Side -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">Monthly Commission/Charges</h3>
                                    <div class="relative h-64">
                                    <canvas id="monthlyChargesChart"></canvas>
                                    </div>
                                </div>
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">Performance by Day of Week</h3>
                                    <div class="relative h-64">
                                    <canvas id="performanceByDayChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Daily Win Rate vs Average Win Rate and Trade Distribution by Day of the Week Side by Side -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">Daily Win Rate</h3>
                                    <div class="relative h-64" style="min-height: 256px;">
                                    <canvas id="dailyWinRateChart" style="display: block; width: 100%; height: 100%;"></canvas>
                                    <div id="dailyWinRateMessage" class="hidden absolute inset-0 flex items-center justify-center" style="color: var(--text-muted);">Loading chart...</div>
                                    </div>
                                </div>
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <h3 class="font-semibold mb-4" style="color: var(--text-primary);">Trade Distribution by Day of the Week</h3>
                                    <div class="relative h-64">
                                    <canvas id="tradeDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Net P&L by Mood and Most Common Mistakes Charts - Side by Side -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- Net P&L by Mood Chart -->
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <div class="flex justify-between items-center mb-4">
                                        <div>
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Net P&L by Mood</h3>
                                            <p class="text-sm mt-1" style="color: var(--text-muted);">Analyze how your emotional state impacts trading profitability (net P&L after costs)</p>
                                        </div>
                                    </div>
                                    <div class="relative h-64">
                                        <canvas id="netPnlByMoodChart"></canvas>
                                        <div id="netPnlByMoodMessage" class="hidden absolute inset-0 flex items-center justify-center" style="color: var(--text-muted);">Loading chart...</div>
                                    </div>
                                </div>

                                <!-- Most Common Mistakes Chart -->
                                <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="font-semibold" style="color: var(--text-primary);">Most Common Mistakes</h3>
                                    </div>
                                    <div class="relative h-64">
                                        <canvas id="mostCommonMistakesChart"></canvas>
                                        <div id="mostCommonMistakesMessage" class="hidden absolute inset-0 flex items-center justify-center" style="color: var(--text-muted);">Loading chart...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Trade Page -->
                    <div id="add-trade" class="page">
                        <form id="manual-trade-form" class="space-y-1 max-w-6xl mx-auto">
                            <input type="hidden" id="trade-id" name="tradeId">
                            
                            <h2 id="trade-form-title" class="text-3xl font-bold" style="color: var(--text-primary);"></h2>

                            <!-- Tabs -->
                            <div class="flex justify-center mb-6">
                                <div class="flex bg-gray-200 rounded-lg p-1" style="background-color: var(--bg-secondary);">
                                    <button id="trade-tab" class="px-6 py-2 rounded-md text-sm font-medium transition-colors duration-200" style="background-color: var(--bg-primary); color: var(--text-primary);">
                                        Trade
                                    </button>
                                    <button id="journal-tab" class="px-6 py-2 rounded-md text-sm font-medium transition-colors duration-200" style="color: var(--text-secondary);">
                                        Journal
                                    </button>
                                </div>
                            </div>

                            <!-- Trade Tab Content -->
                            <div id="trade-tab-content" class="space-y-6">
                                <!-- Trade Details and Execution Details - Centered Layout -->
                                <div class="flex flex-col items-center space-y-4">
                                    <!-- Trade Details Section -->
                                    <div class="w-full max-w-4xl">
                                        <div class="p-4 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--text-primary); border-color: var(--border-color);">Trade Details</h3>
                                            <div class="space-y-3">
                                                <!-- Trading Style and Symbol Row -->
                                                <div class="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Trading Style</label>
                                                        <select name="tradingStyle" id="trading-style-select" class="w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;">
                                                            <option value="Scalping" selected>Scalping</option>
                                                            <option value="Intraday">Intraday</option>
                                                            <option value="Swing">Swing</option>
                                                            <option value="Position">Position</option>
                                                            <option value="Long-Term">Long-Term</option>
                                                        </select>
                                                    </div>
                                                    <div class="relative">
                                                        <label for="asset-input" class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Symbol</label>
                                                        <input name="asset" type="text" id="asset-input" class="w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" placeholder="e.g.RELIANCE,NIFTY50" required>
                                                        <div id="asset-suggestions" class="absolute z-10 w-full rounded-md mt-1 hidden max-h-48 overflow-y-auto" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);"></div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Segment and Direction Row -->
                                                <div class="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label for="segment-input" class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Segment</label>
                                                        <input name="segment" type="text" id="segment-input" class="w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" value="Equity" readonly>
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Direction</label>
                                                        <div id="direction-group" class="flex gap-1">
                                                            <button type="button" data-value="Long" class="active active-long flex items-center justify-center gap-1 px-2 py-1 rounded-md border text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                                                <i data-feather="arrow-up" class="inline-block h-3 w-3"></i>Long
                                                            </button>
                                                            <button type="button" data-value="Short" class="flex items-center justify-center gap-1 px-2 py-1 rounded-md border text-sm" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-color: var(--border-color);">
                                                                <i data-feather="arrow-down" class="inline-block h-3 w-3"></i>Short
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </div>

                                    <!-- Execution Details Section -->
                                    <div class="w-full max-w-4xl">
                                        <div class="p-4 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--text-primary); border-color: var(--border-color);">Execution Details</h3>
                                            <div class="space-y-2">
                                                <div class="grid grid-cols-4 gap-2">
                                                    <div>
                                                        <label for="entry-date" class="block text-xs font-medium" style="color: var(--text-secondary);">Entry Date</label>
                                                        <input name="entryDate" type="date" id="entry-date" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" required>
                                                    </div>
                                                    <div>
                                                        <label for="entry-time" class="block text-xs font-medium" style="color: var(--text-secondary);">Entry Time</label>
                                                        <input name="entryTime" type="time" id="entry-time" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" required>
                                                    </div>
                                                    <div>
                                                        <label for="exit-date" class="block text-xs font-medium" style="color: var(--text-secondary);">Exit Date</label>
                                                        <input name="exitDate" type="date" id="exit-date" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;">
                                                    </div>
                                                    <div>
                                                        <label for="exit-time" class="block text-xs font-medium" style="color: var(--text-secondary);">Exit Time</label>
                                                        <input name="exitTime" type="time" id="exit-time" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;">
                                                    </div>
                                                </div>
                                                <div class="grid grid-cols-4 gap-2">
                                                    <div>
                                                        <label for="entry-price" class="block text-xs font-medium" style="color: var(--text-secondary);">Entry Price</label>
                                                        <input name="entryPrice" type="number" step="any" id="entry-price" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" placeholder="0.00" required>
                                                    </div>
                                                    <div>
                                                        <label for="quantity" class="block text-xs font-medium" style="color: var(--text-secondary);">Entry Quantity</label>
                                                        <input name="quantity" type="number" id="quantity" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" placeholder="0" required>
                                                    </div>
                                                    <div>
                                                        <label for="exit-price" class="block text-xs font-medium" style="color: var(--text-secondary);">Exit Price</label>
                                                        <input name="exitPrice" type="number" step="any" id="exit-price" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" placeholder="0.00">
                                                    </div>
                                                    <div>
                                                        <label for="exit-quantity" class="block text-xs font-medium" style="color: var(--text-secondary);">Exit Quantity</label>
                                                        <input name="exitQuantity" type="number" id="exit-quantity" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" placeholder="0">
                                                    </div>
                                                </div>
                                                <div class="grid grid-cols-4 gap-2">
                                                    <div>
                                                        <label for="stop-loss" class="block text-xs font-medium" style="color: var(--text-secondary);">Stop loss</label>
                                                        <input name="stopLoss" type="number" step="any" id="stop-loss" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" placeholder="0.00">
                                                    </div>
                                                    <div>
                                                        <label for="target" class="block text-xs font-medium" style="color: var(--text-secondary);">Target price</label>
                                                        <input name="target" type="number" step="any" id="target" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" placeholder="0.00">
                                                    </div>
                                                    <div>
                                                        <label for="brokerage" class="block text-xs font-medium" style="color: var(--text-secondary);">Brokerage</label>
                                                        <input name="brokerage" type="number" step="any" id="brokerage" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" placeholder="0.00">
                                                    </div>
                                                    <div>
                                                        <label for="other-fees" class="block text-xs font-medium" style="color: var(--text-secondary);">Charges</label>
                                                        <input name="otherFees" type="number" step="any" id="other-fees" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;" placeholder="0.00">
                                                    </div>
                                                </div>
                                                
                                                <!-- Total Amount and P&L Summary - Same Line -->
                                                <div class="grid grid-cols-2 gap-2 mt-2">
                                                    <div class="p-2 rounded-md shadow-sm" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                                                        <div class="flex justify-between items-center">
                                                            <span class="text-xs font-medium" style="color: var(--text-muted);">Total Amount</span>
                                                            <span id="total-amount" class="font-bold text-sm" style="color: var(--text-primary);">₹0.00</span>
                                                        </div>
                                                    </div>
                                                    <div class="p-2 rounded-md shadow-sm" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                                                        <div class="space-y-1">
                                                            <div class="flex justify-between items-center">
                                                                <span class="text-xs font-medium" style="color: var(--text-muted);">Gross P&L</span>
                                                                <span id="gross-pnl-amount" class="font-bold text-xs" style="color: var(--text-primary);">₹0.00</span>
                                                            </div>
                                                            <div class="flex justify-between items-center">
                                                                <span class="text-xs font-medium" style="color: var(--text-muted);">Total Charges</span>
                                                                <span id="total-charges" class="font-bold text-xs text-red-500">₹0.00</span>
                                                            </div>
                                                            <div class="flex justify-between items-center">
                                                                <span class="text-xs font-medium" style="color: var(--text-muted);">Net P&L Amount</span>
                                                                <span id="pnl-amount" class="font-bold text-xs" style="color: var(--text-primary);">₹0.00</span>
                                                            </div>
                                                            <div class="flex justify-between items-center">
                                                                <span class="text-xs font-medium" style="color: var(--text-muted);">P&L (%)</span>
                                                                <span id="pnl-percent" class="font-bold text-xs" style="color: var(--text-primary);">0.00%</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </div>
                                </div>

                                <!-- Strategy and Outcome Section - Centered below Execution Details -->
                                <div class="flex justify-center">
                                    <div class="w-full max-w-4xl">
                                        <div class="p-4 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <h3 class="text-lg font-semibold mb-3 border-b pb-2" style="color: var(--text-primary); border-color: var(--border-color);">Strategy and Outcome</h3>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label for="strategy" class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Strategy Tag</label>
                                                    <select name="strategy" id="strategy" class="w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;">
                                                        <option value="Price Action" selected>Price Action</option>
                                                        <option value="Trend Following">Trend Following</option>
                                                        <option value="Breakout">Breakout</option>
                                                        <option value="Reversal">Reversal</option>
                                                        <option value="Scalping">Scalping</option>
                                                        <option value="Swing Trading">Swing Trading</option>
                                                        <option value="Support/Resistance">Support/Resistance</option>
                                                        <option value="Moving Average">Moving Average</option>
                                                        <option value="RSI Strategy">RSI Strategy</option>
                                                        <option value="MACD Strategy">MACD Strategy</option>
                                                        <option value="News Based">News Based</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label for="outcome-summary" class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Outcome Summary</label>
                                                    <select name="outcomeSummary" id="outcome-summary" class="w-full rounded-md border focus:border-blue-500 focus:ring-blue-500 text-sm" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color); padding: 0.375rem;">
                                                        <option>Select outcome summary</option>
                                                        <option>Target Hit</option>
                                                        <option>Stop Loss Hit</option>
                                                        <option>Exited Early (Profit)</option>
                                                        <option>Exited Early (Loss)</option>
                                                        <option>Break Even</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Journal Tab Content -->
                            <div id="journal-tab-content" class="hidden space-y-6">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Left Column - Psychology -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <h3 class="text-xl font-semibold mb-6 border-b pb-4" style="color: var(--text-primary); border-color: var(--border-color);">Psychology</h3>
                                        <div class="space-y-6">
                                            <div>
                                                <label for="emotional-state" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Emotional State During Trade</label>
                                                <select name="emotionalState" id="emotional-state" class="w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                                    <option value="">Select Emotional state</option>
                                                    <option value="Calm">Calm</option>
                                                    <option value="Frustrated">Frustrated</option>
                                                    <option value="Overconfident">Overconfident</option>
                                                    <option value="Anxious">Anxious</option>
                                                    <option value="Impatient">Impatient</option>
                                                    <option value="Confident">Confident</option>
                                                    <option value="Fearful">Fearful</option>
                                                    <option value="Greedy">Greedy</option>
                                                    <option value="Excited">Excited</option>
                                                    <option value="Neutral">Neutral</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-3" style="color: var(--text-secondary);">Mistake Made</label>
                                                <div class="grid grid-cols-2 gap-3">
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="Overtrading" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">Overtrading</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="Risked Too Much" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">Risked Too Much</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="Exited Too Late" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">Exited Too Late</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="Ignored signals" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">Ignored signals</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="Ignored Stop loss" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">Ignored Stop loss</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="Revenge signals" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">Revenge signals</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="Exited Too Early" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">Exited Too Early</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="Revenge Trading" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">Revenge Trading</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="No clean Plan" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">No clean Plan</span>
                                                    </label>
                                                    <label class="flex items-center space-x-2 cursor-pointer">
                                                        <input type="checkbox" name="mistakes" value="No Mistake" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                                        <span class="text-sm" style="color: var(--text-primary);">No Mistake</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column - Trade Journal & Notes -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <h3 class="text-xl font-semibold mb-6 border-b pb-4" style="color: var(--text-primary); border-color: var(--border-color);">Trade Journal & Notes</h3>
                                        <div class="space-y-4">
                                            <p class="text-sm" style="color: var(--text-secondary);">Reason for entry/exit, learning, etc.</p>
                                            <textarea name="reasons" id="reasons" rows="12" class="w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);" placeholder="What was your thesis for this trade? What did you learn?"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Action Buttons -->
                            <div class="flex justify-end gap-4 pt-4 border-t" style="border-color: var(--border-color);">
                                <button type="button" id="clear-trade-form-btn" class="font-semibold py-2 px-6 rounded-md shadow-sm" style="background-color: var(--bg-tertiary); color: var(--text-secondary);">Reset</button>
                                <button type="submit" class="btn-primary font-semibold py-2 px-6 rounded-md shadow-sm flex items-center justify-center min-w-[120px]">
                                    <span class="btn-text">Save Trade</span>
                                    <span class="spinner hidden"></span>
                                </button>
                            </div>
                        </form>
                    </div>


                    <!-- Trade History Page (Enhanced) -->
                    <div id="trade-history" class="page">
                        <div class="mb-8">
                            <h2 class="text-3xl font-bold" style="color: var(--text-primary);">Enhanced Trade Logs</h2>
                            <p class="text-lg" style="color: var(--text-secondary);">Cleaner, sharper, and more insightful.</p>
                        </div>
                        <div class="mb-4 flex justify-end">
                            <button id="export-trades-csv" class="text-sm underline">Export CSV</button>
                        </div>
                        <div class="rounded-lg shadow-sm overflow-x-auto" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <table class="w-full min-w-[1200px] text-sm text-left">
                                <thead class="text-xs uppercase" style="background-color: var(--bg-secondary); color: var(--text-secondary);">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Symbol</th>
                                        <th scope="col" class="px-6 py-3">Net P&L</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3">Entry Price</th>
                                        <th scope="col" class="px-6 py-3">Type</th>
                                        <th scope="col" class="px-6 py-3">Entry Date</th>
                                        <th scope="col" class="px-6 py-3">Stop Loss</th>
                                        <th scope="col" class="px-6 py-3">Quantity</th>
                                        <th scope="col" class="px-6 py-3">Exit Price</th>
                                        <th scope="col" class="px-6 py-3">Exit Date</th>
                                        <th scope="col" class="px-6 py-3">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="trade-history-tbody">
                                    <!-- Dynamic content here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Reports Page -->
                    <div id="reports" class="page">
                        <div class="space-y-8">
                             <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <h2 class="text-2xl font-bold mb-1" style="color: var(--text-primary);">Performance Metrics</h2>
                                <p style="color: var(--text-secondary);" class="mb-6">Key stats for your trading performance.</p>
                                <div id="reports-metrics-grid" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                                    <!-- Dynamic content here -->
                                </div>
                                <div class="mt-4 flex justify-end">
                                    <button id="export-statement-csv" class="text-sm underline">Export Statement CSV</button>
                                </div>
                            </div>

                            <!-- Advanced Trading Metrics -->
                            <div class="space-y-6">
                                <!-- Row 1: Trade Performance, Daily Performance, Trade Execution -->
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <!-- Trade Performance Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Trade Performance</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #3b82f6;">
                                                <i data-feather="award" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="trade-performance-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>

                                    <!-- Daily Performance Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Daily Performance</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #10b981;">
                                                <i data-feather="calendar" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="daily-performance-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>

                                    <!-- Trade Execution Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Trade Execution</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #8b5cf6;">
                                                <i data-feather="trending-up" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="trade-execution-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 2: Time Metrics, Setup Effectiveness, Symbol Frequency -->
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <!-- Time Metrics Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Time Metrics</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #f59e0b;">
                                                <i data-feather="clock" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="time-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>

                                    <!-- Setup Effectiveness Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Setup Effectiveness</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #10b981;">
                                                <i data-feather="bar-chart-2" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="setup-effectiveness-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>

                                    <!-- Symbol Frequency Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Symbol Frequency</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #8b5cf6;">
                                                <i data-feather="pie-chart" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="symbol-frequency-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 3: Capital Usage, Quantity Analysis, Weekday Avg R:R -->
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <!-- Capital Usage Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Capital Usage</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #10b981;">
                                                <i data-feather="dollar-sign" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="capital-usage-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>

                                    <!-- Quantity Analysis Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Quantity Analysis</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #d97706;">
                                                <i data-feather="layers" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="quantity-analysis-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>

                                    <!-- Weekday Avg R:R Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Weekday Avg R:R</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #3b82f6;">
                                                <i data-feather="trending-up" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="weekday-rr-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Row 4: Weekday Win Rate, Daily Trade Activity -->
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <!-- Weekday Win Rate Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Weekday Win Rate</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #3b82f6;">
                                                <i data-feather="calendar" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="weekday-win-rate-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>

                                    <!-- Daily Trade Activity Card -->
                                    <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="font-semibold" style="color: var(--text-primary);">Daily Trade Activity</h3>
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: #8b5cf6;">
                                                <i data-feather="clock" class="w-4 h-4 text-white"></i>
                                            </div>
                                        </div>
                                        <div id="daily-trade-activity-metrics" class="space-y-3">
                                            <!-- Dynamic content -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Trade Calendar Page -->
                    <div id="trade-calendar" class="page">
                         <div id="calendar-stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Dynamic content here -->
                        </div>
                        <div class="rounded-lg shadow-sm p-4" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <div class="p-2 md:p-0 flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
                                <div class="flex items-center space-x-2 md:space-x-4">
                                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" style="color: var(--text-primary);">
                                        <i data-feather="chevron-left" class="h-6 w-6"></i>
                                    </button>
                                    <h2 id="calendar-month-year" class="text-xl font-bold whitespace-nowrap" style="color: var(--text-primary);">Month Year</h2>
                                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" style="color: var(--text-primary);">
                                        <i data-feather="chevron-right" class="h-6 w-6"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div id="monthly-pnl-display" class="font-semibold" style="color: var(--text-primary);">Monthly P&L: ₹0.00</div>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <div class="min-w-[950px]">
                                     <div class="flex gap-2">
                                        <!-- Main calendar part (7 columns) -->
                                        <div class="flex-grow">
                                            <div class="grid grid-cols-7 gap-2 p-2 text-center text-sm font-medium" style="color: var(--text-secondary);">
                                                <div class="bg-gray-100 dark:bg-gray-800/80 rounded-md py-2 weekday-header">Sun</div>
                                                <div class="bg-gray-100 dark:bg-gray-800/80 rounded-md py-2 weekday-header">Mon</div>
                                                <div class="bg-gray-100 dark:bg-gray-800/80 rounded-md py-2 weekday-header">Tue</div>
                                                <div class="bg-gray-100 dark:bg-gray-800/80 rounded-md py-2 weekday-header">Wed</div>
                                                <div class="bg-gray-100 dark:bg-gray-800/80 rounded-md py-2 weekday-header">Thu</div>
                                                <div class="bg-gray-100 dark:bg-gray-800/80 rounded-md py-2 weekday-header">Fri</div>
                                                <div class="bg-gray-100 dark:bg-gray-800/80 rounded-md py-2 weekday-header">Sat</div>
                                            </div>
                                            <div id="calendar-grid-days" class="p-2">
                                                <!-- JS will create week rows here, each being a grid-cols-7 -->
                                            </div>
                                        </div>
                                        <!-- Weekly summaries part (1 column) -->
                                        <div class="w-[140px] flex-shrink-0">
                                            <div class="p-2 text-center text-sm font-medium" style="color: var(--text-secondary);"> <!-- Header placeholder for alignment -->
                                                 <div class="bg-gray-100 dark:bg-gray-800/80 rounded-md py-2 invisible">Summary</div> <!-- Invisible to just take space -->
                                            </div>
                                            <div id="calendar-grid-summaries" class="p-2">
                                                <!-- JS will create summary boxes here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fund Management Page -->
                    <div id="fund-management" class="page">
                         <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h2 class="text-3xl font-bold" style="color: var(--text-primary);">Funds</h2>
                            <div class="flex items-center space-x-2">
                                <button id="fm-deposit-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm flex items-center">
                                    <i data-feather="plus" class="mr-2 h-4 w-4"></i> Deposit
                                </button>
                                <button id="fm-withdraw-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm text-sm flex items-center">
                                     <i data-feather="arrow-up-right" class="mr-2 h-4 w-4"></i> Withdraw
                                </button>
                                <button id="export-ledger-csv" class="text-sm underline ml-2">Export CSV</button>
                            </div>
                        </div>

                        <!-- Stat Cards -->
                        <div id="fm-stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Net Account Value -->
                            <div class="rounded-lg shadow-sm p-6" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium" style="color: var(--text-secondary);">Net Account Value</p>
                                        <p id="net-account-value" class="text-2xl font-bold text-green-600">₹0.00</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Net Realized P&L -->
                            <div class="rounded-lg shadow-sm p-6" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium" style="color: var(--text-secondary);">Net Realized P&L</p>
                                        <p id="net-realized-pnl" class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Starting Account Balance -->
                            <div class="rounded-lg shadow-sm p-6" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium" style="color: var(--text-secondary);">Starting Account Balance</p>
                                        <p id="starting-account-balance" class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Deposits -->
                            <div class="rounded-lg shadow-sm p-6" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium" style="color: var(--text-secondary);">Total Deposits</p>
                                        <p id="total-deposits" class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Deployed Capital -->
                            <div class="rounded-lg shadow-sm p-6" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium" style="color: var(--text-secondary);">Deployed Capital</p>
                                        <p id="deployed-capital" class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Available Cash -->
                            <div class="rounded-lg shadow-sm p-6" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium" style="color: var(--text-secondary);">Available Cash</p>
                                        <p id="available-cash" class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Withdrawn -->
                            <div class="rounded-lg shadow-sm p-6" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium" style="color: var(--text-secondary);">Total Withdrawn</p>
                                        <p id="total-withdrawn" class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Open Risk (%) -->
                            <div class="rounded-lg shadow-sm p-6" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium" style="color: var(--text-secondary);">Total Open Risk <span id="total-open-risk-percentage" class="text-xs">(0.00%)</span></p>
                                        <p id="total-open-risk-amount" class="text-2xl font-bold" style="color: var(--text-primary);">₹0.00</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ledger Table -->
                        <div class="rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs uppercase" style="background-color: var(--bg-secondary); color: var(--text-secondary);">
                                        <tr>
                                            <th class="px-6 py-3 font-medium">Date</th>
                                            <th class="px-6 py-3 font-medium">Type</th>
                                            <th class="px-6 py-3 font-medium">Amount</th>
                                            <th class="px-6 py-3 font-medium">Notes</th>
                                            <th class="px-6 py-3 font-medium">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fund-ledger-body">
                                        <!-- Dynamic content here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Trade Statement Page -->
                    <div id="trade-statement" class="page">
                         <!-- Filter Section -->
                        <div class="rounded-lg shadow-sm p-4 mb-6" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                                <div>
                                    <label for="filter-type" class="block text-sm font-medium" style="color: var(--text-secondary);">Transaction Type</label>
                                    <select id="filter-type" class="w-full rounded-md text-sm border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                        <option>All Types</option>
                                        <option>Trade</option>
                                        <option>Deposit</option>
                                        <option>Withdrawal</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-strategy" class="block text-sm font-medium" style="color: var(--text-secondary);">Strategy</label>
                                    <select id="filter-strategy" class="w-full rounded-md text-sm border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                        <option value="">All Strategies</option>
                                        <option value="Price Action">Price Action</option>
                                        <option value="Trend Following">Trend Following</option>
                                        <option value="Breakout">Breakout</option>
                                        <option value="Reversal">Reversal</option>
                                        <option value="Scalping">Scalping</option>
                                        <option value="Swing Trading">Swing Trading</option>
                                        <option value="Support/Resistance">Support/Resistance</option>
                                        <option value="Moving Average">Moving Average</option>
                                        <option value="RSI Strategy">RSI Strategy</option>
                                        <option value="MACD Strategy">MACD Strategy</option>
                                        <option value="News Based">News Based</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-start-date" class="block text-sm font-medium" style="color: var(--text-secondary);">Start Date</label>
                                    <input type="date" id="filter-start-date" class="w-full rounded-md text-sm border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                </div>
                                <div>
                                    <label for="filter-end-date" class="block text-sm font-medium" style="color: var(--text-secondary);">End Date</label>
                                    <input type="date" id="filter-end-date" class="w-full rounded-md text-sm border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                </div>
                                <button id="apply-filter-btn" class="btn-primary font-semibold py-2 px-4 rounded-md shadow-sm w-full h-fit">Apply</button>
                                <button id="reset-filter-btn" class="font-semibold py-2 px-4 rounded-md shadow-sm w-full h-fit" style="background-color: var(--bg-tertiary); color: var(--text-secondary);">Reset</button>
                            </div>
                        </div>

                        <div class="rounded-lg shadow-sm overflow-x-auto" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <table class="w-full min-w-[1200px] text-sm text-left">
                                <thead class="text-xs uppercase" style="background-color: var(--bg-secondary); color: var(--text-secondary);">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Date</th>
                                        <th scope="col" class="px-6 py-3">Type</th>
                                        <th scope="col" class="px-6 py-3">Symbol/Desc</th>
                                        <th scope="col" class="px-6 py-3">Strategy</th>
                                        <th scope="col" class="px-6 py-3">Gross P/L</th>
                                        <th scope="col" class="px-6 py-3">Charges</th>
                                        <th scope="col" class="px-6 py-3">Net P/L</th>
                                        <th scope="col" class="px-6 py-3">Amount (₹)</th>
                                        <th scope="col" class="px-6 py-3">Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="statement-tbody">
                                    <!-- Dynamic content here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Profile Page -->
                    <div id="profile" class="page">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2 space-y-8">
                                <div class="rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <div class="p-6">
                                        <h3 class="text-xl font-bold mb-6" style="color: var(--text-primary);">Profile Information</h3>
                                        <form id="profile-info-form" class="space-y-6">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div>
                                                    <label class="block text-sm font-medium" style="color: var(--text-secondary);">Full Name</label>
                                                    <input type="text" id="profile-name" name="name" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium" style="color: var(--text-secondary);">Email Address</label>
                                                    <input type="email" id="profile-email" class="mt-1 w-full rounded-md" style="background-color: var(--bg-tertiary);" disabled>
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium" style="color: var(--text-secondary);">Contact Number</label>
                                                    <input type="tel" id="profile-phone" name="phone" placeholder="+91 XXXXX XXXXX" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                                </div>
                                                <div>
                                                    <label class="block text-sm font-medium" style="color: var(--text-secondary);">City</label>
                                                    <input type="text" id="profile-city" name="city" placeholder="e.g. Mumbai" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                                </div>
                                            </div>
                                            <div>
                                                <button type="submit" class="bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-6 rounded-md shadow-sm flex items-center justify-center min-w-[150px]">
                                                    <span class="btn-text">Save Changes</span>
                                                    <span class="spinner hidden"></span>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                 <div class="rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <div class="p-6">
                                        <h3 class="text-xl font-bold mb-6" style="color: var(--text-primary);">Change Password</h3>
                                        <form id="change-password-form" class="space-y-6">
                                            <div>
                                                <label class="block text-sm font-medium" style="color: var(--text-secondary);">Current Password</label>
                                                <input type="password" id="current-password" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                            </div>
                                             <div>
                                                <label class="block text-sm font-medium" style="color: var(--text-secondary);">New Password</label>
                                                <input type="password" id="new-password" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                            </div>
                                             <div>
                                                <label class="block text-sm font-medium" style="color: var(--text-secondary);">Confirm New Password</label>
                                                <input type="password" id="confirm-new-password" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                                            </div>
                                            <div>
                                                <button type="submit" class="btn-primary font-semibold py-2 px-6 rounded-md shadow-sm flex items-center justify-center min-w-[180px]">
                                                     <span class="btn-text">Update Password</span>
                                                     <span class="spinner hidden"></span>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="lg:col-span-1 space-y-8">
                                <div class="rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                    <div class="p-6">
                                        <h3 class="text-xl font-bold mb-4" style="color: var(--text-primary);">Account</h3>
                                        <div class="space-y-3">
                                            <p class="text-sm" style="color: var(--text-secondary);">Member Since</p>
                                            <p id="profile-member-since" class="font-semibold"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Challenge Page -->
                    <div id="challenge" class="page">
                        <div id="challenge-stats-view">
                            <div id="challenge-active-wrapper">
                                <div class="flex items-center justify-between mb-8">
                                    <h2 class="text-3xl font-bold" style="color: var(--text-primary);">Capital Growth Challenge</h2>
                                    <button id="set-challenge-btn" class="btn-primary font-semibold py-2 px-4 rounded-md shadow-sm text-sm">Set Challenge</button>
                                </div>
                                <div id="challenge-active-container" class="space-y-8 hidden">
                                    <p class="text-lg" style="color: var(--text-secondary);">Track your progress towards your trading goals with real-time analytics and performance metrics.</p>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                                        <div class="p-5 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <h3 class="text-sm font-medium" style="color: var(--text-secondary);">Days Remaining</h3>
                                            <p id="challenge-days-remaining" class="text-2xl font-bold mt-2" style="color: var(--text-primary);">0</p>
                                            <p id="challenge-end-date" class="text-xs" style="color: var(--text-muted);">01 Jan 1970</p>
                                        </div>
                                        <div class="p-5 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <h3 class="text-sm font-medium" style="color: var(--text-secondary);">Current Capital</h3>
                                            <p id="challenge-current-capital" class="text-2xl font-bold mt-2">₹0.00</p>
                                            <p id="challenge-target-capital" class="text-xs" style="color: var(--text-muted);">Target: ₹0.00</p>
                                        </div>
                                        <div class="p-5 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <h3 class="text-sm font-medium" style="color: var(--text-secondary);">Daily Target</h3>
                                            <p id="challenge-daily-target" class="text-2xl font-bold mt-2" style="color: var(--text-primary);">₹0.00</p>
                                            <p class="text-xs" style="color: var(--text-muted);">Profit needed per day</p>
                                        </div>
                                        <div class="p-5 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <h3 class="text-sm font-medium" style="color: var(--text-secondary);">Win Rate</h3>
                                            <p id="challenge-win-rate" class="text-2xl font-bold mt-2" style="color: var(--text-primary);">0.00%</p>
                                            <p class="text-xs" style="color: var(--text-muted);">Of challenge period</p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div class="p-6 rounded-lg shadow-sm flex items-center justify-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <div class="relative h-48 w-48">
                                                <canvas id="challengeProgressChart"></canvas>
                                                <div class="absolute inset-0 flex items-center justify-center flex-col">
                                                    <p id="challenge-progress-percent" class="text-3xl font-bold" style="color: var(--text-primary);">0%</p>
                                                    <p class="text-sm" style="color: var(--text-secondary);">Progress</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="p-6 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <h3 class="text-xl font-bold mb-4" style="color: var(--text-primary);">Key Metrics</h3>
                                            <div class="space-y-4">
                                                <div class="flex justify-between items-center border-b pb-2" style="border-color: var(--border-color);">
                                                    <span class="text-sm" style="color: var(--text-secondary);">Average Risk/Reward</span>
                                                    <span id="challenge-avg-rr" class="font-semibold" style="color: var(--text-primary);">0:0</span>
                                                </div>
                                                <div class="flex justify-between items-center border-b pb-2" style="border-color: var(--border-color);">
                                                    <span class="text-sm" style="color: var(--text-secondary);">Highest Profit Day</span>
                                                    <span id="challenge-highest-profit" class="font-semibold text-green-500">₹0.00</span>
                                                </div>
                                                <div class="flex justify-between items-center pb-2" style="border-color: var(--border-color);">
                                                    <span class="text-sm" style="color: var(--text-secondary);">Max Drawdown</span>
                                                    <span id="challenge-max-drawdown" class="font-semibold text-red-500">0.00%</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="challenge-inactive-container" class="flex flex-col items-center justify-center p-12 text-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.5rem;">
                                <i data-feather="award" class="h-16 w-16 mb-4" style="color: var(--text-muted);"></i>
                                <h3 class="text-xl font-semibold mb-2" style="color: var(--text-primary);">No Active Challenge</h3>
                                <p class="text-sm mb-6" style="color: var(--text-secondary);">Set a new challenge to track your progress towards a specific goal.</p>
                                <button id="set-challenge-btn-inactive" class="btn-primary font-semibold py-2 px-6 rounded-md shadow-sm">Start a New Challenge</button>
                            </div>
                        </div>

                        <!-- Achievements Section -->
                        <div class="mt-12">
                            <div class="rounded-lg shadow-sm p-6 mb-8" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">                                                             
                                <h3 class="text-xl font-bold mb-4" style="color: var(--text-primary);">🏆 Achievements</h3>                                                                                             
                                <div class="achievements-container grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-4 text-center">                                                                    
                                    <!-- Badges will be injected here -->
                                </div>
                            </div>
                        </div>

                        <div class="mt-12">
                            <h3 class="text-2xl font-bold mb-6" style="color: var(--text-primary);">Challenge History</h3>
                            <div id="challenge-history-container" class="space-y-4">
                                <!-- History items will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        <!-- Sidebar Overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    </div>

    <!-- Trade Saved Success Modal -->
    <div id="trade-saved-modal" class="modal-overlay hidden">
        <div class="w-full max-w-md m-4 rounded-lg shadow-xl text-center" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
            <div class="p-8">
                <div class="w-16 h-16 mx-auto flex items-center justify-center rounded-full bg-green-100 mb-4">
                    <i data-feather="check-circle" class="h-8 w-8 text-green-600"></i>
                </div>
                <h3 class="text-xl font-bold" style="color: var(--text-primary);">Trade Saved Successfully!</h3>
                <p class="text-sm mt-2 mb-6" style="color: var(--text-secondary);">The more you write, the more you grow. Stay focused!</p>

                <div class="p-4 rounded-lg" style="background-color: var(--bg-secondary);">
                    <h4 class="font-semibold text-md mb-4" style="color: var(--text-primary);">Comparison with Previous Day's P&L</h4>
                    <div class="flex justify-around items-center mb-4">
                        <div>
                            <p class="text-xs" style="color: var(--text-muted);">Today's P&L</p>
                            <p id="tsm-today-pnl" class="font-bold text-lg text-green-500">+₹0.00</p>
                        </div>
                        <div class="border-l h-10" style="border-color: var(--border-color);"></div>
                        <div>
                            <p class="text-xs" style="color: var(--text-muted);">Yesterday's P&L</p>
                            <p id="tsm-yesterday-pnl" class="font-bold text-lg text-green-500">+₹0.00</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-center text-xs p-2 rounded" style="background-color: var(--bg-primary);">
                        <i data-feather="arrow-up" class="h-4 w-4 text-green-500 mr-1"></i>
                        <span id="tsm-comparison-text" style="color: var(--text-secondary);">You saw an increase of ₹0.00 in your pnl.</span>
                    </div>
                </div>

                <button id="trade-saved-close-btn" class="mt-6 w-full btn-primary font-semibold py-2 px-6 rounded-md shadow-sm">Keep Journaling</button>
            </div>
        </div>
    </div>

    <!-- Utilities Floating Buttons -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-2">
        <button id="seed-demo-data" class="px-3 py-2 rounded-md text-xs" style="background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">Seed Demo Data</button>
        <button id="clear-demo-data" class="px-3 py-2 rounded-md text-xs" style="background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">Clear Data</button>
        <button id="set-supabase-keys" class="px-3 py-2 rounded-md text-xs" style="background-color: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">Set Supabase Keys</button>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay hidden">
        <div class="w-full max-w-sm m-4 rounded-lg shadow-xl" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
            <div class="p-6">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center rounded-full bg-red-100">
                        <i data-feather="alert-triangle" class="h-6 w-6 text-red-600"></i>
                    </div>
                    <div>
                        <h3 id="confirmation-title" class="text-lg font-semibold" style="color: var(--text-primary);">Confirmation</h3>
                        <p id="confirmation-message" class="text-sm mt-1" style="color: var(--text-secondary);">Are you sure? This action cannot be undone.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end items-center space-x-3" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                <button type="button" id="confirmation-cancel-btn" class="border font-semibold py-2 px-4 rounded-md shadow-sm" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">Cancel</button>
                <button type="button" id="confirmation-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-md shadow-sm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="transaction-modal" class="modal-overlay hidden">
        <div class="w-full max-w-md m-4 rounded-lg shadow-xl" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
             <form id="transaction-form">
                <input type="hidden" id="ledger-id" name="ledgerId">
                <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--border-color);">
                    <h3 id="transaction-modal-title" class="text-xl font-semibold" style="color: var(--text-primary);">Deposit Funds</h3>
                    <button type="button" class="close-modal-btn p-1 rounded-full" style="background-color: var(--bg-secondary); color: var(--text-primary);">
                        <i data-feather="x" class="h-5 w-5"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium" style="color: var(--text-secondary);">Amount (₹)</label>
                        <input type="number" step="0.01" id="transaction-amount" class="mt-1 block w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);" placeholder="0.00" required>
                    </div>
                     <div>
                        <label for="transaction-date" class="block text-sm font-medium" style="color: var(--text-secondary);">Date</label>
                        <input type="date" id="transaction-date" class="mt-1 block w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);" required>
                    </div>
                     <div>
                        <label for="transaction-notes" class="block text-sm font-medium" style="color: var(--text-secondary);">Notes (Optional)</label>
                        <textarea id="transaction-notes" rows="2" class="mt-1 w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);"></textarea>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end items-center space-x-3" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <button type="button" class="close-modal-btn border font-semibold py-2 px-4 rounded-md shadow-sm" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">Cancel</button>
                    <button type="submit" id="transaction-submit-btn" class="btn-primary font-semibold py-2 px-6 rounded-md shadow-sm flex items-center justify-center min-w-[140px]">
                        <span class="btn-text">Add Deposit</span>
                        <span class="spinner hidden"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Challenge Modal -->
    <div id="challenge-modal" class="modal-overlay hidden">
        <div class="w-full max-w-md m-4 rounded-lg shadow-xl" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
             <form id="challenge-form">
                <input type="hidden" id="challenge-id" name="challengeId">
                <div class="p-6 border-b flex justify-between items-center" style="border-color: var(--border-color);">
                    <h3 id="challenge-modal-title" class="text-xl font-semibold" style="color: var(--text-primary);">Set Trading Challenge</h3>
                    <button type="button" class="close-modal-btn p-1 rounded-full" style="background-color: var(--bg-secondary); color: var(--text-primary);">
                        <i data-feather="x" class="h-5 w-5"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div>
                        <label for="starting-capital" class="block text-sm font-medium" style="color: var(--text-secondary);">Starting Capital (₹)</label>
                        <input type="number" step="1000" id="starting-capital" class="mt-1 block w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);" placeholder="100000" required>
                    </div>
                    <div>
                        <label for="target-capital" class="block text-sm font-medium" style="color: var(--text-secondary);">Target Capital (₹)</label>
                        <input type="number" step="1000" id="target-capital" class="mt-1 block w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);" placeholder="200000" required>
                    </div>
                    <div>
                        <label for="timeframe" class="block text-sm font-medium" style="color: var(--text-secondary);">Timeframe</label>
                        <select id="timeframe" class="mt-1 block w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);">
                            <option value="7">1 Week</option>
                            <option value="30">1 Month</option>
                            <option value="90">3 Months</option>
                            <option value="180">6 Months</option>
                            <option value="365">1 Year</option>
                        </select>
                    </div>
                    <div>
                        <label for="max-risk" class="block text-sm font-medium" style="color: var(--text-secondary);">Max Risk Per Trade (%)</label>
                        <input type="number" step="0.1" id="max-risk" class="mt-1 block w-full rounded-md border focus:border-blue-500 focus:ring-blue-500" style="background-color: var(--bg-primary); color: var(--text-primary); border-color: var(--border-color);" placeholder="2" required>
                    </div>
                </div>
                <div class="p-4 border-t flex justify-end items-center space-x-3" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
                    <button type="button" class="close-modal-btn border font-semibold py-2 px-4 rounded-md shadow-sm" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">Cancel</button>
                    <button type="submit" id="challenge-submit-btn" class="btn-primary font-semibold py-2 px-6 rounded-md shadow-sm flex items-center justify-center min-w-[140px]">
                        <span class="btn-text">Set Challenge</span>
                        <span class="spinner hidden"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Trading Details Modal -->
    <div id="trade-details-modal" class="trade-details-modal">
        <div class="relative">
             <div class="modal-header flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold">Trading Details</h3>
                    <p id="modal-date" class="text-sm" style="color: var(--text-muted);"></p>
                </div>
                <button type="button" class="close-btn">&times;</button>
             </div>
             <div class="modal-content">
                 <div class="modal-stats-grid">
                     <div class="stat-card">
                         <div>
                             <p class="stat-card-label">Total P&L</p>
                             <p id="modal-total-pnl" class="stat-card-value">₹0.00</p>
                         </div>
                         <div class="stat-card-icon" style="background-color: rgba(34, 197, 94, 0.2); color: #22c55e;"><i data-feather="trending-up"></i></div>
                     </div>
                     <div class="stat-card">
                         <div>
                             <p class="stat-card-label">Average R:R</p>
                             <p id="modal-avg-rr" class="stat-card-value">0:0</p>
                         </div>
                         <div class="stat-card-icon" style="background-color: rgba(59, 130, 246, 0.2); color: #3b82f6;"><i data-feather="target"></i></div>
                     </div>
                     <div class="stat-card">
                         <div>
                             <p class="stat-card-label">Total Trades</p>
                             <p id="modal-total-trades" class="stat-card-value">0</p>
                         </div>
                          <div class="stat-card-icon" style="background-color: rgba(234, 179, 8, 0.2); color: #eab308;"><i data-feather="list"></i></div>
                     </div>
                     <div class="stat-card">
                         <div>
                             <p class="stat-card-label">Win Rate</p>
                             <p id="modal-win-rate" class="stat-card-value">0%</p>
                         </div>
                         <div class="stat-card-icon" style="background-color: rgba(245, 158, 11, 0.2); color: #f59e0b;"><i data-feather="award"></i></div>
                     </div>
                 </div>
                 <div class="overflow-y-auto max-h-64 overflow-x-auto">
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Size</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody id="modal-trades-tbody">
                        </tbody>
                    </table>
                 </div>
             </div>
        </div>
    </div>
        
    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" class="hidden fixed bottom-8 right-8 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-300 z-20">
        <i data-feather="arrow-up" class="h-6 w-6"></i>
    </button>

    <!-- Supabase Logic -->
    <script type="module">
        // Import Supabase client from CDN
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Client Initialization ---
        const supabaseUrl = "https://mrpzqskmdeqebslfflaq.supabase.co"; 
        const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ycHpxc2ttZGVxZWJzbGZmbGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyNjExMjIsImV4cCI6MjA3MjgzNzEyMn0.xDIhkJwjHCr5oZ91dZjCHdvGZ2EwhzITaICFa7XG3BA"; 
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        // --- Backend Adapter (Inlined) ---
        const auth = {
            onAuthStateChanged: (callback) => {
                return supabase.auth.onAuthStateChange((event, session) => {
                    const user = session?.user || null;
                    if (user) {
                        user.uid = user.id;
                        user.displayName = user.user_metadata?.name || user.email;
                    }
                    callback(user);
                });
            },
            signIn: async (email, password) => {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                return { user: data.user, session: data.session };
            },
            signUp: async (email, password) => {
                const { data, error } = await supabase.auth.signUp({ email, password });
                if (error) throw error;
                // Optional: Create a profile entry upon sign-up
                if (data.user) {
                    await supabase.from('profiles').insert({ id: data.user.id, name: 'New User', email: data.user.email });
                }
                return { user: data.user, session: data.session };
            },
            updateProfile: async (user, profileData) => {
                const { data, error } = await supabase.auth.updateUser({
                    data: { name: profileData.displayName }
                });
                if (error) throw error;
                return data;
            },
            signOut: async () => {
                await supabase.auth.signOut();
            },
            getUser: async () => {
                const { data, error } = await supabase.auth.getSession();
                if (error) {
                    console.error("Error getting supabase session:", error);
                    return null;
                }
                return data?.session?.user || null;
            }
        };

        const db = {
            serverTimestamp: () => new Date().toISOString(),
            doc: (collectionPath, id) => ({ collection: collectionPath.split('/').pop(), id }),
            setDoc: async (docRef, data) => {
                const payload = { ...data, id: docRef.id };
                const { error } = await supabase
                    .from(docRef.collection)
                    .upsert(payload, { returning: 'minimal' });
                if (error) throw error;
            },
            addDoc: async (collectionPath, data) => {
                const tableName = collectionPath.split('/').pop();
                const { data: inserted, error } = await supabase
                    .from(tableName)
                    .insert(Array.isArray(data) ? data : [data])
                    .select();
                if (error) throw error;
                return inserted;
            },
            getDoc: async (docRef) => {
                const { data, error } = await supabase
                    .from(docRef.collection)
                    .select('*')
                    .eq('id', docRef.id)
                    .single();
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                return {
                    exists: () => !!data,
                    data: () => data,
                    id: docRef.id,
                };
            },
            getDocs: async (queryObj) => {
                let query = supabase.from(queryObj.collection).select('*');
                (queryObj.filters || []).forEach(f => {
                    if (typeof query[f.op] === 'function') {
                        query = query[f.op](f.field, f.value);
                    } else {
                        query = query.eq(f.field, f.value);
                    }
                });
                if (queryObj.orderBy) {
                    query = query.order(queryObj.orderBy.field, { ascending: queryObj.orderBy.direction === 'asc' });
                }
                if (queryObj.limit) {
                    query = query.limit(queryObj.limit);
                }
                const { data, error } = await query;
                if (error) throw error;
                return {
                    docs: (data || []).map(doc => ({ id: doc.id, data: () => doc })),
                    empty: !data || data.length === 0,
                };
            },
            onSnapshot: (queryObj, onNext, onError) => {
                const channel = supabase.channel(`realtime:${queryObj.collection}:${Date.now()}`);
                const handlePayload = async () => {
                    try {
                        const snapshot = await db.getDocs(queryObj);
                        onNext(snapshot);
                    } catch (err) {
                        if (onError) onError(err);
                        else console.error(err);
                    }
                };
                channel.on('postgres_changes', { event: '*', schema: 'public', table: queryObj.collection }, async () => {
                    await handlePayload();
                });
                channel.subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await handlePayload();
                    }
                });
                return () => supabase.removeChannel(channel);
            }
        };

        const query = (collectionName, ...constraints) => {
            let q = { collection: collectionName, filters: [], orderBy: null, limit: null };
            constraints.forEach(c => { q = c(q); });
            return q;
        };
        const where = (field, op, value) => (q) => {
            const supabaseOps = { '==': 'eq', '<': 'lt', '<=': 'lte', '>': 'gt', '>=': 'gte', 'array-contains': 'cs', 'in': 'in' };
            q.filters.push({ field, op: supabaseOps[op], value });
            return q;
        };
        const orderBy = (field, direction = 'asc') => (q) => {
            q.orderBy = { field, direction };
            return q;
        };
        const limit = (num) => (q) => {
            q.limit = num;
            return q;
        };
        // --- End of Inlined Adapter ---

        // === Small helper services for trades and files ===
        async function addTrade(trade) {
          // trade: { user_id, asset, entryPrice, exitPrice, quantity, entryDate, exitDate, pnl, ... }
          const { data, error } = await supabase.from('trades').insert([trade]).select();
          if (error) throw error;
          return data[0];
        }

        async function uploadAttachment(userId, file) {
          // `file` is an input File object. Place in 'attachments' bucket.
          const filename = `${userId}/${Date.now()}_${file.name}`;
          const { error: uploadErr } = await supabase.storage.from('attachments').upload(filename, file);
          if (uploadErr) throw uploadErr;
          const { data: { publicUrl } } = supabase.storage.from('attachments').getPublicUrl(filename);
          return { publicUrl, path: filename };
        }

        async function getTradesForCalendar(userId, startDateISO, endDateISO) {
          const { data, error } = await supabase
            .from('trades')
            .select('*')
            .eq('user_id', userId)
            .gte('exit_date', startDateISO)
            .lte('exit_date', endDateISO)
            .order('exit_date', { ascending: true });
          if (error) throw error;
          return data;
        }


        // --- GLOBAL APP STATE ---
        const appState = {
            theme: localStorage.getItem('theme') || 'light',
            calendarDate: new Date(),
            user: null,
            trades: [],
            ledger: [],
            challenge: null,
            challengeHistory: [],
            achievements: [],
            accountValue: 0,
            clockIntervalId: null,
            unsubscribeTrades: () => {},
            unsubscribeLedger: () => {},
            unsubscribeProfile: () => {},
            unsubscribeChallenge: () => {},
            unsubscribeChallengeHistory: () => {},
            unsubscribeAchievements: () => {},
        };


        // --- UI ELEMENTS ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const mainContent = document.getElementById('main-content');
        const pageTitle = document.getElementById('page-title');
        const themeToggleInput = document.getElementById('theme-toggle-input');
        const sidebar = document.getElementById('sidebar');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const confirmationModal = document.getElementById('confirmation-modal');
        const liveTimeEl = document.getElementById('live-time');
        const liveDateEl = document.getElementById('live-date');
        
        // --- UTILITY FUNCTIONS ---
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            let icon = '';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'alert-circle';
            if (type === 'info') icon = 'info';
            toast.innerHTML = `<i data-feather="${icon}" class="h-5 w-5"></i><span>${message}</span>`;
            container.appendChild(toast);
            feather.replace();
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        };

        const toggleSpinner = (button, show) => {
            const spinner = button.querySelector('.spinner');
            const btnText = button.querySelector('.btn-text');
            if (spinner && btnText) {
                spinner.classList.toggle('hidden', !show);
                btnText.classList.toggle('hidden', show);
            }
            button.disabled = show;
        };
        
        const formatCurrency = (value) => {
             return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(value || 0);
        };

        // Get theme-aware colors for charts
        const getThemeColors = () => {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const chartTextColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-text').trim();
            return {
                textPrimary: isDark ? '#ffffff' : '#212529',
                textSecondary: isDark ? '#d1d5db' : '#2c333a',
                textMuted: isDark ? '#d1d5db' : '#3e444a',
                gridColor: 'rgba(128, 128, 128, 0.1)',
                chartText: chartTextColor || (isDark ? '#ffffff' : '#212529'),
                // Ensure we always have a valid text color
                textColor: isDark ? '#ffffff' : '#212529'
            };
        };

        // Get continuous tooltip configuration for all charts
        const getContinuousTooltipConfig = (themeColors, customCallbacks = {}) => {
            return {
                enabled: true,
                mode: 'index',
                intersect: false,
                position: 'nearest',
                backgroundColor: '#111827', // Use dark background for all tooltips
                titleColor: '#ffffff', // White text for all tooltips
                bodyColor: '#ffffff', // White text for all tooltips
                borderColor: 'rgba(255, 255, 255, 0.06)',
                borderWidth: 1,
                cornerRadius: 6,
                displayColors: true,
                padding: 12,
                titleFont: {
                    size: 13,
                    weight: 'bold'
                },
                bodyFont: {
                    size: 12
                },
                animation: {
                    duration: 0
                },
                ...customCallbacks
            };
        };

        // Update all charts when theme changes
        const updateChartsOnThemeChange = () => {
            const colors = getThemeColors();
            console.log('Updating charts with theme colors:', colors);
            
            Object.values(chartInstances).forEach((chart, index) => {
                if (chart && typeof chart.update === 'function') {
                    try {
                        // Update chart options with new theme colors
                        if (chart.options && chart.options.scales) {
                            // Update axis text colors
                            if (chart.options.scales.x && chart.options.scales.x.ticks) {
                                chart.options.scales.x.ticks.color = colors.chartText || colors.textColor;
                            }
                            if (chart.options.scales.y && chart.options.scales.y.ticks) {
                                chart.options.scales.y.ticks.color = colors.chartText || colors.textColor;
                            }
                        }
                        
                        // Update legend colors
                        if (chart.options && chart.options.plugins && chart.options.plugins.legend) {
                            if (chart.options.plugins.legend.labels) {
                                chart.options.plugins.legend.labels.color = colors.chartText || colors.textColor;
                            }
                        }
                        
                        // Update tooltip colors and continuous mode - Force dark theme for all tooltips
                        if (chart.options && chart.options.plugins && chart.options.plugins.tooltip) {
                            // Force all tooltips to use dark theme regardless of page theme
                            chart.options.plugins.tooltip.backgroundColor = '#111827';
                            chart.options.plugins.tooltip.titleColor = '#ffffff';
                            chart.options.plugins.tooltip.bodyColor = '#ffffff';
                            chart.options.plugins.tooltip.borderColor = 'rgba(255, 255, 255, 0.06)';
                            
                            // Ensure continuous tooltip mode is enabled
                            chart.options.plugins.tooltip.mode = 'index';
                            chart.options.plugins.tooltip.intersect = false;
                        }
                        
                        // Update grid colors
                        if (chart.options && chart.options.scales) {
                            if (chart.options.scales.x && chart.options.scales.x.grid) {
                                chart.options.scales.x.grid.color = colors.gridColor;
                            }
                            if (chart.options.scales.y && chart.options.scales.y.grid) {
                                chart.options.scales.y.grid.color = colors.gridColor;
                            }
                        }
                        
                        chart.update();
                        console.log(`Updated chart ${index + 1} successfully`);
                    } catch (error) {
                        console.error(`Error updating chart ${index + 1}:`, error);
                    }
                }
            });
        };

        // Format amount in compact format
        const formatAmount = (value) => {
            const abs = Math.abs(value);
            if (abs >= 1_000_000) return `₹${(value/1_000_000).toFixed(1)}M`;
            if (abs >= 1_000) return `₹${(value/1_000).toFixed(1)}K`;
            return `₹${Math.round(value)}`;
        };

        const formatDate = (dateString, includeTime = false) => {
            if (!dateString) return '-';
            const d = new Date(dateString); // Supabase returns ISO strings
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            if (includeTime) {
                options.hour = '2-digit';
                options.minute = '2-digit';
            }
            return d.toLocaleDateString('en-GB', options);
        };

        // Helper function to format date as DD-MM-YYYY
        const formatDateDDMMYYYY = (dateString) => {
            if (!dateString) return '';
            const d = new Date(dateString);
            // Check if date is valid
            if (isNaN(d.getTime())) return dateString; // Return original string if invalid date
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}-${month}-${year}`;
        };
        
        const countTradingDays = (startDate, endDate) => {
            let count = 0;
            const curDate = new Date(startDate.getTime());
            while (curDate <= endDate) {
                const dayOfWeek = curDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // 0=Sun, 6=Sat
                    count++;
                }
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        };
        
        const calculateNetPnl = (trade) => {
            if (!trade.exit_price || !trade.exit_date) return 0;
            // Calculate gross P&L based on exit quantity (for partial exit support)
            // Use exit quantity if provided, otherwise use full entry quantity
            const exitQty = trade.exit_quantity > 0 ? trade.exit_quantity : trade.quantity;
            const isShort = trade.trade_type === 'Short' || trade.direction === 'Short';
            const grossPnl = (trade.exit_price - trade.entry_price) * exitQty * (isShort ? -1 : 1);                                                                                     
            const brokerage = trade.brokerage || 0;
            const otherFees = trade.other_fees || 0;
            return grossPnl - brokerage - otherFees;
        };
        
        const calculatePnlPercentage = (trade) => {
            if (!trade.exit_price || !trade.entry_price || !trade.quantity) return 0;
            // Calculate P&L percentage based on total investment and total return
            // This shows the actual return percentage on the total investment
            // For partial exits: shows what percentage of total investment was returned
            const netPnl = calculateNetPnl(trade);
            const totalInvestment = trade.entry_price * trade.quantity; // Always use full entry quantity for total investment
            return (netPnl / totalInvestment) * 100;
        };
        
        const updateLiveClock = () => {
            if (!liveTimeEl || !liveDateEl) return;
            const now = new Date();
            const timeOptions = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true };
            liveTimeEl.textContent = now.toLocaleTimeString('en-IN', timeOptions);
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            liveDateEl.textContent = now.toLocaleDateString('en-IN', dateOptions);
        };

        // --- Trade Saved Modal ---
        const tradeSavedModal = document.getElementById('trade-saved-modal');
        const showTradeSavedModal = () => {
            const allTrades = appState.trades.filter(t => t.exit_date);
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const yesterday = new Date();
            yesterday.setDate(now.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            let todaysPnl = 0;
            let yesterdaysPnl = 0;
            allTrades.forEach(trade => {
                const tradeDateStr = new Date(trade.exit_date).toISOString().split('T')[0];
                const pnl = calculateNetPnl(trade);
                if (tradeDateStr === todayStr) {
                    todaysPnl += pnl;
                } else if (tradeDateStr === yesterdayStr) {
                    yesterdaysPnl += pnl;
                }
            });
            const pnlDifference = todaysPnl - yesterdaysPnl;
            const todayPnlEl = document.getElementById('tsm-today-pnl');
            todayPnlEl.textContent = `${todaysPnl >= 0 ? '+' : ''}${formatCurrency(todaysPnl)}`;
            todayPnlEl.className = `font-bold text-lg ${todaysPnl >= 0 ? 'text-green-500' : 'text-red-500'}`;
            const yesterdayPnlEl = document.getElementById('tsm-yesterday-pnl');
            yesterdayPnlEl.textContent = `${yesterdaysPnl >= 0 ? '+' : ''}${formatCurrency(yesterdaysPnl)}`;
            yesterdayPnlEl.className = `font-bold text-lg ${yesterdaysPnl >= 0 ? 'text-green-500' : 'text-red-500'}`;
            const comparisonTextEl = document.getElementById('tsm-comparison-text');
            const comparisonIconContainer = comparisonTextEl.previousElementSibling;
            if (pnlDifference >= 0) {
                comparisonTextEl.textContent = `You saw an increase of ${formatCurrency(pnlDifference)} in your pnl compared to the last session!`;
                comparisonIconContainer.innerHTML = `<i data-feather="arrow-up" class="h-4 w-4 text-green-500 mr-1"></i>`;
            } else {
                comparisonTextEl.textContent = `You saw a decrease of ${formatCurrency(Math.abs(pnlDifference))} in your pnl compared to the last session.`;
                comparisonIconContainer.innerHTML = `<i data-feather="arrow-down" class="h-4 w-4 text-red-500 mr-1"></i>`;
            }
            tradeSavedModal.classList.remove('hidden');
            feather.replace();
        };

        document.getElementById('trade-saved-close-btn').addEventListener('click', () => {
            tradeSavedModal.classList.add('hidden');
            navigateTo('trade-history');
        });

        // --- Confirmation Modal ---
        let confirmCallback = null;
        const showConfirmationModal = (message, onConfirm, title = "Confirm Deletion", confirmText = "Delete") => {
            document.getElementById('confirmation-message').textContent = message;
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-confirm-btn').textContent = confirmText;
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
            feather.replace();
        };
        const hideConfirmationModal = () => {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        };
        document.getElementById('confirmation-confirm-btn').addEventListener('click', () => {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideConfirmationModal();
        });
        document.getElementById('confirmation-cancel-btn').addEventListener('click', hideConfirmationModal);

        // --- THEME MANAGEMENT ---
        const applyTheme = () => {
            const isDark = appState.theme === 'dark';
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            if (themeToggleInput) {
                themeToggleInput.checked = isDark;
            }
            if (appState.user) {
                renderAllCharts();
            }
        };

        if (themeToggleInput) {
            themeToggleInput.addEventListener('change', () => {
                appState.theme = themeToggleInput.checked ? 'dark' : 'light';
                localStorage.setItem('theme', appState.theme);
                applyTheme();
                // Update all charts with new theme colors
                setTimeout(() => {
                    updateChartsOnThemeChange();
                }, 100); // Small delay to ensure theme is applied
            });
        }
        
        // --- SIDEBAR TOGGLE FOR MOBILE ---
        const toggleSidebar = () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebarOverlay.classList.toggle('hidden');
        };

        menuToggleBtn?.addEventListener('click', toggleSidebar);
        sidebarOverlay?.addEventListener('click', toggleSidebar);

        document.querySelectorAll('#sidebar .nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth < 768) {
                    toggleSidebar();
                }
            });
        });

        // --- AUTHENTICATION & UI VISIBILITY ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                appState.user = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.getElementById('user-display-name').textContent = user.displayName || 'Guest';
                
                appState.unsubscribeTrades();
                appState.unsubscribeLedger();
                appState.unsubscribeProfile();
                appState.unsubscribeChallenge();
                appState.unsubscribeChallengeHistory();
                appState.unsubscribeAchievements();

                if (appState.clockIntervalId) clearInterval(appState.clockIntervalId);
                updateLiveClock();
                appState.clockIntervalId = setInterval(updateLiveClock, 1000);

                setupSupabaseListeners();
                
                navigateTo('dashboard');
                applyTheme();
            } else {
                appState.user = null;
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                if (appState.clockIntervalId) clearInterval(appState.clockIntervalId);
                appState.clockIntervalId = null;
            }
        });

        // --- AUTH FORM LOGIC ---
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn').querySelector('.btn-text');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authMessage = document.getElementById('auth-message');
        let authMode = 'signin'; // 'signin' or 'signup'

        authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            authMode = authMode === 'signin' ? 'signup' : 'signin';
            authMessage.textContent = '';
            if (authMode === 'signin') {
                authTitle.textContent = 'Sign In';
                authSubmitBtn.textContent = 'Sign In';
                authToggleLink.textContent = "Don't have an account? Sign up";
            } else {
                authTitle.textContent = 'Sign Up';
                authSubmitBtn.textContent = 'Create Account';
                authToggleLink.textContent = "Already have an account? Sign in";
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const button = document.getElementById('auth-submit-btn');
            
            toggleSpinner(button, true);
            authMessage.textContent = '';

            try {
                if (authMode === 'signin') {
                    await auth.signIn(email, password);
                } else {
                    await auth.signUp(email, password);
                    showToast('Welcome! Please check your email to confirm your account.', 'success');
                }
            } catch (error) {
                authMessage.textContent = error.message;
                authMessage.style.color = 'red';
            } finally {
                toggleSpinner(button, false);
            }
        });
        
        // --- DATA LISTENERS (Supabase Realtime) ---
        const setupSupabaseListeners = () => {
            if (!appState.user) return;
            const userId = appState.user.id;
            
            const tradesQuery = query(collection(`trades`), where('user_id', '==', userId), orderBy("entry_date", "desc"));
            appState.unsubscribeTrades = db.onSnapshot(tradesQuery, (snapshot) => {
                appState.trades = snapshot.docs.map(doc => doc.data());
                updateTradeDependentUI();
            }, (error) => {
                console.error("Error fetching trades:", error);
                showToast("Could not fetch trades.", "error");
            });

            const ledgerQuery = query(collection(`ledger`), where('user_id', '==', userId), orderBy("date", "desc"));
            appState.unsubscribeLedger = db.onSnapshot(ledgerQuery, (snapshot) => {
                appState.ledger = snapshot.docs.map(doc => doc.data());
                 updateLedgerDependentUI();
            }, (error) => {
                console.error("Error fetching ledger:", error);
                showToast("Could not fetch fund data.", "error");
            });
            
            const profileQuery = query(collection('profiles'), where('id', '==', userId), limit(1));
            appState.unsubscribeProfile = db.onSnapshot(profileQuery, (snapshot) => {
                if (!snapshot.empty) {
                    renderProfilePage(snapshot.docs[0].data());
                }
            });

            const activeChallengeQuery = query(collection('challenges'), where('user_id', '==', userId), where('status', '==', 'active'), limit(1));
            appState.unsubscribeChallenge = db.onSnapshot(activeChallengeQuery, (snapshot) => {
                appState.challenge = snapshot.empty ? null : snapshot.docs[0].data();
                renderChallenge();
            });

            const historyQuery = query(collection('challenges'), where('user_id', '==', userId), where("status", "in", ["completed", "failed"]));
            appState.unsubscribeChallengeHistory = db.onSnapshot(historyQuery, (snapshot) => {
                const history = snapshot.docs.map(doc => doc.data());
                history.sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
                appState.challengeHistory = history;
                renderChallengeHistory();
            }, (error) => console.error("Error fetching challenge history:", error));
            
            const achievementsQuery = query(collection('achievements'), where('user_id', '==', userId), orderBy("awarded_at", "desc"));
            appState.unsubscribeAchievements = db.onSnapshot(achievementsQuery, (snapshot) => {
                appState.achievements = snapshot.docs.map(doc => doc.data());
                renderAchievements();
            }, (error) => console.error("Error fetching achievements:", error));
        };
        
        const updateTradeDependentUI = () => {
            renderDashboard();
            renderTradeHistory();
            renderCalendar();
            renderReports();
            renderStatement();
            renderChallenge();
            renderAchievements();
            
            // Force challenge page update if it's currently visible
            const challengePage = document.getElementById('challenge');
            if (challengePage && !challengePage.classList.contains('hidden')) {
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    renderChallenge();
                    renderChallengeHistory();
                }, 100);
            }
        };

        const updateLedgerDependentUI = () => {
            renderDashboard();
            renderFundManagement();
            renderStatement();
        };

        document.querySelectorAll('.logout-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                await auth.signOut();
                showToast("You have been signed out.", "info");
            });
        });

        // --- PAGE NAVIGATION ---
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');
        const navigateTo = (pageId) => {
            pages.forEach(p => p.classList.remove('active'));
            const newPage = document.getElementById(pageId);
            if (newPage) newPage.classList.add('active');
            mainContent.scrollTo(0, 0); 
            navItems.forEach(item => item.classList.remove('active'));
            const activeNavItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
            if(activeNavItem) {
                activeNavItem.classList.add('active');
                pageTitle.textContent = activeNavItem.querySelector('span').textContent.trim();
            }
            if (pageId === 'add-trade') {
                clearTradeForm();
                // Re-setup button groups when navigating to add trade page
                setTimeout(() => {
                    setupButtonGroups();
                }, 100);
            }
            if (pageId === 'dashboard') {
                renderDashboard();
            }
            if (pageId === 'trade-history') {
                renderTradeHistory();
            }
            if (pageId === 'fund-management') {
                renderFundManagement();
            }
            if (pageId === 'trade-statement') {
                renderStatement();
            }
            if (pageId === 'reports') {
                renderReports();
                // Replace feather icons for the new metric cards
                setTimeout(() => {
                    feather.replace();
                }, 100);
            }
            if (pageId === 'trade-calendar') {
                renderCalendar();
            }
            if (pageId === 'challenge') {
                renderChallenge();
                renderChallengeHistory();
                renderAchievements();
            }
        };
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(item.dataset.page);
            });
        });

        // --- FUND MANAGEMENT MODAL LOGIC ---
        const transactionModal = document.getElementById('transaction-modal');
        const transactionForm = document.getElementById('transaction-form');
        const fmDepositBtn = document.getElementById('fm-deposit-btn');
        const fmWithdrawBtn = document.getElementById('fm-withdraw-btn');
        const transactionTitle = document.getElementById('transaction-modal-title');
        const transactionSubmitBtn = document.getElementById('transaction-submit-btn');
        let currentTxType = 'Deposit';

        const openTransactionModal = (type) => {
            currentTxType = type;
            transactionTitle.textContent = type === 'Deposit' ? 'Deposit Funds' : 'Withdraw Funds';
            transactionSubmitBtn.querySelector('.btn-text').textContent = type === 'Deposit' ? 'Add Deposit' : 'Add Withdrawal';
            transactionForm.reset();
            transactionModal.classList.remove('hidden');
        };
        const closeTransactionModal = () => {
            transactionModal.classList.add('hidden');
        };
        document.querySelectorAll('#transaction-modal .close-modal-btn').forEach(btn => btn.addEventListener('click', closeTransactionModal));
        fmDepositBtn?.addEventListener('click', () => openTransactionModal('Deposit'));
        fmWithdrawBtn?.addEventListener('click', () => openTransactionModal('Withdrawal'));
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('transaction-amount').value) || 0;
            const date = document.getElementById('transaction-date').value || new Date().toISOString().slice(0,10);
            const notes = document.getElementById('transaction-notes').value || '';
            const entry = { id: `${Date.now()}`, type: currentTxType, amount, date, notes };
            try {
                await dataStore.upsertLedger(entry);
                appState.ledger = await dataStore.getLedger();
                renderFundManagement();
                renderDashboard();
                closeTransactionModal();
            } catch (err) {
                console.error('Failed to save ledger entry', err);
            }
        });

        // --- FULL RENDER FUNCTIONS ---
        const renderDashboard = async () => {
            try {
                // Ensure we have latest data
                appState.trades = await dataStore.getTrades();
                appState.ledger = await dataStore.getLedger();
                
            const { trades, ledger } = appState;
            const closedTrades = trades.filter(t => t.exit_price && t.exit_date);
            let netPnl = 0, grossProfit = 0, grossLoss = 0, wins = 0, losses = 0;
                
            closedTrades.forEach(trade => {
                const pnl = calculateNetPnl(trade);
                netPnl += pnl;
                    if (pnl > 0) {
                        wins++;
                        grossProfit += pnl;
                    } else if (pnl < 0) {
                        losses++;
                        grossLoss += Math.abs(pnl);
                    }
                });
                
                const totalTrades = closedTrades.length;
                const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
                const profitFactor = grossLoss > 0 ? grossProfit / grossLoss : (grossProfit > 0 ? '∞' : 0);
                const avgWin = wins > 0 ? grossProfit / wins : 0;
                const avgLoss = losses > 0 ? grossLoss / losses : 0;
                const avgWinLossRatio = avgLoss > 0 ? avgWin / avgLoss : (avgWin > 0 ? '∞' : 0);
                
                // Update main metrics
                const netPnlEl = document.getElementById('db-net-pnl');
                if (netPnlEl) {
                    netPnlEl.textContent = formatCurrency(netPnl);
                    netPnlEl.className = `text-2xl font-bold mt-2 ${netPnl >= 0 ? 'text-green-500' : 'text-red-500'}`;
                }
                
                const totalTradesEl = document.getElementById('db-total-trades');
                if (totalTradesEl) totalTradesEl.textContent = `${totalTrades} trades`;
                
                const winRateEl = document.getElementById('db-win-rate');
                if (winRateEl) winRateEl.textContent = `${winRate.toFixed(1)}%`;
                
                const wonTradesEl = document.getElementById('db-won-trades');
                if (wonTradesEl) wonTradesEl.textContent = `${wins} won`;
                
                const lostTradesEl = document.getElementById('db-lost-trades');
                if (lostTradesEl) lostTradesEl.textContent = `${losses} lost`;
                
                const profitFactorEl = document.getElementById('db-profit-factor');
                if (profitFactorEl) profitFactorEl.textContent = typeof profitFactor === 'number' ? profitFactor.toFixed(2) : profitFactor;
                
                const avgWinLossEl = document.getElementById('db-avg-win-loss');
                if (avgWinLossEl) avgWinLossEl.textContent = typeof avgWinLossRatio === 'number' ? avgWinLossRatio.toFixed(2) : avgWinLossRatio;
                
                const avgWinEl = document.getElementById('db-avg-win');
                if (avgWinEl) avgWinEl.textContent = `+${formatCurrency(avgWin)}`;
                
                const avgLossEl = document.getElementById('db-avg-loss');
                if (avgLossEl) avgLossEl.textContent = `-${formatCurrency(avgLoss)}`;
                
                // Calculate account metrics
                const deposits = ledger.filter(l => l.type === 'Deposit').reduce((s, l) => s + (l.amount || 0), 0);
                const withdrawals = ledger.filter(l => l.type === 'Withdrawal').reduce((s, l) => s + (l.amount || 0), 0);
                const deployedCapital = trades.filter(t => !t.exit_date).reduce((s, t) => s + ((t.entry_price || 0) * (t.quantity || 0)), 0);
            const accountValue = deposits - withdrawals + netPnl;
            appState.accountValue = accountValue;
                const availableCash = Math.max(0, accountValue - deployedCapital);
                
                // Calculate open risk percentage and amount from active trades (same as Fund Management)
                const openRiskData = (() => {
                    const activeTrades = trades.filter(trade => !trade.exit_date || !trade.exit_price);
                    if (activeTrades.length === 0) return { percentage: 0, amount: 0 };
                    
                    const totalRiskAmount = activeTrades.reduce((total, trade) => {
                        // Risk is the potential loss if trade goes against us
                        // For Long: risk = entry_price * quantity (if price goes to 0)
                        // For Short: risk = (current_price - entry_price) * quantity (if price goes to infinity)
                        const tradeValue = trade.entry_price * trade.quantity;
                        return total + tradeValue;
                    }, 0);
                    
                    const totalAccountValue = accountValue > 0 ? accountValue : 1; // Avoid division by zero
                    const percentage = (totalRiskAmount / totalAccountValue) * 100;
                    
                    return { percentage, amount: totalRiskAmount };
                })();
                
                // Update account summary
            const summaryEl = document.getElementById('db-account-summary');
                if (summaryEl) {
            const txt = "text-2xl font-bold";
            summaryEl.innerHTML = `
                <div><p class="text-sm" style="color: var(--text-secondary);">NET ACCOUNT VALUE</p><p class="${txt} ${accountValue >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(accountValue)}</p></div>
                <div><p class="text-sm" style="color: var(--text-secondary);">NET REALIZED P&L</p><p class="${txt} ${netPnl >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(netPnl)}</p></div>
                <div><p class="text-sm" style="color: var(--text-secondary);">AVAILABLE CASH</p><p class="${txt}">${formatCurrency(availableCash)}</p></div>
                <div><p class="text-sm" style="color: var(--text-secondary);">DEPLOYED CAPITAL</p><p class="${txt}">${formatCurrency(deployedCapital)}</p></div>
                <div><p class="text-sm" style="color: var(--text-secondary);">TOTAL DEPOSITS</p><p class="${txt}">${formatCurrency(deposits)}</p></div>
                <div><p class="text-sm" style="color: var(--text-secondary);">TOTAL WITHDRAWN</p><p class="${txt}">${formatCurrency(withdrawals)}</p></div>
                <div><p class="text-sm" style="color: var(--text-secondary);">STARTING BALANCE</p><p class="${txt}">₹0.00</p></div>
                <div><p class="text-sm font-medium" style="color: var(--text-secondary);">TOTAL OPEN RISK <span class="text-xs">(${openRiskData.percentage.toFixed(1)}%)</span></p><p class="${txt}">${formatCurrency(openRiskData.amount)}</p></div>`;
                }
                
                // Render dependent components
            renderTopTrades();
            renderOpenPositionsOverview();
            renderAllCharts();
                wireCsvButtons();
                
            } catch (e) {
                console.error('renderDashboard error', e);
            }
        };
        // --- CSV EXPORTS ---
        const toCsv = (rows) => rows.map(r => r.map(v => {
            if (v == null) return '';
            const s = String(v).replace(/"/g, '""');
            return /[",\n]/.test(s) ? `"${s}"` : s;
        }).join(','))
        .join('\n');

        const downloadCsv = (filename, rows) => {
            const blob = new Blob([toCsv(rows)], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        };

        const wireCsvButtons = () => {
            const tradesBtn = document.getElementById('export-trades-csv');
            tradesBtn?.addEventListener('click', () => {
                const trades = JSON.parse(localStorage.getItem('trades') || '[]') || [];
                const header = ['ID','Symbol','Direction','Entry Date','Entry Price','Qty','Exit Date','Exit Price','Brokerage','Other Fees','Strategy','Outcome','Notes'];
                const rows = trades.map(t => [t.id, t.asset, t.direction, t.entry_date, t.entry_price, t.quantity, t.exit_date||'', t.exit_price||'', t.brokerage||0, t.other_fees||0, t.strategy||'', t.outcomeSummary||'', t.reasons||'']);
                downloadCsv('trades.csv', [header, ...rows]);
            });
            const ledgerBtn = document.getElementById('export-ledger-csv');
            ledgerBtn?.addEventListener('click', () => {
                const ledger = JSON.parse(localStorage.getItem('ledger') || '[]') || [];
                const header = ['ID','Date','Type','Amount','Notes'];
                const rows = ledger.map(l => [l.id, l.date, l.type, l.amount, l.notes||'']);
                downloadCsv('ledger.csv', [header, ...rows]);
            });
            const statementBtn = document.getElementById('export-statement-csv');
            statementBtn?.addEventListener('click', () => {
                const trades = JSON.parse(localStorage.getItem('trades') || '[]') || [];
                const ledger = JSON.parse(localStorage.getItem('ledger') || '[]') || [];
                const tradeRows = trades.map(t => {
                    const gross = (t.exit_price && t.exit_date) ? ((t.exit_price - t.entry_price) * (t.quantity||0)) : 0;
                    const charges = (t.brokerage||0)+(t.other_fees||0);
                    const net = gross - charges;
                    return [t.exit_date||t.entry_date||'', 'Trade', t.asset||'', t.strategy||'', gross, charges, net, '', t.outcomeSummary||''];
                });
                const ledgerRows = ledger.map(l => [l.date||'', l.type, l.type, '—', '', '', '', l.amount||0, l.notes||'']);
                const header = ['Date','Type','Symbol/Desc','Strategy','Gross P/L','Charges','Net P/L','Amount (₹)','Notes'];
                downloadCsv('statement.csv', [header, ...tradeRows, ...ledgerRows]);
            });
        };
        const renderTradeHistory = async () => {
            try {
                // Sync from localStorage
                appState.trades = await dataStore.getTrades();
                const tbody = document.getElementById('trade-history-tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                const rowsHtml = appState.trades.map(t => {
                    const isClosed = t.exit_date && t.exit_price && (!t.exit_quantity || t.exit_quantity >= t.quantity);
                    const isPartialExit = t.exit_date && t.exit_price && t.exit_quantity && t.exit_quantity < t.quantity;
                    const pnl = (isClosed || isPartialExit) ? calculateNetPnl(t) : 0;
                    let status = 'Open';
                    if (isClosed) status = 'Closed';
                    else if (isPartialExit) status = 'Partial Exit';
                    const type = t.direction || '—';
                    return `
                        <tr>
                            <td class="px-6 py-3">${t.asset || '—'}</td>
                            <td class="px-6 py-3 ${pnl >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(pnl)}</td>
                            <td class="px-6 py-3">
                                ${isPartialExit ? 
                                    `<span class="text-blue-600 underline cursor-pointer" data-action="view-partial" data-id="${t.id}">${status}</span>` : 
                                    status
                                }
                            </td>
                            <td class="px-6 py-3">${t.entry_price ?? '—'}</td>
                            <td class="px-6 py-3">${type}</td>
                            <td class="px-6 py-3">${t.entry_date || '—'}</td>
                            <td class="px-6 py-3">${t.stop_loss ?? '—'}</td>
                            <td class="px-6 py-3">${t.quantity ?? '—'}</td>
                            <td class="px-6 py-3">${t.exit_price ?? '—'}</td>
                            <td class="px-6 py-3">${t.exit_date || '—'}</td>
                            <td class="px-6 py-3 space-x-2">
                                <button class="text-blue-600 underline text-xs" data-action="edit" data-id="${t.id}">Edit</button>
                                ${!isClosed ? `<button class="text-green-600 underline text-xs" data-action="exit" data-id="${t.id}">Exit</button>` : ''}
                                <button class="text-red-600 underline text-xs" data-action="delete" data-id="${t.id}">Delete</button>
                            </td>
                        </tr>`;
                }).join('');
                tbody.innerHTML = rowsHtml;

                // Row actions
                tbody.querySelectorAll('button[data-action="edit"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        const trade = appState.trades.find(x => String(x.id) === String(id));
                        if (!trade) return;
                        // populate form
                        document.getElementById('trade-id').value = trade.id || '';
                        document.getElementById('asset-input').value = trade.asset || '';
                        // Split entry datetime into date and time
                        if (trade.entry_date) {
                            const entryDateTime = new Date(trade.entry_date);
                            document.getElementById('entry-date').value = entryDateTime.toISOString().split('T')[0];
                            document.getElementById('entry-time').value = entryDateTime.toTimeString().slice(0, 5);
                        } else {
                            document.getElementById('entry-date').value = '';
                            document.getElementById('entry-time').value = '';
                        }
                        document.getElementById('entry-price').value = trade.entry_price ?? '';
                        document.getElementById('quantity').value = trade.quantity ?? '';
                        document.getElementById('stop-loss').value = trade.stop_loss ?? '';
                        document.getElementById('target').value = trade.target ?? '';
                        // Split exit datetime into date and time
                        if (trade.exit_date) {
                            const exitDateTime = new Date(trade.exit_date);
                            document.getElementById('exit-date').value = exitDateTime.toISOString().split('T')[0];
                            document.getElementById('exit-time').value = exitDateTime.toTimeString().slice(0, 5);
                        } else {
                            document.getElementById('exit-date').value = '';
                            document.getElementById('exit-time').value = '';
                        }
                        document.getElementById('exit-price').value = trade.exit_price ?? '';
                        document.getElementById('exit-quantity').value = trade.exit_quantity ?? '';
                        document.getElementById('brokerage').value = trade.brokerage ?? '';
                        document.getElementById('other-fees').value = trade.other_fees ?? '';
                        document.getElementById('strategy').value = trade.strategy || 'Price Action';
                        document.getElementById('outcome-summary').value = trade.outcomeSummary || 'Select Outcome Summary';
                        document.getElementById('reasons').value = trade.reasons || '';
                        
                        // Populate Psychology fields
                        const emotionalStateSelect = document.getElementById('emotional-state');
                        if (emotionalStateSelect) {
                            emotionalStateSelect.value = trade.emotionalState || '';
                        }
                        
                        // Clear all mistake checkboxes first
                        document.querySelectorAll('input[name="mistakes"]').forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        
                        // Check the mistakes that were previously selected
                        if (trade.mistakes && Array.isArray(trade.mistakes)) {
                            trade.mistakes.forEach(mistake => {
                                const checkbox = document.querySelector(`input[name="mistakes"][value="${mistake}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                }
                            });
                        }
                        
                        updateCalculations();
                        navigateTo('add-trade');
                    });
                });
                tbody.querySelectorAll('button[data-action="delete"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        showConfirmationModal('Delete this trade?', async () => {
                            try {
                                await dataStore.deleteTrade(id);
                                appState.trades = await dataStore.getTrades();
                                renderTradeHistory();
                                renderDashboard();
                            } catch (err) { console.error('delete trade failed', err); }
                        }, 'Confirm Deletion', 'Delete');
                    });
                });
                tbody.querySelectorAll('button[data-action="exit"]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-id');
                        const trade = appState.trades.find(x => String(x.id) === String(id));
                        if (!trade) return;
                        showExitTradeModal(trade);
                    });
                });
                tbody.querySelectorAll('span[data-action="view-partial"]').forEach(span => {
                    span.addEventListener('click', () => {
                        const id = span.getAttribute('data-id');
                        const trade = appState.trades.find(x => String(x.id) === String(id));
                        if (!trade) return;
                        showPartialExitDetailsModal(trade);
                    });
                });
            } catch (e) {
                console.error('renderTradeHistory error', e);
            }
        };
        // Helper function to update metric cards
        const updateMetricCard = (elementId, value, colorClass) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = formatCurrency(value);
                if (colorClass === 'text-green-600') {
                    element.className = 'text-2xl font-bold text-green-600';
                } else if (colorClass === 'text-red-600') {
                    element.className = 'text-2xl font-bold text-red-600';
                } else {
                    element.className = 'text-2xl font-bold';
                    element.style.color = 'var(--text-primary)';
                }
            }
        };

        // Helper function to update risk percentage card
        const updateRiskCard = (percentageElementId, amountElementId, percentage, amount) => {
            const percentageElement = document.getElementById(percentageElementId);
            const amountElement = document.getElementById(amountElementId);
            
            if (percentageElement) {
                percentageElement.textContent = `(${percentage.toFixed(1)}%)`;
            }
            
            if (amountElement) {
                amountElement.textContent = formatCurrency(amount);
                amountElement.className = 'text-2xl font-bold';
                // Color coding based on risk level
                if (percentage <= 10) {
                    amountElement.style.color = '#10b981'; // Green for low risk
                } else if (percentage <= 25) {
                    amountElement.style.color = '#f59e0b'; // Amber for medium risk
                } else {
                    amountElement.style.color = '#ef4444'; // Red for high risk
                }
            }
        };

        const renderFundManagement = async () => {
            try {
                // Load ledger
                appState.ledger = await dataStore.getLedger();

                // Calculate all financial metrics
                const deposits = appState.ledger.filter(l => l.type === 'Deposit').reduce((s, l) => s + (l.amount || 0), 0);
                const withdrawals = appState.ledger.filter(l => l.type === 'Withdrawal').reduce((s, l) => s + (l.amount || 0), 0);
                
                // Calculate realized P&L from closed trades
                const realizedPnl = appState.trades
                    .filter(trade => trade.exit_date && trade.exit_price)
                    .reduce((total, trade) => {
                        const netPnl = calculateNetPnl(trade);
                        return total + netPnl;
                    }, 0);
                
                // Calculate open risk percentage and amount from active trades
                const openRiskData = (() => {
                    const activeTrades = appState.trades.filter(trade => !trade.exit_date || !trade.exit_price);
                    if (activeTrades.length === 0) return { percentage: 0, amount: 0 };
                    
                    const totalRiskAmount = activeTrades.reduce((total, trade) => {
                        // Risk is the potential loss if trade goes against us
                        // For Long: risk = entry_price * quantity (if price goes to 0)
                        // For Short: risk = (current_price - entry_price) * quantity (if price goes to infinity)
                        const tradeValue = trade.entry_price * trade.quantity;
                        return total + tradeValue;
                    }, 0);
                    
                    const totalAccountValue = netAccountValue > 0 ? netAccountValue : 1; // Avoid division by zero
                    const percentage = (totalRiskAmount / totalAccountValue) * 100;
                    
                    return { percentage, amount: totalRiskAmount };
                })();
                
                // Calculate deployed capital (money currently in active trades)
                const deployedCapital = appState.trades
                    .filter(trade => !trade.exit_date || !trade.exit_price)
                    .reduce((total, trade) => {
                        return total + (trade.entry_price * trade.quantity);
                    }, 0);
                
                // Calculate available cash
                const availableCash = deposits - withdrawals - deployedCapital;
                
                // Calculate net account value (we need this for risk calculation)
                const netAccountValue = deposits - withdrawals + realizedPnl;
                
                // Starting account balance (first deposit or 0)
                const startingBalance = appState.ledger.length > 0 ? 
                    appState.ledger.filter(l => l.type === 'Deposit')[0]?.amount || 0 : 0;

                // Update the metric cards
                updateMetricCard('net-account-value', netAccountValue, netAccountValue >= 0 ? 'text-green-600' : 'text-red-600');
                updateMetricCard('net-realized-pnl', realizedPnl, realizedPnl >= 0 ? 'text-green-600' : 'text-red-600');
                updateMetricCard('starting-account-balance', startingBalance, 'text-gray-900');
                updateMetricCard('total-deposits', deposits, 'text-gray-900');
                updateMetricCard('deployed-capital', deployedCapital, 'text-gray-900');
                updateMetricCard('available-cash', availableCash, availableCash >= 0 ? 'text-green-600' : 'text-red-600');
                updateMetricCard('total-withdrawn', withdrawals, 'text-gray-900');
                updateRiskCard('total-open-risk-percentage', 'total-open-risk-amount', openRiskData.percentage, openRiskData.amount);

                const tbody = document.getElementById('fund-ledger-body');
                if (tbody) {
                    tbody.innerHTML = appState.ledger.map(item => `
                        <tr>
                            <td class="px-6 py-3">${item.date || '—'}</td>
                            <td class="px-6 py-3">${item.type}</td>
                            <td class="px-6 py-3">${formatCurrency(item.amount || 0)}</td>
                            <td class="px-6 py-3">${item.notes || '—'}</td>
                            <td class="px-6 py-3 space-x-2">
                                <button class="text-blue-600 underline text-xs" data-ledger-action="edit" data-id="${item.id}">Edit</button>
                                <button class="text-red-600 underline text-xs" data-ledger-action="delete" data-id="${item.id}">Delete</button>
                            </td>
                        </tr>
                    `).join('');

                    // wire row actions
                    tbody.querySelectorAll('button[data-ledger-action="edit"]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = btn.getAttribute('data-id');
                            const entry = appState.ledger.find(x => String(x.id) === String(id));
                            if (!entry) return;
                            // open modal prefilled
                            currentTxType = entry.type;
                            document.getElementById('transaction-amount').value = entry.amount || 0;
                            document.getElementById('transaction-date').value = entry.date || '';
                            document.getElementById('transaction-notes').value = entry.notes || '';
                            transactionTitle.textContent = entry.type === 'Deposit' ? 'Deposit Funds' : 'Withdraw Funds';
                            transactionSubmitBtn.querySelector('.btn-text').textContent = entry.type === 'Deposit' ? 'Update Deposit' : 'Update Withdrawal';
                            transactionModal.classList.remove('hidden');
                            transactionForm.onsubmit = async (e) => {
                                e.preventDefault();
                                const amount = parseFloat(document.getElementById('transaction-amount').value) || 0;
                                const date = document.getElementById('transaction-date').value || new Date().toISOString().slice(0,10);
                                const notes = document.getElementById('transaction-notes').value || '';
                                try {
                                    await dataStore.upsertLedger({ ...entry, amount, date, notes });
                                    appState.ledger = await dataStore.getLedger();
                                    renderFundManagement();
                                    renderDashboard();
                                    transactionModal.classList.add('hidden');
                                    transactionForm.onsubmit = null; // revert to default
                                } catch (err) { console.error('update ledger failed', err); }
                            };
                        });
                    });
                    tbody.querySelectorAll('button[data-ledger-action="delete"]').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const id = btn.getAttribute('data-id');
                            showConfirmationModal('Delete this ledger entry?', () => {
                                try {
                                    dataStore.deleteLedger(id);
                                    dataStore.getLedger().then(ledger => { appState.ledger = ledger; renderFundManagement(); renderDashboard(); });
                                } catch (err) { console.error('delete ledger failed', err); }
                            }, 'Confirm Deletion', 'Delete');
                        });
                    });
                }
            } catch (e) {
                console.error('renderFundManagement error', e);
            }
        };
        const renderCalendar = () => {
            try {
                const monthYearEl = document.getElementById('calendar-month-year');
                const daysContainer = document.getElementById('calendar-grid-days');
                const weeklySummaries = document.getElementById('calendar-grid-summaries');
                const monthlyPnlDisplay = document.getElementById('monthly-pnl-display');
                const statsGrid = document.getElementById('calendar-stats-grid');
                if (!monthYearEl || !daysContainer || !weeklySummaries) return;

                const baseDate = appState.calendarDate instanceof Date ? new Date(appState.calendarDate) : new Date();
                const year = baseDate.getFullYear();
                const month = baseDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const firstWeekday = firstDay.getDay(); // 0 Sun - 6 Sat
                const daysInMonth = lastDay.getDate();

                monthYearEl.textContent = firstDay.toLocaleString('default', { month: 'long', year: 'numeric' });

                const trades = JSON.parse(localStorage.getItem('trades') || '[]') || [];
                const pnlByDate = {};
                const tradesCountByDate = {};
                const fmtCompact = (num) => {
                    const abs = Math.abs(num);
                    if (abs >= 1_000_000) return `${(num/1_000_000).toFixed(1)}M`;
                    if (abs >= 1_000) return `${(num/1_000).toFixed(1)}K`;
                    return `${Math.round(num)}`;
                };
                trades.forEach(t => {
                    if (!(t.exit_date && t.exit_price)) return;
                    const d = (new Date(t.exit_date)).toISOString().slice(0,10);
                    const pnl = ((t.exit_price - t.entry_price) * (t.quantity || 0)) - ((t.brokerage||0)+(t.other_fees||0));
                    pnlByDate[d] = (pnlByDate[d] || 0) + pnl;
                    tradesCountByDate[d] = (tradesCountByDate[d] || 0) + 1;
                });

                // Calculate KPI metrics for the current month
                const currentMonthTrades = trades.filter(t => {
                    if (!(t.exit_date && t.exit_price)) return false;
                    const tradeDate = new Date(t.exit_date);
                    return tradeDate.getFullYear() === year && tradeDate.getMonth() === month;
                });

                let totalPnl = 0, totalTrades = 0, wins = 0, losses = 0, totalRisk = 0, totalReward = 0;
                currentMonthTrades.forEach(trade => {
                    const pnl = calculateNetPnl(trade);
                    totalPnl += pnl;
                    totalTrades++;
                    
                    if (pnl > 0) wins++;
                    else if (pnl < 0) losses++;
                    
                    // Calculate Risk:Reward ratio
                    const entryPrice = trade.entry_price || 0;
                    const exitPrice = trade.exit_price || 0;
                    const stopLoss = trade.stop_loss || (entryPrice * 0.98); // Default 2% stop loss
                    const target = trade.target || (entryPrice * 1.02); // Default 2% target
                    
                    const risk = Math.abs(entryPrice - stopLoss);
                    const reward = Math.abs(target - entryPrice);
                    
                    if (risk > 0) totalRisk += risk;
                    if (reward > 0) totalReward += reward;
                });

                const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
                const avgRR = totalRisk > 0 ? (totalReward / totalRisk) : 0;

                // Render KPI metrics
                if (statsGrid) {
                    statsGrid.innerHTML = `
                        <div class="p-4 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium" style="color: var(--text-secondary);">TOTAL P&L</p>
                                    <p class="text-2xl font-bold ${totalPnl >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(totalPnl)}</p>
                                </div>
                                <div class="p-3 rounded-full ${totalPnl >= 0 ? 'bg-green-100' : 'bg-red-100'}">
                                    <i data-feather="${totalPnl >= 0 ? 'trending-up' : 'trending-down'}" class="h-6 w-6 ${totalPnl >= 0 ? 'text-green-600' : 'text-red-600'}"></i>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium" style="color: var(--text-secondary);">WIN RATE</p>
                                    <p class="text-2xl font-bold ${winRate >= 50 ? 'text-green-500' : 'text-red-500'}">${winRate.toFixed(1)}%</p>
                                </div>
                                <div class="p-3 rounded-full ${winRate >= 50 ? 'bg-green-100' : 'bg-red-100'}">
                                    <i data-feather="target" class="h-6 w-6 ${winRate >= 50 ? 'text-green-600' : 'text-red-600'}"></i>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium" style="color: var(--text-secondary);">TOTAL TRADES</p>
                                    <p class="text-2xl font-bold" style="color: var(--text-primary);">${totalTrades}</p>
                                </div>
                                <div class="p-3 rounded-full" style="background-color: var(--bg-secondary);">
                                    <i data-feather="activity" class="h-6 w-6" style="color: var(--text-secondary);"></i>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 rounded-lg shadow-sm" style="background-color: var(--bg-primary); border: 1px solid var(--border-color);">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium" style="color: var(--text-secondary);">AVG. R:R</p>
                                    <p class="text-2xl font-bold ${avgRR >= 1 ? 'text-green-500' : 'text-red-500'}">1:${avgRR.toFixed(1)}</p>
                                </div>
                                <div class="p-3 rounded-full ${avgRR >= 1 ? 'bg-green-100' : 'bg-red-100'}">
                                    <i data-feather="bar-chart-2" class="h-6 w-6 ${avgRR >= 1 ? 'text-green-600' : 'text-red-600'}"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }

                const startPad = firstWeekday; // number of empty cells before day 1
                const totalCells = startPad + daysInMonth;
                const weeks = Math.ceil(totalCells / 7);

                daysContainer.innerHTML = '';
                weeklySummaries.innerHTML = '';

                let dayCounter = 1;
                let monthlyPnl = 0;
                for (let w = 0; w < weeks; w++) {
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-7 gap-2 mb-2';
                    for (let d = 0; d < 7; d++) {
                        const cellIndex = w * 7 + d;
                        const cell = document.createElement('div');
                        cell.className = 'rounded-md p-2 text-sm h-24 flex flex-col justify-between border';
                        cell.style.backgroundColor = 'var(--bg-primary)';
                        cell.style.borderColor = 'var(--border-color)';

                        if (cellIndex >= startPad && dayCounter <= daysInMonth) {
                            const dateObj = new Date(year, month, dayCounter);
                            const iso = dateObj.toISOString().slice(0,10);
                            const pnl = pnlByDate[iso] || 0;
                            const tCount = tradesCountByDate[iso] || 0;
                            monthlyPnl += pnl;
                            const isUp = pnl > 0; const isDown = pnl < 0;
                            const borderColor = isUp ? '#c7f0d5' : isDown ? '#f5c7c7' : 'var(--border-color)';
                            const pillBg = isUp ? 'rgba(34,197,94,0.08)' : isDown ? 'rgba(239,68,68,0.08)' : 'transparent';
                            const amountColor = isUp ? 'text-green-600' : isDown ? 'text-red-600' : 'text-gray-500';
                            cell.style.borderColor = borderColor;
                            cell.style.backgroundColor = pillBg || cell.style.backgroundColor;
                            
                            // Add hover and click functionality
                            cell.className += ' calendar-date-cell';
                            if (tCount > 0) {
                                cell.className += ' has-trades';
                            }
                            cell.setAttribute('data-date', iso);
                            cell.setAttribute('data-pnl', pnl);
                            cell.setAttribute('data-trades', tCount);
                            
                            // Add click functionality
                            cell.addEventListener('click', () => {
                                if (tCount > 0) {
                                    showTradeDetailsModal(iso, dateObj);
                                }
                            });
                            
                            const amount = pnl ? formatCurrency(pnl) : '';
                            const countLine = tCount ? `<div class="text-[11px] mt-1" style="color: var(--text-secondary);">${tCount} ${tCount===1?'trade':'trades'}</div>` : '';
                            cell.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <span class="text-xs" style="color: var(--text-secondary);">${String(dayCounter).padStart(2,'0')}</span>
                                    <i data-feather="calendar" class="h-3.5 w-3.5" style="color: var(--text-muted);"></i>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs font-semibold ${amountColor}">${amount}</div>
                                    ${countLine}
                                </div>
                            `;
                            dayCounter++;
                        } else {
                            cell.innerHTML = `&nbsp;`;
                            cell.style.opacity = '0.4';
                        }
                        row.appendChild(cell);
                    }
                    daysContainer.appendChild(row);

                    // Weekly summary for this row
                    const startDateOfRow = new Date(year, month, Math.max(1, (w*7 - startPad + 1)));
                    const endDateOfRow = new Date(year, month, Math.min(daysInMonth, (w+1)*7 - startPad));
                    let weekPnl = 0; let activeDays = 0;
                    for (let cd = new Date(startDateOfRow); cd <= endDateOfRow; cd.setDate(cd.getDate()+1)) {
                        const iso = cd.toISOString().slice(0,10);
                        if (iso.slice(0,7) === `${year}-${String(month+1).padStart(2,'0')}`) {
                            const v = pnlByDate[iso] || 0;
                            weekPnl += v;
                            if (tradesCountByDate[iso]) activeDays++;
                        }
                    }
                    // Create a row wrapper just like the calendar rows
                    const summaryRow = document.createElement('div');
                    summaryRow.className = 'mb-2';
                    summaryRow.style.marginTop = '0.25rem'; // 4px to push down more
                    
                    const weekBox = document.createElement('div');
                    weekBox.className = 'rounded-md p-2 text-sm text-center border h-24 flex flex-col justify-between';
                    weekBox.style.backgroundColor = 'var(--bg-primary)';
                    weekBox.style.borderColor = 'var(--border-color)';
                    const label = `Week ${w+1}`;
                    const amt = weekPnl ? formatCurrency(weekPnl) : '—';
                    const amtColor = weekPnl>=0 ? 'text-green-600' : 'text-red-600';
                    weekBox.innerHTML = `
                        <div class="text-xs" style="color: var(--text-secondary);">${label}</div>
                        <div class="text-lg font-semibold ${weekPnl===0?'text-gray-500':amtColor}">${amt}</div>
                        <div class="mt-1 inline-block text-[11px] px-2 py-[2px] rounded-full" style="background-color: var(--bg-secondary); color: var(--text-secondary);">${activeDays || 0} ${activeDays===1?'day':'days'}</div>
                    `;
                    
                    summaryRow.appendChild(weekBox);
                    weeklySummaries.appendChild(summaryRow);
                }

                if (monthlyPnlDisplay) {
                    monthlyPnlDisplay.textContent = `Monthly P&L: ${formatCurrency(monthlyPnl)}`;
                    // Set color based on profit/loss
                    if (monthlyPnl > 0) {
                        monthlyPnlDisplay.style.color = '#10b981'; // green-500
                    } else if (monthlyPnl < 0) {
                        monthlyPnlDisplay.style.color = '#ef4444'; // red-500
                    } else {
                        monthlyPnlDisplay.style.color = 'var(--text-primary)'; // default color
                    }
                }
                const prevBtn = document.getElementById('prev-month-btn');
                const nextBtn = document.getElementById('next-month-btn');
                
                // Remove existing event listeners to prevent duplicates
                if (prevBtn) {
                    prevBtn.replaceWith(prevBtn.cloneNode(true));
                }
                if (nextBtn) {
                    nextBtn.replaceWith(nextBtn.cloneNode(true));
                }
                
                // Get fresh references after cloning
                const newPrevBtn = document.getElementById('prev-month-btn');
                const newNextBtn = document.getElementById('next-month-btn');
                
                newPrevBtn?.addEventListener('click', () => {
                    appState.calendarDate = new Date(year, month - 1, 1);
                    renderCalendar();
                });
                newNextBtn?.addEventListener('click', () => {
                    appState.calendarDate = new Date(year, month + 1, 1);
                    renderCalendar();
                });
                
                // Replace feather icons for both calendar and KPI metrics
                feather.replace();
                
            } catch (e) {
                console.error('renderCalendar error', e);
            }
        };


        // Function to show trade details modal for a specific date
        const showTradeDetailsModal = (dateISO, dateObj) => {
            try {
                const modal = document.getElementById('trade-details-modal');
                const modalDate = document.getElementById('modal-date');
                const modalTotalPnl = document.getElementById('modal-total-pnl');
                const modalAvgRR = document.getElementById('modal-avg-rr');
                const modalTotalTrades = document.getElementById('modal-total-trades');
                const modalWinRate = document.getElementById('modal-win-rate');
                const modalTradesTbody = document.getElementById('modal-trades-tbody');
                
                if (!modal) return;

                // Get trades for the specific date
                const trades = JSON.parse(localStorage.getItem('trades') || '[]') || [];
                const dayTrades = trades.filter(t => {
                    if (!(t.exit_date && t.exit_price)) return false;
                    const tradeDate = new Date(t.exit_date).toISOString().slice(0, 10);
                    return tradeDate === dateISO;
                });

                // Calculate metrics for the day
                let totalPnl = 0, totalTrades = 0, wins = 0, totalRisk = 0, totalReward = 0;
                
                dayTrades.forEach(trade => {
                    const pnl = calculateNetPnl(trade);
                    totalPnl += pnl;
                    totalTrades++;
                    
                    if (pnl > 0) wins++;
                    
                    // Calculate Risk:Reward ratio
                    const entryPrice = trade.entry_price || 0;
                    const stopLoss = trade.stop_loss || (entryPrice * 0.98);
                    const target = trade.target || (entryPrice * 1.02);
                    
                    const risk = Math.abs(entryPrice - stopLoss);
                    const reward = Math.abs(target - entryPrice);
                    
                    if (risk > 0) totalRisk += risk;
                    if (reward > 0) totalReward += reward;
                });

                const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
                const avgRR = totalRisk > 0 ? (totalReward / totalRisk) : 0;

                // Update modal content
                modalDate.textContent = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                modalTotalPnl.textContent = formatCurrency(totalPnl);
                modalTotalPnl.style.color = totalPnl >= 0 ? '#22c55e' : '#ef4444';
                
                modalAvgRR.textContent = `1:${avgRR.toFixed(1)}`;
                modalAvgRR.style.color = avgRR >= 1 ? '#22c55e' : '#ef4444';
                
                modalTotalTrades.textContent = totalTrades.toString();
                
                modalWinRate.textContent = `${winRate.toFixed(1)}%`;
                modalWinRate.style.color = winRate >= 50 ? '#22c55e' : '#ef4444';

                // Update trades table
                if (modalTradesTbody) {
                    modalTradesTbody.innerHTML = dayTrades.map(trade => {
                        const pnl = calculateNetPnl(trade);
                        const isLong = trade.direction === 'Long';
                        const sideColor = isLong ? '#22c55e' : '#f59e0b';
                        const pnlColor = pnl >= 0 ? '#22c55e' : '#ef4444';
                        
                        return `
                            <tr>
                                <td class="px-4 py-2 font-medium">${trade.asset || 'N/A'}</td>
                                <td class="px-4 py-2">
                                    <span style="color: ${sideColor}; font-weight: 500;">${trade.direction || 'N/A'}</span>
                                </td>
                                <td class="px-4 py-2">${trade.quantity || 0}</td>
                                <td class="px-4 py-2">₹${(trade.entry_price || 0).toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 2})}</td>
                                <td class="px-4 py-2">₹${(trade.exit_price || 0).toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 2})}</td>
                                <td class="px-4 py-2" style="color: ${pnlColor}; font-weight: 500;">
                                    ${pnl >= 0 ? '+' : ''}₹${Math.abs(pnl).toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                // Show modal
                modal.style.display = 'flex';
                
                // Add close functionality
                const closeBtn = modal.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.onclick = () => {
                        modal.style.display = 'none';
                    };
                }
                
                // Close on outside click
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                };
                
                // Replace feather icons
                feather.replace();
                
            } catch (e) {
                console.error('showTradeDetailsModal error', e);
            }
        };
        const renderReports = () => {
            try {
                // Render original Performance Metrics
                const container = document.getElementById('reports-metrics-grid');
                if (!container) return;
                const trades = JSON.parse(localStorage.getItem('trades') || '[]') || [];
                const closed = trades.filter(t => t.exit_price && t.exit_date);
                const wins = closed.filter(t => ((t.exit_price - t.entry_price) * (t.quantity || 0)) > 0);
                const losses = closed.filter(t => ((t.exit_price - t.entry_price) * (t.quantity || 0)) < 0);
                const winRate = closed.length ? (wins.length / closed.length) * 100 : 0;
                const grossProfit = wins.reduce((s, t) => s + ((t.exit_price - t.entry_price) * (t.quantity || 0)), 0);
                const grossLoss = Math.abs(losses.reduce((s, t) => s + ((t.exit_price - t.entry_price) * (t.quantity || 0)), 0));
                const profitFactor = grossLoss ? (grossProfit / grossLoss) : 0;
                // Day aggregates
                const byDay = {};
                closed.forEach(t => {
                    const d = (new Date(t.exit_date)).toISOString().slice(0,10);
                    const pnl = (t.exit_price - t.entry_price) * (t.quantity || 0) - ((t.brokerage||0)+(t.other_fees||0));
                    byDay[d] = (byDay[d] || 0) + pnl;
                });
                const days = Object.entries(byDay);
                const bestDay = days.length ? days.reduce((a,b)=> a[1] >= b[1] ? a : b) : null;
                const worstDay = days.length ? days.reduce((a,b)=> a[1] <= b[1] ? a : b) : null;
                // Strategy breakdown
                const byStrategy = {};
                closed.forEach(t => {
                    const key = t.strategy || 'Other';
                    const pnl = (t.exit_price - t.entry_price) * (t.quantity || 0) - ((t.brokerage||0)+(t.other_fees||0));
                    byStrategy[key] = (byStrategy[key] || 0) + pnl;
                });
                const topStrategies = Object.entries(byStrategy).sort((a,b)=> b[1]-a[1]).slice(0,3);

                const metric = (label, value, accent='') => `
                    <div class="flex items-center justify-between p-4 rounded-md" style="background-color: var(--bg-secondary);">
                        <span class="text-sm" style="color: var(--text-secondary);">${label}</span>
                        <span class="font-semibold ${accent}">${value}</span>
                    </div>`;

                container.innerHTML = [
                    metric('Win Rate', `${winRate.toFixed(1)}%`),
                    metric('Profit Factor', profitFactor.toFixed(2)),
                    metric('Closed Trades', closed.length),
                    metric('Gross Profit', `${formatCurrency(grossProfit)}`, 'text-green-500'),
                    metric('Gross Loss', `${formatCurrency(-grossLoss)}`, 'text-red-500'),
                    metric('Best Day', bestDay ? `${bestDay[0]} • ${formatCurrency(bestDay[1])}` : '—', 'text-green-500'),
                    metric('Worst Day', worstDay ? `${worstDay[0]} • ${formatCurrency(worstDay[1])}` : '—', 'text-red-500'),
                    `<div class="p-4 rounded-md" style="background-color: var(--bg-secondary);">
                        <div class="text-sm mb-2" style="color: var(--text-secondary);">Top Strategies</div>
                        <div class="space-y-2">
                            ${topStrategies.map(([k,v]) => `<div class="flex justify-between"><span>${k}</span><span class="font-semibold ${v>=0?'text-green-500':'text-red-500'}">${formatCurrency(v)}</span></div>`).join('') || '<span>—</span>'}
                        </div>
                    </div>`
                ].join('');

                // Render Advanced Trading Metrics
                renderAdvancedMetrics(trades, closed, wins, losses, byDay, byStrategy);
            } catch (e) {
                console.error('renderReports error', e);
            }
        };

        const renderAdvancedMetrics = (trades, closed, wins, losses, byDay, byStrategy) => {
            try {
                // Helper function to create metric row
                const createMetricRow = (label, value, color = '') => `
                    <div class="flex justify-between items-center">
                        <span class="text-sm" style="color: var(--text-secondary);">${label}</span>
                        <span class="text-sm font-semibold ${color}">${value}</span>
                    </div>`;

                // 1. Trade Performance Card
                const breakEven = closed.filter(t => ((t.exit_price - t.entry_price) * (t.quantity || 0)) === 0).length;
                const avgWin = wins.length ? wins.reduce((s, t) => s + ((t.exit_price - t.entry_price) * (t.quantity || 0)), 0) / wins.length : 0;
                const avgLoss = losses.length ? Math.abs(losses.reduce((s, t) => s + ((t.exit_price - t.entry_price) * (t.quantity || 0)), 0)) / losses.length : 0;
                const expectancy = closed.length ? (wins.length * avgWin - losses.length * avgLoss) / closed.length : 0;
                
                document.getElementById('trade-performance-metrics').innerHTML = `
                    <div class="text-left mb-2">
                        <div class="text-2xl font-bold mb-1">
                            <span class="text-green-500">${wins.length}</span> / 
                            <span class="text-red-500">${losses.length}</span> / 
                            <span style="color: var(--text-primary);">${breakEven}</span>
                        </div>
                        <div class="text-sm" style="color: var(--text-muted);">Win / Loss / Break Even</div>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <div class="p-1.5 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <div class="text-xs mb-0.5" style="color: var(--text-secondary);">Avg Win</div>
                            <div class="text-sm font-semibold text-green-500">${formatCurrency(avgWin)}</div>
                        </div>
                        <div class="p-1.5 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <div class="text-xs mb-0.5" style="color: var(--text-secondary);">Avg Loss</div>
                            <div class="text-sm font-semibold text-red-500">${formatCurrency(-avgLoss)}</div>
                        </div>
                        <div class="p-1.5 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <div class="text-xs mb-0.5" style="color: var(--text-secondary);">Win Rate</div>
                            <div class="text-sm font-semibold" style="color: var(--text-primary);">${((wins.length / closed.length) * 100).toFixed(1)}%</div>
                        </div>
                        <div class="p-1.5 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <div class="text-xs mb-0.5" style="color: var(--text-secondary);">Expectancy</div>
                            <div class="text-sm font-semibold" style="color: var(--text-primary);">${formatCurrency(expectancy)}</div>
                        </div>
                    </div>
                `;

                // 2. Daily Performance Card
                const winDays = Object.entries(byDay).filter(([_, pnl]) => pnl > 0).length;
                const lossDays = Object.entries(byDay).filter(([_, pnl]) => pnl < 0).length;
                const breakEvenDays = Object.entries(byDay).filter(([_, pnl]) => pnl === 0).length;
                const bestDayPnl = Math.max(...Object.values(byDay), 0);
                const worstDayPnl = Math.min(...Object.values(byDay), 0);
                const avgWinDay = winDays ? Object.values(byDay).filter(pnl => pnl > 0).reduce((a, b) => a + b, 0) / winDays : 0;
                const avgLossDay = lossDays ? Math.abs(Object.values(byDay).filter(pnl => pnl < 0).reduce((a, b) => a + b, 0)) / lossDays : 0;

                document.getElementById('daily-performance-metrics').innerHTML = `
                    <div class="text-left mb-2">
                        <div class="text-2xl font-bold mb-1">
                            <span class="text-green-500">${winDays}</span> / 
                            <span class="text-red-500">${lossDays}</span> / 
                            <span style="color: var(--text-primary);">${breakEvenDays}</span>
                        </div>
                        <div class="text-sm" style="color: var(--text-muted);">Win / Loss / Break Even Days</div>
                    </div>
                    <div class="grid grid-cols-2 gap-1.5">
                        <div class="p-1.5 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <div class="text-xs mb-0.5" style="color: var(--text-secondary);">Best Day</div>
                            <div class="text-sm font-semibold text-green-500">${formatCurrency(bestDayPnl)}</div>
                        </div>
                        <div class="p-1.5 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <div class="text-xs mb-0.5" style="color: var(--text-secondary);">Worst Day</div>
                            <div class="text-sm font-semibold text-red-500">${formatCurrency(worstDayPnl)}</div>
                        </div>
                        <div class="p-1.5 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <div class="text-xs mb-0.5" style="color: var(--text-secondary);">Avg Win Day</div>
                            <div class="text-sm font-semibold text-green-500">${formatCurrency(avgWinDay)}</div>
                        </div>
                        <div class="p-1.5 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <div class="text-xs mb-0.5" style="color: var(--text-secondary);">Avg Loss Day</div>
                            <div class="text-sm font-semibold text-red-500">${formatCurrency(-avgLossDay)}</div>
                        </div>
                    </div>
                `;

                // 3. Trade Execution Card
                const totalCapital = closed.reduce((s, t) => s + (t.entry_price * (t.quantity || 0)), 0);
                const avgCapital = closed.length ? totalCapital / closed.length : 0;
                const mostProfitableStrategy = Object.entries(byStrategy).sort((a, b) => b[1] - a[1])[0];
                
                // Calculate consecutive wins/losses
                let consecutiveWins = 0, consecutiveLosses = 0, maxConsecutiveWins = 0, maxConsecutiveLosses = 0;
                let currentWins = 0, currentLosses = 0;
                
                closed.sort((a, b) => new Date(a.exit_date) - new Date(b.exit_date)).forEach(t => {
                    const pnl = (t.exit_price - t.entry_price) * (t.quantity || 0);
                    if (pnl > 0) {
                        currentWins++;
                        currentLosses = 0;
                        maxConsecutiveWins = Math.max(maxConsecutiveWins, currentWins);
                    } else if (pnl < 0) {
                        currentLosses++;
                        currentWins = 0;
                        maxConsecutiveLosses = Math.max(maxConsecutiveLosses, currentLosses);
                    }
                });

                // Calculate average time in trade
                let totalTimeInTrade = 0;
                let validTrades = 0;
                closed.forEach(t => {
                    if (t.entry_date && t.exit_date) {
                        const entryTime = new Date(t.entry_date);
                        const exitTime = new Date(t.exit_date);
                        const timeDiff = exitTime - entryTime; // in milliseconds
                        const minutesDiff = timeDiff / (1000 * 60); // convert to minutes
                        totalTimeInTrade += minutesDiff;
                        validTrades++;
                    }
                });
                const avgTimeInTrade = validTrades > 0 ? totalTimeInTrade / validTrades : 0;

                document.getElementById('trade-execution-metrics').innerHTML = `
                    ${createMetricRow('Total Trades', closed.length)}
                    ${createMetricRow('Avg Capital Used', formatCurrency(avgCapital))}
                    ${createMetricRow('Most Profitable Strategy', mostProfitableStrategy ? mostProfitableStrategy[0] : '—')}
                    ${createMetricRow('Consecutive Wins', maxConsecutiveWins, 'text-green-500')}
                    ${createMetricRow('Consecutive Losses', maxConsecutiveLosses, 'text-red-500')}
                    ${createMetricRow('Avg. Time in Trade', avgTimeInTrade > 0 ? `${avgTimeInTrade.toFixed(1)} mins` : '—')}
                `;

                // 4. Time Metrics Card
                const tradingDays = Object.keys(byDay).length;
                const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                const byWeekday = {};
                Object.entries(byDay).forEach(([date, pnl]) => {
                    const dayName = weekdays[new Date(date).getDay()];
                    byWeekday[dayName] = (byWeekday[dayName] || 0) + pnl;
                });
                const mostProfitableDay = Object.entries(byWeekday).sort((a, b) => b[1] - a[1])[0];
                const leastProfitableDay = Object.entries(byWeekday).sort((a, b) => a[1] - b[1])[0];

                // Calculate consecutive win/loss days
                let consecutiveWinDays = 0, consecutiveLossDays = 0, maxConsecutiveWinDays = 0, maxConsecutiveLossDays = 0;
                let currentWinDays = 0, currentLossDays = 0;
                
                Object.entries(byDay).sort((a, b) => new Date(a[0]) - new Date(b[0])).forEach(([_, pnl]) => {
                    if (pnl > 0) {
                        currentWinDays++;
                        currentLossDays = 0;
                        maxConsecutiveWinDays = Math.max(maxConsecutiveWinDays, currentWinDays);
                    } else if (pnl < 0) {
                        currentLossDays++;
                        currentWinDays = 0;
                        maxConsecutiveLossDays = Math.max(maxConsecutiveLossDays, currentLossDays);
                    }
                });

                document.getElementById('time-metrics').innerHTML = `
                    ${createMetricRow('Trading Days', tradingDays)}
                    ${createMetricRow('Consecutive Win Days', maxConsecutiveWinDays, 'text-green-500')}
                    ${createMetricRow('Consecutive Loss Days', maxConsecutiveLossDays, 'text-red-500')}
                    ${createMetricRow('Most Profitable Day', mostProfitableDay ? mostProfitableDay[0] : '—', 'text-green-500')}
                    ${createMetricRow('Least Profitable Day', leastProfitableDay ? leastProfitableDay[0] : '—', 'text-red-500')}
                `;

                // 5. Setup Effectiveness Card
                const setupStats = {};
                closed.forEach(t => {
                    const setup = t.setup || 'Other';
                    if (!setupStats[setup]) {
                        setupStats[setup] = { total: 0, wins: 0 };
                    }
                    setupStats[setup].total++;
                    const pnl = (t.exit_price - t.entry_price) * (t.quantity || 0);
                    if (pnl > 0) setupStats[setup].wins++;
                });

                // Define the setup types as shown in the image
                const setupTypes = ['Reversal', 'Breakout', 'Trend', 'Pullback', 'News-based'];
                
                // Calculate win rates for each setup type
                const setupEffectiveness = setupTypes.map(setupType => {
                    const stats = setupStats[setupType] || { total: 0, wins: 0 };
                    const winRate = stats.total > 0 ? (stats.wins / stats.total) * 100 : 0;
                    return {
                        setup: setupType,
                        winRate: winRate,
                        total: stats.total
                    };
                });

                document.getElementById('setup-effectiveness-metrics').innerHTML = setupEffectiveness
                    .map(({ setup, winRate }) => createMetricRow(setup, `${winRate.toFixed(1)}% win rate`, winRate >= 50 ? 'text-green-500' : 'text-red-500'))
                    .join('') || '<div class="text-sm" style="color: var(--text-muted);">No setup data available</div>';

                // 6. Symbol Frequency Card
                const symbolStats = {};
                closed.forEach(t => {
                    const symbol = t.asset || 'Unknown';
                    if (!symbolStats[symbol]) {
                        symbolStats[symbol] = { total: 0, wins: 0, pnl: 0 };
                    }
                    symbolStats[symbol].total++;
                    const pnl = (t.exit_price - t.entry_price) * (t.quantity || 0);
                    symbolStats[symbol].pnl += pnl;
                    if (pnl > 0) symbolStats[symbol].wins++;
                });

                const symbolFrequency = Object.entries(symbolStats)
                    .map(([symbol, stats]) => ({
                        symbol,
                        percentage: (stats.total / closed.length) * 100,
                        pnl: stats.pnl,
                        winRate: (stats.wins / stats.total) * 100
                    }))
                    .sort((a, b) => b.percentage - a.percentage);

                const mostTraded = symbolFrequency[0];
                const mostProfitable = symbolFrequency.sort((a, b) => b.pnl - a.pnl)[0];
                const leastProfitable = symbolFrequency.sort((a, b) => a.pnl - b.pnl)[0];
                const highestWinRate = symbolFrequency.sort((a, b) => b.winRate - a.winRate)[0];
                const lowestWinRate = symbolFrequency.sort((a, b) => a.winRate - b.winRate)[0];

                document.getElementById('symbol-frequency-metrics').innerHTML = `
                    ${createMetricRow('Most Traded', mostTraded ? `${mostTraded.symbol} (${mostTraded.percentage.toFixed(0)}%)` : '—')}
                    ${createMetricRow('Most Profitable', mostProfitable ? `${mostProfitable.symbol} (${formatCurrency(mostProfitable.pnl)})` : '—', 'text-green-500')}
                    ${createMetricRow('Least Profitable', leastProfitable ? `${leastProfitable.symbol} (${formatCurrency(leastProfitable.pnl)})` : '—', 'text-red-500')}
                    ${createMetricRow('Highest Win Rate', highestWinRate ? `${highestWinRate.symbol} (${highestWinRate.winRate.toFixed(1)}%)` : '—', 'text-green-500')}
                    ${createMetricRow('Lowest Win Rate', lowestWinRate ? `${lowestWinRate.symbol} (${lowestWinRate.winRate.toFixed(1)}%)` : '—', 'text-red-500')}
                `;

                // 7. Capital Usage Card
                const capitalUsed = closed.map(t => t.entry_price * (t.quantity || 0));
                const maxCapital = Math.max(...capitalUsed, 0);
                const minCapital = Math.min(...capitalUsed, 0);
                const avgCapitalUsed = capitalUsed.length ? capitalUsed.reduce((a, b) => a + b, 0) / capitalUsed.length : 0;
                
                // Find P&L at max and min capital
                const maxCapitalTrade = closed.find(t => (t.entry_price * (t.quantity || 0)) === maxCapital);
                const minCapitalTrade = closed.find(t => (t.entry_price * (t.quantity || 0)) === minCapital);
                const pnlAtMaxCapital = maxCapitalTrade ? (maxCapitalTrade.exit_price - maxCapitalTrade.entry_price) * (maxCapitalTrade.quantity || 0) : 0;
                const pnlAtMinCapital = minCapitalTrade ? (minCapitalTrade.exit_price - minCapitalTrade.entry_price) * (minCapitalTrade.quantity || 0) : 0;

                document.getElementById('capital-usage-metrics').innerHTML = `
                    ${createMetricRow('Maximum', formatCurrency(maxCapital))}
                    ${createMetricRow('Minimum', formatCurrency(minCapital))}
                    ${createMetricRow('Average', formatCurrency(avgCapitalUsed))}
                    ${createMetricRow('P&L at Max Capital', formatCurrency(pnlAtMaxCapital), pnlAtMaxCapital >= 0 ? 'text-green-500' : 'text-red-500')}
                    ${createMetricRow('P&L at Min Capital', formatCurrency(pnlAtMinCapital), pnlAtMinCapital >= 0 ? 'text-green-500' : 'text-red-500')}
                `;

                // 8. Quantity Analysis Card
                const quantities = closed.map(t => t.quantity || 0);
                const maxQty = Math.max(...quantities, 0);
                const minQty = Math.min(...quantities, 0);
                const avgQty = quantities.length ? quantities.reduce((a, b) => a + b, 0) / quantities.length : 0;
                
                // Find P&L at max and min quantity
                const maxQtyTrade = closed.find(t => (t.quantity || 0) === maxQty);
                const minQtyTrade = closed.find(t => (t.quantity || 0) === minQty);
                const pnlAtMaxQty = maxQtyTrade ? (maxQtyTrade.exit_price - maxQtyTrade.entry_price) * (maxQtyTrade.quantity || 0) : 0;
                const pnlAtMinQty = minQtyTrade ? (minQtyTrade.exit_price - minQtyTrade.entry_price) * (minQtyTrade.quantity || 0) : 0;

                document.getElementById('quantity-analysis-metrics').innerHTML = `
                    ${createMetricRow('Maximum', maxQty.toLocaleString())}
                    ${createMetricRow('Minimum', minQty.toLocaleString())}
                    ${createMetricRow('Average', Math.round(avgQty).toLocaleString())}
                    ${createMetricRow('P&L at Max Qty', formatCurrency(pnlAtMaxQty), pnlAtMaxQty >= 0 ? 'text-green-500' : 'text-red-500')}
                    ${createMetricRow('P&L at Min Qty', formatCurrency(pnlAtMinQty), pnlAtMinQty >= 0 ? 'text-green-500' : 'text-red-500')}
                `;

                // 9. Weekday Avg R:R Card
                const weekdayRR = {};
                Object.entries(byWeekday).forEach(([day, pnl]) => {
                    const dayTrades = closed.filter(t => weekdays[new Date(t.exit_date).getDay()] === day);
                    if (dayTrades.length > 0) {
                        // Calculate individual R:R ratios for each trade and then average them
                        const individualRRs = dayTrades.map(trade => {
                            const tradePnL = (trade.exit_price - trade.entry_price) * (trade.quantity || 0);
                            const risk = Math.abs(tradePnL); // Risk is the absolute value of the trade
                            const reward = Math.max(0, tradePnL); // Reward is only positive PnL
                            return risk > 0 ? reward / risk : 0;
                        });
                        
                        // Calculate average R:R for the day
                        const avgRR = individualRRs.reduce((sum, rr) => sum + rr, 0) / individualRRs.length;
                        weekdayRR[day] = avgRR;
                    }
                });

                const weekdaysOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                document.getElementById('weekday-rr-metrics').innerHTML = weekdaysOrder
                    .filter(day => weekdayRR[day] !== undefined)
                    .map(day => createMetricRow(day, `${weekdayRR[day].toFixed(2)}R`, weekdayRR[day] >= 1 ? 'text-green-500' : 'text-white'))
                    .join('') || '<div class="text-sm" style="color: var(--text-muted);">No R:R data available</div>';

                // 10. Weekday Win Rate Card
                const weekdayWinRates = {};
                Object.entries(byWeekday).forEach(([day, pnl]) => {
                    const dayTrades = closed.filter(t => weekdays[new Date(t.exit_date).getDay()] === day);
                    const dayWins = dayTrades.filter(t => ((t.exit_price - t.entry_price) * (t.quantity || 0)) > 0).length;
                    weekdayWinRates[day] = dayTrades.length > 0 ? (dayWins / dayTrades.length) * 100 : 0;
                });

                document.getElementById('weekday-win-rate-metrics').innerHTML = weekdaysOrder
                    .filter(day => weekdayWinRates[day] !== undefined)
                    .map(day => createMetricRow(day, `${weekdayWinRates[day].toFixed(0)}%`, weekdayWinRates[day] >= 50 ? 'text-green-500' : 'text-white'))
                    .join('') || '<div class="text-sm" style="color: var(--text-muted);">No win rate data available</div>';

                // 11. Daily Trade Activity Card
                const tradesPerDay = {};
                closed.forEach(t => {
                    const date = t.exit_date.split('T')[0];
                    tradesPerDay[date] = (tradesPerDay[date] || 0) + 1;
                });
                
                const dailyTradeCounts = Object.values(tradesPerDay);
                const avgTradesPerDay = dailyTradeCounts.length ? dailyTradeCounts.reduce((a, b) => a + b, 0) / dailyTradeCounts.length : 0;
                const maxTradesInDay = Math.max(...dailyTradeCounts, 0);
                const daysWithOneTrade = dailyTradeCounts.filter(count => count === 1).length;
                const overtradingDays = dailyTradeCounts.filter(count => count > 7).length;

                document.getElementById('daily-trade-activity-metrics').innerHTML = `
                    ${createMetricRow('Avg Trades Per Day', avgTradesPerDay.toFixed(1))}
                    ${createMetricRow('Max Trades in a Day', maxTradesInDay)}
                    ${createMetricRow('Days With Only 1 Trade', daysWithOneTrade)}
                    ${createMetricRow('Overtrading Days (>7 trades)', overtradingDays, overtradingDays > 0 ? 'text-red-500' : 'text-green-500')}
                `;

            } catch (e) {
                console.error('renderAdvancedMetrics error', e);
            }
        };
        const renderStatement = () => {
            try {
                const statementBody = document.getElementById('statement-tbody');
                if (!statementBody) return;
                // Load latest
                const trades = JSON.parse(localStorage.getItem('trades') || '[]') || [];
                const ledger = JSON.parse(localStorage.getItem('ledger') || '[]') || [];

                const tradeRows = trades.map(t => {
                    const closed = t.exit_date && t.exit_price;
                    const gross = closed ? ((t.exit_price - t.entry_price) * (t.quantity || 0)) : 0;
                    const charges = (t.brokerage || 0) + (t.other_fees || 0);
                    const net = gross - charges;
                    return {
                        date: t.exit_date || t.entry_date || '—',
                        type: 'Trade',
                        symbol: t.asset || '—',
                        strategy: t.strategy || '—',
                        gross,
                        charges,
                        net,
                        amount: '',
                        notes: (t.outcomeSummary || '')
                    };
                });
                const ledgerRows = ledger.map(l => ({
                    date: l.date || '—',
                    type: l.type,
                    symbol: l.type,
                    strategy: '—',
                    gross: 0,
                    charges: 0,
                    net: 0,
                    amount: l.amount || 0,
                    notes: l.notes || '—'
                }));

                const allRows = [...tradeRows, ...ledgerRows].sort((a,b) => String(a.date).localeCompare(String(b.date)));
                statementBody.innerHTML = allRows.map(r => `
                    <tr>
                        <td class="px-6 py-3">${r.date}</td>
                        <td class="px-6 py-3">${r.type}</td>
                        <td class="px-6 py-3">${r.symbol}</td>
                        <td class="px-6 py-3">${r.strategy}</td>
                        <td class="px-6 py-3 ${r.gross >= 0 ? 'text-green-500' : 'text-red-500'}">${r.type==='Trade' ? formatCurrency(r.gross) : '—'}</td>
                        <td class="px-6 py-3">${r.type==='Trade' ? formatCurrency(r.charges) : '—'}</td>
                        <td class="px-6 py-3 ${r.net >= 0 ? 'text-green-500' : 'text-red-500'}">${r.type==='Trade' ? formatCurrency(r.net) : '—'}</td>
                        <td class="px-6 py-3">${r.type!=='Trade' ? formatCurrency(r.amount) : '—'}</td>
                        <td class="px-6 py-3">${r.notes}</td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('renderStatement error', e);
            }
        };
        const renderProfilePage = (profileData) => {
            try {
                if (!profileData) return;
                
                // Update profile form fields
                const nameField = document.getElementById('profile-name');
                const emailField = document.getElementById('profile-email');
                const phoneField = document.getElementById('profile-phone');
                const cityField = document.getElementById('profile-city');
                
                if (nameField) nameField.value = profileData.name || '';
                if (emailField) emailField.value = profileData.email || '';
                if (phoneField) phoneField.value = profileData.phone || '';
                if (cityField) cityField.value = profileData.city || '';
                
            } catch (e) {
                console.error('renderProfilePage error', e);
            }
        };
        const renderChallenge = () => {
            try {
                const challenge = JSON.parse(localStorage.getItem('activeChallenge') || 'null');
                const activeContainer = document.getElementById('challenge-active-container');
                const inactiveContainer = document.getElementById('challenge-inactive-container');
                
                console.log('renderChallenge called - Challenge:', challenge, 'Trades count:', appState.trades?.length || 0);
                
                if (challenge && challenge.id) {
                    // Show active challenge
                    activeContainer.classList.remove('hidden');
                    inactiveContainer.classList.add('hidden');
                    
                    const now = new Date();
                    const startDate = new Date(challenge.startDate);
                    const endDate = new Date(challenge.endDate);
                    const daysRemaining = Math.max(0, Math.ceil((endDate - now) / (1000 * 60 * 60 * 24)));
                    
                    // Calculate current capital from trades (use real-time data)
                    const trades = appState.trades || JSON.parse(localStorage.getItem('trades') || '[]') || [];
                    const closedTrades = trades.filter(t => t.exit_date && t.exit_price);
                    const totalPnl = closedTrades.reduce((sum, t) => sum + calculateNetPnl(t), 0);
                    const currentCapital = challenge.startingCapital + totalPnl;
                    
                    // Calculate progress
                    const targetGain = challenge.targetCapital - challenge.startingCapital;
                    const currentGain = currentCapital - challenge.startingCapital;
                    const progressPercent = Math.min(100, Math.max(0, (currentGain / targetGain) * 100));
                    
                    // Calculate daily target
                    const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
                    const dailyTarget = targetGain / totalDays;
                    
                    // Calculate win rate for challenge period
                    const challengeTrades = closedTrades.filter(t => {
                        const tradeDate = new Date(t.exit_date);
                        return tradeDate >= startDate && tradeDate <= endDate;
                    });
                    const wins = challengeTrades.filter(t => calculateNetPnl(t) > 0).length;
                    const winRate = challengeTrades.length > 0 ? (wins / challengeTrades.length) * 100 : 0;
                    
                    // Update UI
                    document.getElementById('challenge-days-remaining').textContent = daysRemaining;
                    document.getElementById('challenge-end-date').textContent = endDate.toLocaleDateString();
                    document.getElementById('challenge-current-capital').textContent = formatCurrency(currentCapital);
                    document.getElementById('challenge-target-capital').textContent = `Target: ${formatCurrency(challenge.targetCapital)}`;
                    document.getElementById('challenge-daily-target').textContent = formatCurrency(dailyTarget);
                    document.getElementById('challenge-win-rate').textContent = `${winRate.toFixed(1)}%`;
                    document.getElementById('challenge-progress-percent').textContent = `${progressPercent.toFixed(0)}%`;
                    
                    // Update progress chart
                    const progressCtx = document.getElementById('challengeProgressChart');
                    if (progressCtx && typeof Chart !== 'undefined') {
                        if (chartInstances['challengeProgressChart']) {
                            chartInstances['challengeProgressChart'].destroy();
                        }
                        
                        const progressChart = new Chart(progressCtx, {
                            type: 'doughnut',
                            data: {
                                datasets: [{
                                    data: [progressPercent, 100 - progressPercent],
                                    backgroundColor: ['#22c55e', '#e5e7eb'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '70%',
                                plugins: {
                                    legend: { 
                                        display: false 
                                    },
                                    tooltip: getContinuousTooltipConfig(themeColors, {
                                        borderColor: 'rgba(255, 255, 255, 0.2)'
                                    })
                                }
                            }
                        });
                        chartInstances['challengeProgressChart'] = progressChart;
                    }
                    
                    // Calculate additional metrics
                    const avgRR = challengeTrades.length > 0 ? 
                        challengeTrades.reduce((sum, t) => {
                            const pnl = calculateNetPnl(t);
                            const risk = Math.abs(t.entry_price - (t.stop_loss || t.entry_price * 0.98));
                            return risk > 0 ? sum + (pnl / risk) : sum;
                        }, 0) / challengeTrades.length : 0;
                    
                    const highestProfit = challengeTrades.length > 0 ? 
                        Math.max(...challengeTrades.map(t => calculateNetPnl(t))) : 0;
                    
                    const maxDrawdown = challengeTrades.length > 0 ? 
                        Math.min(...challengeTrades.map(t => calculateNetPnl(t))) : 0;
                    
                    document.getElementById('challenge-avg-rr').textContent = `${avgRR.toFixed(1)}:1`;
                    document.getElementById('challenge-highest-profit').textContent = formatCurrency(highestProfit);
                    document.getElementById('challenge-max-drawdown').textContent = `${Math.abs(maxDrawdown).toFixed(2)}%`;
                    
                    // Check if challenge is completed
                    if (currentCapital >= challenge.targetCapital && !challenge.completed) {
                        challenge.completed = true;
                        challenge.success = true;
                        challenge.completedAt = new Date().toISOString();
                        localStorage.setItem('activeChallenge', JSON.stringify(challenge));
                        
                        // Move to history
                        const history = JSON.parse(localStorage.getItem('challengeHistory') || '[]');
                        history.push(challenge);
                        localStorage.setItem('challengeHistory', JSON.stringify(history));
                        
                        // Clear active challenge
                        localStorage.removeItem('activeChallenge');
                        
                        showToast('🎉 Challenge completed successfully!', 'success');
                        renderChallenge();
                        renderChallengeHistory();
                    } else if (daysRemaining <= 0 && !challenge.completed) {
                        challenge.completed = true;
                        challenge.success = false;
                        challenge.completedAt = new Date().toISOString();
                        
                        // Move to history
                        const history = JSON.parse(localStorage.getItem('challengeHistory') || '[]');
                        history.push(challenge);
                        localStorage.setItem('challengeHistory', JSON.stringify(history));
                        
                        // Clear active challenge
                        localStorage.removeItem('activeChallenge');
                        
                        showToast('Challenge time expired. Better luck next time!', 'info');
                        renderChallenge();
                        renderChallengeHistory();
                    }
                    
                } else {
                    // Show inactive state
                    activeContainer.classList.add('hidden');
                    inactiveContainer.classList.remove('hidden');
                }
            } catch (e) {
                console.error('renderChallenge error', e);
            }
        };
        
        const renderChallengeHistory = () => {
            try {
                const history = JSON.parse(localStorage.getItem('challengeHistory') || '[]') || [];
                const container = document.getElementById('challenge-history-container');
                
                if (history.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">No challenge history yet.</p>';
                    return;
                }
                
                container.innerHTML = history.map(challenge => {
                    const startDate = new Date(challenge.startDate);
                    const endDate = new Date(challenge.endDate);
                    const completed = challenge.completed;
                    const success = challenge.success;
                    
                    return `
                        <div class="p-4 rounded-lg border" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold" style="color: var(--text-primary);">
                                        ${formatCurrency(challenge.startingCapital)} → ${formatCurrency(challenge.targetCapital)}
                                    </h4>
                                    <p class="text-sm" style="color: var(--text-secondary);">
                                        ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}
                                    </p>
                                    <p class="text-sm" style="color: var(--text-secondary);">
                                        ${challenge.timeframe} days • Max Risk: ${challenge.maxRisk}%
                                    </p>
                                </div>
                                <div class="text-right">
                                    <span class="px-2 py-1 rounded text-xs font-medium ${
                                        completed ? (success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') : 'bg-yellow-100 text-yellow-800'
                                    }">
                                        ${completed ? (success ? 'Success' : 'Failed') : 'Incomplete'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('renderChallengeHistory error', e);
            }
        };
        const renderAchievements = () => {
            try {
                const trades = appState.trades || [];
                const closedTrades = trades.filter(t => t.exit_price && t.exit_date);
                const totalTrades = closedTrades.length;
                const wins = closedTrades.filter(t => calculateNetPnl(t) > 0).length;
                const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
                const netPnl = closedTrades.reduce((sum, t) => sum + calculateNetPnl(t), 0);
                
                // Define achievement criteria
                const achievements = [
                    { id: 'first_trade', name: 'First Trade', description: 'Complete your first trade', achieved: totalTrades >= 1, icon: 'trending-up' },
                    { id: 'first_win', name: 'First Win', description: 'Win your first trade', achieved: wins >= 1, icon: 'award' },
                    { id: 'ten_trades', name: 'Active Trader', description: 'Complete 10 trades', achieved: totalTrades >= 10, icon: 'activity' },
                    { id: 'profitable', name: 'Profitable', description: 'Achieve positive P&L', achieved: netPnl > 0, icon: 'dollar-sign' },
                    { id: 'high_winrate', name: 'Consistent', description: 'Achieve 70%+ win rate (10+ trades)', achieved: totalTrades >= 10 && winRate >= 70, icon: 'target' },
                    { id: 'big_winner', name: 'Big Winner', description: 'Win ₹10,000+ in a single trade', achieved: closedTrades.some(t => calculateNetPnl(t) >= 10000), icon: 'star' }
                ];
                
                const container = document.getElementById('achievements-container');
                if (container) {
                    container.innerHTML = achievements.map(achievement => `
                        <div class="p-4 rounded-lg border ${achievement.achieved ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i data-feather="${achievement.icon}" class="h-8 w-8 ${achievement.achieved ? 'text-green-500' : 'text-gray-400'}"></i>
                                </div>
                                <div class="ml-4">
                                    <h3 class="text-lg font-medium ${achievement.achieved ? 'text-green-900' : 'text-gray-900'}" style="color: var(--text-primary);">${achievement.name}</h3>
                                    <p class="text-sm ${achievement.achieved ? 'text-green-700' : 'text-gray-500'}" style="color: var(--text-secondary);">${achievement.description}</p>
                                </div>
                                <div class="ml-auto">
                                    ${achievement.achieved ? '<span class="text-green-500">✓</span>' : '<span class="text-gray-400">○</span>'}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    // Re-render feather icons
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                }
            } catch (e) {
                console.error('renderAchievements error', e);
            }
        };
        const renderOpenPositionsOverview = () => {
            try {
                const openTrades = appState.trades.filter(trade => !trade.exit_date || !trade.exit_price);
                const openTradesCount = openTrades.length;
                
                // Update count and pluralization
                const countEl = document.getElementById('open-positions-count');
                const pluralEl = document.getElementById('open-positions-plural');
                const capitalPluralEl = document.getElementById('capital-deployed-plural');
                
                if (countEl) countEl.textContent = openTradesCount;
                if (pluralEl) pluralEl.textContent = openTradesCount === 1 ? '' : 's';
                if (capitalPluralEl) capitalPluralEl.textContent = openTradesCount === 1 ? '' : 's';
                
                // Calculate Capital Deployed
                const capitalDeployed = openTrades.reduce((total, trade) => {
                    return total + ((trade.entry_price || 0) * (trade.quantity || 0));
                }, 0);
                
                // Update Capital Deployed
                const capitalAmountEl = document.getElementById('capital-deployed-amount');
                const capitalDescEl = document.getElementById('capital-deployed-description');
                if (capitalAmountEl) capitalAmountEl.textContent = formatCurrency(capitalDeployed);
                if (capitalDescEl) capitalDescEl.textContent = `${openTradesCount} open trade${openTradesCount === 1 ? '' : 's'}`;
                
                // Calculate Total Open Risk (same as Account Summary)
                const totalRiskAmount = openTrades.reduce((total, trade) => {
                    const tradeValue = trade.entry_price * trade.quantity;
                    return total + tradeValue;
                }, 0);
                
                // Update Total Open Risk
                const riskAmountEl = document.getElementById('total-open-risk-amount-overview');
                if (riskAmountEl) {
                    riskAmountEl.textContent = formatCurrency(totalRiskAmount);
                    riskAmountEl.className = 'text-2xl font-bold mt-1';
                    riskAmountEl.style.color = totalRiskAmount > 0 ? '#ef4444' : 'var(--text-primary)'; // Red if risk exists
                }
                
                // Calculate Average Time Open
                let avgTimeOpen = 0;
                if (openTradesCount > 0) {
                    const totalDays = openTrades.reduce((total, trade) => {
                        const entryDate = new Date(trade.entry_date);
                        const currentDate = new Date();
                        const daysDiff = Math.ceil((currentDate - entryDate) / (1000 * 60 * 60 * 24));
                        return total + daysDiff;
                    }, 0);
                    avgTimeOpen = totalDays / openTradesCount;
                }
                
                // Update Average Time Open
                const avgTimeEl = document.getElementById('avg-time-open');
                if (avgTimeEl) avgTimeEl.textContent = avgTimeOpen.toFixed(1);
                
                // Calculate Strategy Mix
                const longTrades = openTrades.filter(trade => trade.trade_type === 'Long');
                const shortTrades = openTrades.filter(trade => trade.trade_type === 'Short');
                const longPercentage = openTradesCount > 0 ? (longTrades.length / openTradesCount) * 100 : 0;
                const shortPercentage = openTradesCount > 0 ? (shortTrades.length / openTradesCount) * 100 : 0;
                
                // Update Strategy Mix
                const longPercentageEl = document.getElementById('long-percentage');
                const shortPercentageEl = document.getElementById('short-percentage');
                const longBarEl = document.getElementById('long-bar');
                
                if (longPercentageEl) longPercentageEl.textContent = `${longPercentage.toFixed(0)}% (${longTrades.length} position${longTrades.length === 1 ? '' : 's'})`;
                if (shortPercentageEl) shortPercentageEl.textContent = `${shortPercentage.toFixed(0)}% (${shortTrades.length} position${shortTrades.length === 1 ? '' : 's'})`;
                if (longBarEl) longBarEl.style.width = `${longPercentage}%`;
                
                // Render Open Positions List
                const positionsListEl = document.getElementById('open-positions-list');
                if (positionsListEl) {
                    if (openTradesCount === 0) {
                        positionsListEl.innerHTML = '<p class="text-sm text-center py-8" style="color: var(--text-muted);">No open positions</p>';
                    } else {
                        positionsListEl.innerHTML = openTrades.map(trade => {
                            const entryDate = new Date(trade.entry_date);
                            const currentDate = new Date();
                            const daysOpen = Math.ceil((currentDate - entryDate) / (1000 * 60 * 60 * 24));
                            const totalValue = (trade.entry_price || 0) * (trade.quantity || 0);
                            
                            const typeColor = trade.trade_type === 'Long' ? '#000' : '#ef4444';
                            const typeBg = trade.trade_type === 'Long' ? '#000' : '#ef4444';
                            
                            return `
                                <div class="flex items-center justify-between p-4 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                                    <div class="flex items-center space-x-4">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium text-white" style="background-color: ${typeBg};">${trade.trade_type || 'Long'}</span>
                                        <div>
                                            <p class="font-medium" style="color: var(--text-primary);">${trade.symbol || 'N/A'}</p>
                                            <p class="text-sm" style="color: var(--text-secondary);">${daysOpen}d open</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-medium" style="color: var(--text-primary);">${formatCurrency(totalValue)}</p>
                                        <p class="text-sm" style="color: var(--text-secondary);">${trade.quantity || 0} @ ${formatCurrency(trade.entry_price || 0)}</p>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
            } catch (e) {
                console.error('renderOpenPositionsOverview error', e);
            }
        };

        const renderTopTrades = () => {
            try {
                const trades = appState.trades || [];
                const closedTrades = trades.filter(t => t.exit_price && t.exit_date);
                
                // Sort by P&L (best first)
                const sortedTrades = closedTrades
                    .map(trade => ({ ...trade, pnl: calculateNetPnl(trade) }))
                    .sort((a, b) => b.pnl - a.pnl)
                    .slice(0, 5); // Top 5 trades
                
                const container = document.getElementById('top-trades-widget');
                if (container) {
                    if (sortedTrades.length === 0) {
                        container.innerHTML = '<p class="text-center text-gray-500">No completed trades yet.</p>';
                        return;
                    }
                    
                    container.innerHTML = sortedTrades.map((trade, index) => {
                        const pnl = trade.pnl;
                        const isProfit = pnl > 0;
                        const pnlClass = isProfit ? 'text-green-500' : 'text-red-500';
                        const pnlSign = isProfit ? '+' : '';
                        
                        return `
                            <div class="p-3 rounded-lg border" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${isProfit ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                            ${index + 1}
                                        </div>
                                        <div class="ml-3">
                                            <h4 class="font-semibold" style="color: var(--text-primary);">${trade.asset || 'N/A'}</h4>
                                            <p class="text-sm" style="color: var(--text-secondary);">${trade.direction || 'N/A'} • ${formatDate(trade.exit_date)}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold ${pnlClass}">${pnlSign}${formatCurrency(pnl)}</p>
                                        <p class="text-xs" style="color: var(--text-muted);">${trade.quantity || 0} qty</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error('renderTopTrades error', e);
            }
        };
        // Store chart instances to avoid duplicates
        const chartInstances = {};
        
        const renderAllCharts = () => {
            try {
                console.log('renderAllCharts called');
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not loaded');
                    return;
                }
                console.log('Chart.js is loaded, proceeding with chart rendering');

                // Get theme colors once for all charts
                const themeColors = getThemeColors();
                console.log('Theme colors for charts:', themeColors);

                const trades = Array.isArray(appState.trades) ? appState.trades : [];
                const ledger = Array.isArray(appState.ledger) ? appState.ledger : [];
                const closedTrades = trades.filter(t => t.exit_date && t.exit_price);
                
                console.log('Data available:', {
                    trades: trades.length,
                    closedTrades: closedTrades.length,
                    ledger: ledger.length
                });
                
                // Calculate daily P&L from trades
                const byDay = {};
                trades.forEach(t => {
                    if (!(t.exit_date && t.exit_price)) return;
                    const d = (new Date(t.exit_date)).toISOString().slice(0,10);
                    const pnl = calculateNetPnl(t);
                    byDay[d] = (byDay[d] || 0) + pnl;
                });
                
                // Calculate cumulative equity curve
                const sortedDays = Object.keys(byDay).sort();
                let cumulativePnl = 0;
                const equityData = sortedDays.map(day => {
                    cumulativePnl += byDay[day];
                    return cumulativePnl;
                });
                
                // Calculate account balance including deposits/withdrawals
                const deposits = ledger.filter(l => l.type === 'Deposit').reduce((s, l) => s + (l.amount || 0), 0);
                const withdrawals = ledger.filter(l => l.type === 'Withdrawal').reduce((s, l) => s + (l.amount || 0), 0);
                const baseBalance = deposits - withdrawals;
                
                const balanceData = sortedDays.map(day => {
                    const dayPnl = byDay[day];
                    const dayIndex = sortedDays.indexOf(day);
                    const cumulativeToDay = equityData[dayIndex];
                    return baseBalance + cumulativeToDay;
                });
                
                // Generate sample data if no trades
                const labels = sortedDays.length > 0 ? sortedDays : [];
                let data = sortedDays.length > 0 ? sortedDays.map(d => byDay[d]) : [];
                
                if (data.length === 0) {
                    // Generate sample data for demo
                    const today = new Date();
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().slice(0,10);
                        labels.push(dateStr);
                        data.push(Math.random() * 2000 - 1000); // Random P&L between -1000 and 1000
                    }
                }

                const colorUp = 'rgba(34,197,94,0.7)';
                const colorDown = 'rgba(239,68,68,0.7)';

                const getCtx = (id) => {
                    const el = document.getElementById(id);
                    return el ? el.getContext('2d') : null;
                };

                const makeOrUpdate = (ctx, type, datasetLabel) => {
                    if (!ctx) return null;
                    
                    // Destroy existing chart if it exists
                    if (chartInstances[ctx.canvas.id]) {
                        chartInstances[ctx.canvas.id].destroy();
                    }
                    
                    const chart = new Chart(ctx, {
                        type,
                        data: {
                            labels,
                            datasets: [{
                                label: datasetLabel,
                                data,
                                backgroundColor: data.map(v => v >= 0 ? colorUp : colorDown),
                                borderColor: data.map(v => v >= 0 ? 'rgba(34,197,94,1)' : 'rgba(239,68,68,1)'),
                                borderWidth: 1,
                                fill: type === 'line' ? false : undefined,
                                tension: type === 'line' ? 0.4 : undefined
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: { 
                                legend: { display: false } 
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(128, 128, 128, 0.1)'
                                    },
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(128, 128, 128, 0.1)'
                                    },
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor
                                    }
                                }
                            }
                        }
                    });
                    
                    chartInstances[ctx.canvas.id] = chart;
                    return chart;
                };

                // Daily P&L Chart
                const dailyPnlCtx = getCtx('dailyPnlChart');
                if (dailyPnlCtx) {
                    if (chartInstances['dailyPnlChart']) {
                        chartInstances['dailyPnlChart'].destroy();
                    }
                    
                    // Calculate daily P&L from trades
                    const dailyPnlData = {};
                    closedTrades.forEach(trade => {
                        if (trade.exit_date) {
                            const date = trade.exit_date;
                            const pnl = calculateNetPnl(trade);
                            dailyPnlData[date] = (dailyPnlData[date] || 0) + pnl;
                        }
                    });
                    
                    const sortedDates = Object.keys(dailyPnlData).sort();
                    const labels = sortedDates.length > 0 ? sortedDates.map(date => formatDateDDMMYYYY(date)) : [];
                    const data = sortedDates.length > 0 ? sortedDates.map(date => dailyPnlData[date]) : [];
                    
                    // If no data, show sample data
                    if (data.length === 0) {
                        labels.push('01-01-2024', '02-01-2024', '03-01-2024', '04-01-2024', '05-01-2024');
                        data.push(2500, -800, 1200, 3500, -500);
                    }
                    
                    const dailyPnlChart = new Chart(dailyPnlCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Daily P&L',
                                data: data,
                                backgroundColor: data.map(value => value >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                                borderColor: data.map(value => value >= 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: { display: false },
                                tooltip: getContinuousTooltipConfig(themeColors, {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            return `P&L: ₹${value.toLocaleString()}`;
                                        }
                                    }
                                }),
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(128, 128, 128, 0.1)' },
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString();
                                        },
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: { size: 11 }
                                    }
                                },
                                x: {
                                    grid: { color: 'rgba(128, 128, 128, 0.1)' },
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 0,
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: { size: 11 }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances['dailyPnlChart'] = dailyPnlChart;
                }
                
                // Equity Curve Chart - Trading Performance Only
                    const equityCtx = getCtx('equityCurveChart');
                    if (equityCtx) {
                        if (chartInstances['equityCurveChart']) {
                            chartInstances['equityCurveChart'].destroy();
                        }
                    
                    // Get all unique dates from trades only (not ledger)
                    const allDates = new Set();
                    
                    // Add trade dates
                    closedTrades.forEach(trade => {
                        if (trade.entry_date) allDates.add(trade.entry_date);
                        if (trade.exit_date) allDates.add(trade.exit_date);
                    });
                    
                    // Sort dates
                    const sortedDates = Array.from(allDates).sort();
                    
                    // If no trades, show empty chart
                    let chartLabels, equityData, segmentBreakdown;
                    
                    if (sortedDates.length === 0) {
                        // No trades - show empty chart
                        chartLabels = [];
                        equityData = [];
                        segmentBreakdown = [];
                    } else {
                        // Calculate trading equity for each date
                        chartLabels = sortedDates.map(date => formatDateDDMMYYYY(date));
                        equityData = [];
                        segmentBreakdown = [];
                        
                        sortedDates.forEach(date => {
                            // Calculate realized P&L by segment
                            const realizedPnlBySegment = {
                                equity: 0,
                                fno: 0,
                                commodity: 0,
                                currency: 0
                            };
                            
                            closedTrades
                                .filter(trade => trade.exit_date && trade.exit_date <= date)
                                .forEach(trade => {
                                    const segment = (trade.segment || 'equity').toLowerCase();
                                    const pnl = calculateNetPnl(trade);
                                    
                                    if (segment.includes('equity') || segment.includes('stock')) {
                                        realizedPnlBySegment.equity += pnl;
                                    } else if (segment.includes('fno') || segment.includes('derivative') || segment.includes('futures') || segment.includes('options')) {
                                        realizedPnlBySegment.fno += pnl;
                                    } else if (segment.includes('commodity') || segment.includes('gold') || segment.includes('silver') || segment.includes('crude')) {
                                        realizedPnlBySegment.commodity += pnl;
                                    } else if (segment.includes('currency') || segment.includes('forex') || segment.includes('usd') || segment.includes('eur')) {
                                        realizedPnlBySegment.currency += pnl;
                                    } else {
                                        realizedPnlBySegment.equity += pnl; // Default to equity
                                    }
                                });
                            
                            // Calculate unrealized P&L by segment (for open positions)
                            const unrealizedPnlBySegment = {
                                equity: 0,
                                fno: 0,
                                commodity: 0,
                                currency: 0
                            };
                            
                            closedTrades
                                .filter(trade => {
                                    const entryDate = trade.entry_date;
                                    const exitDate = trade.exit_date;
                                    return entryDate && entryDate <= date && (!exitDate || exitDate > date);
                                })
                                .forEach(trade => {
                                    const segment = (trade.segment || 'equity').toLowerCase();
                                    // For unrealized P&L, we'll use a simplified calculation
                                    // In a real system, you'd use current market prices
                                    const unrealizedPnl = (trade.exitPrice || trade.entryPrice || 0) - (trade.entryPrice || 0);
                                    const quantity = trade.quantity || 0;
                                    const pnl = unrealizedPnl * quantity;
                                    
                                    if (segment.includes('equity') || segment.includes('stock')) {
                                        unrealizedPnlBySegment.equity += pnl;
                                    } else if (segment.includes('fno') || segment.includes('derivative') || segment.includes('futures') || segment.includes('options')) {
                                        unrealizedPnlBySegment.fno += pnl;
                                    } else if (segment.includes('commodity') || segment.includes('gold') || segment.includes('silver') || segment.includes('crude')) {
                                        unrealizedPnlBySegment.commodity += pnl;
                                    } else if (segment.includes('currency') || segment.includes('forex') || segment.includes('usd') || segment.includes('eur')) {
                                        unrealizedPnlBySegment.currency += pnl;
                                    } else {
                                        unrealizedPnlBySegment.equity += pnl; // Default to equity
                                    }
                                });
                            
                            // Calculate total realized and unrealized P&L
                            const totalRealizedPnl = Object.values(realizedPnlBySegment).reduce((sum, pnl) => sum + pnl, 0);
                            const totalUnrealizedPnl = Object.values(unrealizedPnlBySegment).reduce((sum, pnl) => sum + pnl, 0);
                            
                            // Equity = Cumulative Trading P&L only (starts from 0, no starting balance)
                            const equity = totalRealizedPnl + totalUnrealizedPnl;
                            
                            equityData.push(equity);
                            segmentBreakdown.push({
                                equity: realizedPnlBySegment.equity + unrealizedPnlBySegment.equity,
                                fno: realizedPnlBySegment.fno + unrealizedPnlBySegment.fno,
                                commodity: realizedPnlBySegment.commodity + unrealizedPnlBySegment.commodity,
                                currency: realizedPnlBySegment.currency + unrealizedPnlBySegment.currency,
                                realized: totalRealizedPnl,
                                unrealized: totalUnrealizedPnl
                            });
                        });
                    }
                    
                        const equityChart = new Chart(equityCtx, {
                            type: 'line',
                            data: {
                            labels: chartLabels,
                                datasets: [{
                                label: 'Trading Equity',
                                    data: equityData,
                                borderColor: 'rgba(59, 130, 246, 1)', // Blue color
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointHoverRadius: 6
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                aspectRatio: 1.5,
                                layout: {
                                    padding: 0
                                },
                            plugins: {
                                legend: { display: false },
                                tooltip: getContinuousTooltipConfig(themeColors, {
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    callbacks: {
                                        title: function(context) {
                                            return `Date: ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            return `Total Equity: ₹${context.parsed.y.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                        }
                                    }
                                }),
                            },
                                scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                                        },
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        },
                                        maxTicksLimit: 6
                                    }
                                },
                                x: {
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        },
                                        maxRotation: 45,
                                        minRotation: 0,
                                        maxTicksLimit: 8
                                    }
                                }
                                }
                            }
                        });
                        chartInstances['equityCurveChart'] = equityChart;
                }
                
                // Account Balance Chart - Account Value Only
                const balanceCtx = getCtx('accountBalanceChart');
                if (balanceCtx) {
                    if (chartInstances['accountBalanceChart']) {
                        chartInstances['accountBalanceChart'].destroy();
                    }
                    
                    
                    // Get first deposit to determine starting point
                    const firstDeposit = ledger.find(l => l.type === 'Deposit');
                    const initialBalance = firstDeposit ? firstDeposit.amount : 100000; // Default to 1L if no deposits
                    
                    // Get all unique dates from trades and ledger
                    const allDates = new Set();
                    
                    // Add trade dates
                    closedTrades.forEach(trade => {
                        if (trade.entry_date) allDates.add(trade.entry_date);
                        if (trade.exit_date) allDates.add(trade.exit_date);
                    });
                    
                    // Add ledger dates
                    ledger.forEach(entry => {
                        if (entry.date) allDates.add(entry.date);
                    });
                    
                    // Sort dates
                    const sortedDates = Array.from(allDates).sort();
                    
                    // If no dates, create sample data
                    let chartLabels, accountValueData, cumulativeDeposits, cumulativeWithdrawals, cumulativePnl;
                    
                    if (sortedDates.length === 0) {
                        // Sample data - starts from first deposit amount
                        chartLabels = ['01-01-2024', '15-01-2024', '01-02-2024', '15-02-2024', '01-03-2024'];
                        accountValueData = [100000, 105000, 112000, 108000, 115000]; // First deposit + P&L
                        cumulativeDeposits = [100000, 100000, 100000, 100000, 100000];
                        cumulativeWithdrawals = [0, 0, 0, 0, 0];
                        cumulativePnl = [0, 5000, 12000, 8000, 15000];
                    } else {
                        // Calculate cumulative values for each date
                        chartLabels = sortedDates.map(date => formatDateDDMMYYYY(date));
                        accountValueData = [];
                        cumulativeDeposits = [];
                        cumulativeWithdrawals = [];
                        cumulativePnl = [];
                        
                        sortedDates.forEach(date => {
                            // Calculate deposits and withdrawals up to this date
                            const depositsToDate = ledger
                                .filter(l => l.type === 'Deposit' && l.date <= date)
                                .reduce((sum, l) => sum + (l.amount || 0), 0);
                            
                            const withdrawalsToDate = ledger
                                .filter(l => l.type === 'Withdrawal' && l.date <= date)
                                .reduce((sum, l) => sum + (l.amount || 0), 0);
                            
                            // Calculate P&L up to this date
                            const pnlToDate = closedTrades
                                .filter(trade => trade.exit_date && trade.exit_date <= date)
                                .reduce((sum, trade) => {
                                    const pnl = calculateNetPnl(trade);
                                    return sum + (isNaN(pnl) ? 0 : pnl);
                                }, 0);
                            
                            // Account Value = cumulative_deposits - withdrawalsToDate + cumulative_P&L
                            // This starts from 0 and builds up with actual transactions
                            const accountValue = depositsToDate - withdrawalsToDate + pnlToDate;
                            
                            // Ensure no NaN values
                            accountValueData.push(isNaN(accountValue) ? 0 : accountValue);
                            cumulativeDeposits.push(isNaN(depositsToDate) ? 0 : depositsToDate);
                            cumulativeWithdrawals.push(isNaN(withdrawalsToDate) ? 0 : withdrawalsToDate);
                            cumulativePnl.push(isNaN(pnlToDate) ? 0 : pnlToDate);
                        });
                    }
                    
                    const balanceChart = new Chart(balanceCtx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [
                                {
                                    label: 'Account Value',
                                    data: accountValueData,
                                    borderColor: 'rgba(20, 184, 166, 1)', // Teal color
                                    backgroundColor: 'rgba(20, 184, 166, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: getContinuousTooltipConfig(themeColors, {
                                    borderColor: 'rgba(20, 184, 166, 1)',
                                    callbacks: {
                                        title: function(context) {
                                            return `Date: ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            return `Account Value: ₹${context.parsed.y.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                        }
                                    }
                                }),
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                        },
                                        color: themeColors.chartText || themeColors.textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                x: {
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        },
                                        maxRotation: 45,
                                        minRotation: 0
                                    }
                                }
                            }
                        }
                    });
                    chartInstances['accountBalanceChart'] = balanceChart;
                }
                
                // Monthly Performance Chart
                const monthlyCtx = getCtx('monthlyPerformanceChart');
                if (monthlyCtx) {
                    if (chartInstances['monthlyPerformanceChart']) {
                        chartInstances['monthlyPerformanceChart'].destroy();
                    }
                    
                    console.log('Creating Monthly Performance Chart with closedTrades:', closedTrades.length);
                    
                    // Calculate monthly P&L from trades
                    const monthlyPnlData = {};
                    let totalTrades = 0;
                    let totalPnl = 0;
                    
                    closedTrades.forEach(trade => {
                        if (trade.exit_date) {
                            const date = new Date(trade.exit_date);
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            const pnl = calculateNetPnl(trade);
                            monthlyPnlData[monthKey] = (monthlyPnlData[monthKey] || 0) + pnl;
                            totalTrades++;
                            totalPnl += pnl;
                        }
                    });
                    
                    console.log('Monthly P&L Data:', monthlyPnlData);
                    console.log('Total trades processed:', totalTrades, 'Total P&L:', totalPnl);
                    
                    const sortedMonths = Object.keys(monthlyPnlData).sort();
                    const labels = sortedMonths.length > 0 ? sortedMonths.map(month => {
                        // Convert "2024-01" to "JAN 2024"
                        const [year, monthNum] = month.split('-');
                        const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                                          'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                        const monthName = monthNames[parseInt(monthNum) - 1];
                        return `${monthName} ${year}`;
                    }) : [];
                    const data = sortedMonths.length > 0 ? sortedMonths.map(month => monthlyPnlData[month]) : [];
                    
                    // If no data, show sample data
                    if (data.length === 0) {
                        console.log('No monthly data found, using sample data');
                        labels.push('JAN 2024', 'FEB 2024', 'MAR 2024', 'APR 2024', 'MAY 2024');
                        data.push(15000, -5000, 12000, 8000, 20000);
                    }
                    
                    console.log('Monthly chart labels:', labels);
                    console.log('Monthly chart data:', data);
                    
                    const monthlyChart = new Chart(monthlyCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Monthly P&L',
                                data: data,
                                backgroundColor: data.map(value => value >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'),
                                borderColor: data.map(value => value >= 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: { display: false },
                                tooltip: getContinuousTooltipConfig(themeColors, {
                                    callbacks: {
                                        title: function(context) {
                                            return `Month: ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            const isProfit = value >= 0;
                                            return [
                                                `Monthly P&L: ₹${value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
                                                `Status: ${isProfit ? 'Profit' : 'Loss'}`
                                            ];
                                        }
                                    }
                                }),
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                        },
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: { size: 11 }
                                    }
                                },
                                x: {
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 0,
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: { size: 11 }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances['monthlyPerformanceChart'] = monthlyChart;
                    console.log('Monthly Performance Chart created successfully');
                } else {
                    console.log('Monthly Performance Chart canvas not found');
                }
                
                // P&L by Segment Chart
                const segmentCtx = getCtx('pnlBySegmentChart');
                if (segmentCtx) {
                    if (chartInstances['pnlBySegmentChart']) {
                        chartInstances['pnlBySegmentChart'].destroy();
                    }
                    
                    // Calculate P&L by segment
                    const segmentData = {};
                    closedTrades.forEach(trade => {
                        const segment = trade.segment || 'Equity'; // Default to Equity if no segment specified
                        const pnl = calculateNetPnl(trade);
                        if (!segmentData[segment]) {
                            segmentData[segment] = { totalPnl: 0, tradeCount: 0 };
                        }
                        segmentData[segment].totalPnl += pnl;
                        segmentData[segment].tradeCount += 1;
                    });
                    
                    let segmentLabels = Object.keys(segmentData);
                    let segmentPnlValues = segmentLabels.map(segment => segmentData[segment].totalPnl);
                    
                    // If no trades, show sample data for common segments
                    if (segmentLabels.length === 0) {
                        segmentLabels = ['Equity', 'Commodity', 'Currency', 'Derivatives'];
                        segmentPnlValues = [15000, 8000, -2000, 5000];
                    }
                    
                    // Use different colors for each segment
                    const segmentColors = [
                        'rgba(34, 197, 94, 0.7)',   // Green for Equity
                        'rgba(59, 130, 246, 0.7)',  // Blue for Commodity
                        'rgba(168, 85, 247, 0.7)',  // Purple for Currency
                        'rgba(245, 158, 11, 0.7)',  // Amber for Derivatives
                        'rgba(239, 68, 68, 0.7)',   // Red for others
                        'rgba(16, 185, 129, 0.7)',  // Emerald for others
                        'rgba(236, 72, 153, 0.7)'   // Pink for others
                    ];
                    
                    const segmentBorderColors = [
                        'rgba(34, 197, 94, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(168, 85, 247, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(239, 68, 68, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(236, 72, 153, 1)'
                    ];
                    
                    const segmentChart = new Chart(segmentCtx, {
                        type: 'bar',
                        data: {
                            labels: segmentLabels,
                            datasets: [{
                                label: 'P&L by Segment',
                                data: segmentPnlValues,
                                backgroundColor: segmentLabels.map((_, index) => segmentColors[index % segmentColors.length]),
                                borderColor: segmentLabels.map((_, index) => segmentBorderColors[index % segmentBorderColors.length]),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: { display: false },
                                tooltip: getContinuousTooltipConfig(themeColors, {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            return `P&L: ₹${value.toLocaleString()}`;
                                        },
                                        afterLabel: function(context) {
                                            const segment = context.label;
                                            const data = segmentData[segment];
                                            if (data && data.tradeCount > 0) {
                                                return `Trades: ${data.tradeCount}`;
                                            }
                                            return '';
                                        }
                                    }
                                }),
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString();
                                        },
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                x: {
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 0,
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances['pnlBySegmentChart'] = segmentChart;
                }
                
                // P&L by Trading Style Chart
                const tradingStyleCtx = getCtx('pnlByTradingStyleChart');
                if (tradingStyleCtx) {
                    if (chartInstances['pnlByTradingStyleChart']) {
                        chartInstances['pnlByTradingStyleChart'].destroy();
                    }
                    
                    // Calculate P&L by trading style
                    const tradingStyleData = {};
                    closedTrades.forEach(trade => {
                        const tradingStyle = trade.trading_style || 'Intraday'; // Default to Intraday if no trading style specified
                        const pnl = calculateNetPnl(trade);
                        if (!tradingStyleData[tradingStyle]) {
                            tradingStyleData[tradingStyle] = { totalPnl: 0, tradeCount: 0 };
                        }
                        tradingStyleData[tradingStyle].totalPnl += pnl;
                        tradingStyleData[tradingStyle].tradeCount += 1;
                    });
                    
                    let tradingStyleLabels = Object.keys(tradingStyleData);
                    let tradingStylePnlValues = tradingStyleLabels.map(style => tradingStyleData[style].totalPnl);
                    
                    // If no trades, show sample data for common trading styles
                    if (tradingStyleLabels.length === 0) {
                        tradingStyleLabels = ['Scalping', 'Intraday', 'Swing', 'Position', 'Long-Term'];
                        tradingStylePnlValues = [5000, 12000, 8000, 15000, 25000];
                    }
                    
                    // Use different colors for each trading style
                    const tradingStyleColors = [
                        'rgba(239, 68, 68, 0.7)',   // Red for Scalping
                        'rgba(34, 197, 94, 0.7)',   // Green for Intraday
                        'rgba(59, 130, 246, 0.7)',  // Blue for Swing
                        'rgba(168, 85, 247, 0.7)',  // Purple for Position
                        'rgba(245, 158, 11, 0.7)',  // Amber for Long-Term
                        'rgba(16, 185, 129, 0.7)',  // Emerald for others
                        'rgba(236, 72, 153, 0.7)'   // Pink for others
                    ];
                    
                    const tradingStyleBorderColors = [
                        'rgba(239, 68, 68, 1)',
                        'rgba(34, 197, 94, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(168, 85, 247, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(16, 185, 129, 1)',
                        'rgba(236, 72, 153, 1)'
                    ];
                    
                    const tradingStyleChart = new Chart(tradingStyleCtx, {
                        type: 'bar',
                        data: {
                            labels: tradingStyleLabels,
                            datasets: [{
                                label: 'P&L by Trading Style',
                                data: tradingStylePnlValues,
                                backgroundColor: tradingStyleLabels.map((_, index) => tradingStyleColors[index % tradingStyleColors.length]),
                                borderColor: tradingStyleLabels.map((_, index) => tradingStyleBorderColors[index % tradingStyleBorderColors.length]),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: { display: false },
                                tooltip: getContinuousTooltipConfig(themeColors, {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            return `P&L: ₹${value.toLocaleString()}`;
                                        },
                                        afterLabel: function(context) {
                                            const style = context.label;
                                            const data = tradingStyleData[style];
                                            if (data && data.tradeCount > 0) {
                                                return `Trades: ${data.tradeCount}`;
                                            }
                                            return '';
                                        }
                                    }
                                }),
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString();
                                        },
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                x: {
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 0,
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances['pnlByTradingStyleChart'] = tradingStyleChart;
                }
                
                // Win/Loss Distribution Chart (Donut Chart)
                const winLossCtx = getCtx('winLossDistributionChart');
                if (winLossCtx) {
                    if (chartInstances['winLossDistributionChart']) {
                        chartInstances['winLossDistributionChart'].destroy();
                    }
                    
                    const wins = closedTrades.filter(trade => calculateNetPnl(trade) > 0).length;
                    const losses = closedTrades.filter(trade => calculateNetPnl(trade) < 0).length;
                    
                    // Show message if no trades
                    const winLossMessage = document.getElementById('winLossMessage');
                    if (wins === 0 && losses === 0) {
                        if (winLossMessage) winLossMessage.classList.remove('hidden');
                        const winLossChart = new Chart(winLossCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Winning Trades', 'Losing Trades'],
                                datasets: [{
                                    data: [1, 1], // Dummy data to show chart structure
                                    backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(239, 68, 68, 0.7)'],
                                    borderColor: ['rgba(34, 197, 94, 1)', 'rgba(239, 68, 68, 1)'],
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '60%',
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            usePointStyle: true,
                                            padding: 20,
                                            color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                            font: {
                                                size: 12
                                            }
                                        }
                                    },
                                    tooltip: {
                                        enabled: false
                                    }
                                }
                            }
                        });
                        chartInstances['winLossDistributionChart'] = winLossChart;
                    } else {
                        if (winLossMessage) winLossMessage.classList.add('hidden');
                        const winLossChart = new Chart(winLossCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Winning Trades', 'Losing Trades'],
                                datasets: [{
                                    data: [wins, losses],
                                    backgroundColor: ['rgba(34, 197, 94, 0.7)', 'rgba(239, 68, 68, 0.7)'],
                                    borderColor: ['rgba(34, 197, 94, 1)', 'rgba(239, 68, 68, 1)'],
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '60%',
                                plugins: {
                                    legend: {
                                        display: true,
                                        position: 'bottom',
                                        labels: {
                                            usePointStyle: true,
                                            padding: 20,
                                            color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                            font: {
                                                size: 12
                                            }
                                        }
                                    },
                                    tooltip: getContinuousTooltipConfig(themeColors, {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return `${label}: ${value} trades (${percentage}%)`;
                                            }
                                        }
                                    })
                                }
                            }
                        });
                        chartInstances['winLossDistributionChart'] = winLossChart;
                    }
                }
                
                // Performance by Day of Week Chart (P&L per day)
                const performanceCtx = getCtx('performanceByDayChart');
                if (performanceCtx) {
                    if (chartInstances['performanceByDayChart']) {
                        chartInstances['performanceByDayChart'].destroy();
                    }
                    
                    // Calculate P&L by day of the week
                    const dayPnlData = {
                        'Sunday': 0,
                        'Monday': 0,
                        'Tuesday': 0,
                        'Wednesday': 0,
                        'Thursday': 0,
                        'Friday': 0,
                        'Saturday': 0
                    };
                    
                    // Calculate P&L by day of the week
                    closedTrades.forEach(trade => {
                        if (trade.entry_date) {
                            const date = new Date(trade.entry_date);
                            const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                            const pnl = calculateNetPnl(trade);
                            if (dayPnlData.hasOwnProperty(dayName)) {
                                dayPnlData[dayName] += pnl;
                            }
                        }
                    });
                    
                    const dayLabels = Object.keys(dayPnlData);
                    const dayPnlValues = Object.values(dayPnlData);
                    
                    // If no trades, show sample data
                    if (dayPnlValues.every(val => val === 0)) {
                        dayPnlData['Monday'] = 2500;
                        dayPnlData['Tuesday'] = -800;
                        dayPnlData['Wednesday'] = 1200;
                        dayPnlData['Thursday'] = 3500;
                        dayPnlData['Friday'] = -500;
                        // Sunday and Saturday remain 0
                    }
                    
                    // Color bars based on profit/loss
                    const dayColors = Object.values(dayPnlData).map(pnl => 
                        pnl >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)'
                    );
                    const dayBorderColors = Object.values(dayPnlData).map(pnl => 
                        pnl >= 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)'
                    );
                    
                    const performanceChart = new Chart(performanceCtx, {
                        type: 'bar',
                        data: {
                            labels: dayLabels,
                            datasets: [{
                                label: 'P&L by Day',
                                data: Object.values(dayPnlData),
                                backgroundColor: dayColors,
                                borderColor: dayBorderColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y', // Horizontal bar chart
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 1.5,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    enabled: true,
                                    mode: 'point',
                                    intersect: true,
                                    position: 'nearest',
                                    backgroundColor: '#111827',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: 'rgba(255, 255, 255, 0.06)',
                                    borderWidth: 1,
                                    cornerRadius: 6,
                                    displayColors: false,
                                    padding: 12,
                                    titleFont: {
                                        size: 13,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    animation: {
                                        duration: 0
                                    },
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.x;
                                            return `P&L: ₹${value.toLocaleString()}`;
                                        }
                                    }
                                },
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString();
                                        },
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                y: {
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances['performanceByDayChart'] = performanceChart;
                }
                
                // Trade Distribution by Day of the Week Chart (Count of trades)
                const tradeDistributionCtx = getCtx('tradeDistributionChart');
                if (tradeDistributionCtx) {
                    if (chartInstances['tradeDistributionChart']) {
                        chartInstances['tradeDistributionChart'].destroy();
                    }
                    
                    // Calculate trades by day of the week
                    const dayData = {
                        'Sunday': 0,
                        'Monday': 0,
                        'Tuesday': 0,
                        'Wednesday': 0,
                        'Thursday': 0,
                        'Friday': 0,
                        'Saturday': 0
                    };
                    
                    // Count trades by day of the week
                    closedTrades.forEach(trade => {
                        if (trade.entry_date) {
                            const date = new Date(trade.entry_date);
                            const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                            if (dayData.hasOwnProperty(dayName)) {
                                dayData[dayName]++;
                            }
                        }
                    });
                    
                    const dayLabels = Object.keys(dayData);
                    const dayValues = Object.values(dayData);
                    
                    // If no trades, show sample data matching the image
                    if (dayValues.every(val => val === 0)) {
                        dayData['Monday'] = 6;
                        dayData['Tuesday'] = 12;
                        dayData['Wednesday'] = 6;
                        dayData['Thursday'] = 35;
                        dayData['Friday'] = 6;
                        // Sunday and Saturday remain 0
                    }
                    
                    const tradeDistributionChart = new Chart(tradeDistributionCtx, {
                        type: 'bar',
                        data: {
                            labels: dayLabels,
                            datasets: [{
                                label: 'Number of Trades',
                                data: Object.values(dayData),
                                backgroundColor: 'rgba(249, 115, 22, 0.7)', // Orange color matching the image
                                borderColor: 'rgba(249, 115, 22, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            indexAxis: 'y', // Horizontal bar chart
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 1.5,
                            interaction: {
                                intersect: true,
                                mode: 'point'
                            },
                            hover: {
                                mode: 'point',
                                intersect: true,
                                animationDuration: 0
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    enabled: true,
                                    mode: 'point',
                                    intersect: true,
                                    position: 'nearest',
                                    backgroundColor: '#111827',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: 'rgba(249, 115, 22, 1)',
                                    borderWidth: 1,
                                    cornerRadius: 6,
                                    displayColors: false,
                                    padding: 12,
                                    titleFont: {
                                        size: 13,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    animation: {
                                        duration: 0
                                    },
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label;
                                        },
                                        label: function(context) {
                                            const value = context.parsed.y; // Use 'y' for horizontal bars
                                            return `${value} trades`;
                                        }
                                    }
                                },
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        },
                                        stepSize: 1
                                    }
                                },
                                y: {
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances['tradeDistributionChart'] = tradeDistributionChart;
                }
                // Daily Win Rate Chart with comprehensive P&L analysis
                const dailyWinRateCtx = getCtx('dailyWinRateChart');
                const dailyWinRateMessage = document.getElementById('dailyWinRateMessage');
                if (dailyWinRateCtx && typeof Chart !== 'undefined') {
                    if (chartInstances['dailyWinRateChart']) {
                        chartInstances['dailyWinRateChart'].destroy();
                    }
                    
                    // Show loading message
                    if (dailyWinRateMessage) {
                        dailyWinRateMessage.classList.remove('hidden');
                        dailyWinRateMessage.textContent = 'Loading chart...';
                    }
                    
                    // Set a timeout to hide loading message if chart creation takes too long
                    const loadingTimeout = setTimeout(() => {
                        if (dailyWinRateMessage && !dailyWinRateMessage.classList.contains('hidden')) {
                            console.warn('Daily Win Rate Chart: Loading timeout, showing error message');
                            dailyWinRateMessage.textContent = 'Chart loading timeout - please refresh the page';
                        }
                    }, 10000); // 10 second timeout
                    
                    console.log('Creating Daily Win Rate Chart with closedTrades:', closedTrades.length);
                    
                    // Function to calculate daily win rate statistics
                    function calculateDailyWinRateStats(trades, date) {
                        const dayTrades = trades.filter(trade => {
                            const tradeDate = trade.exit_date ? new Date(trade.exit_date).toISOString().split('T')[0] : 
                                             new Date(trade.entry_date).toISOString().split('T')[0];
                            return tradeDate === date;
                        });
                        
                        let dailyWins = 0;
                        let dailyLosses = 0;
                        let dailyBreakeven = 0;
                        let totalTrades = dayTrades.length;
                        let totalWinAmount = 0;
                        let totalLossAmount = 0;
                        let netPnl = 0;
                        
                        dayTrades.forEach(trade => {
                            const pnl = calculateNetPnl(trade);
                            netPnl += pnl;
                            
                            if (pnl > 0) {
                                dailyWins++;
                                totalWinAmount += pnl;
                            } else if (pnl < 0) {
                                dailyLosses++;
                                totalLossAmount += pnl;
                            } else {
                                dailyBreakeven++;
                            }
                        });
                        
                        // Calculate win rate percentage (breakeven excluded)
                        const dailyRatePct = (dailyWins + dailyLosses) > 0 ? 
                            (dailyWins / (dailyWins + dailyLosses)) * 100 : 0;
                        
                        // Calculate average win/loss sizes
                        const avgWinSize = dailyWins > 0 ? totalWinAmount / dailyWins : 0;
                        const avgLossSize = dailyLosses > 0 ? totalLossAmount / dailyLosses : 0;
                        
                        return {
                            date,
                            dailyWins,
                            dailyLosses,
                            dailyBreakeven,
                            totalTrades,
                            dailyRatePct,
                            avgWinSize,
                            avgLossSize,
                            netPnl
                        };
                    }
                    
                    // Get all unique dates from trades
                    const allDates = new Set();
                    closedTrades.forEach(trade => {
                        if (trade.entry_date) {
                            const date = new Date(trade.entry_date);
                            const formattedDate = date.toISOString().split('T')[0];
                            allDates.add(formattedDate);
                        }
                        if (trade.exit_date) {
                            const date = new Date(trade.exit_date);
                            const formattedDate = date.toISOString().split('T')[0];
                            allDates.add(formattedDate);
                        }
                    });
                    
                    const sortedDates = Array.from(allDates).sort();
                    
                    // If no trades, create comprehensive demo data
                    let chartLabels, dailyWinRateData, tooltipData;
                    
                    if (sortedDates.length === 0) {
                        console.log('No trades found, using comprehensive demo data for Daily Win Rate Chart');
                        
                        // Demo dataset with realistic trading scenarios
                        const demoDates = [
                            '2024-06-28', '2024-07-02', '2024-07-09', '2024-07-11', '2024-07-12',
                            '2024-07-16', '2024-07-18', '2024-07-19', '2024-07-22', '2024-07-29',
                            '2024-07-30', '2024-07-31', '2024-08-06', '2024-08-07', '2024-08-09',
                            '2024-08-12', '2024-08-13', '2024-08-14', '2024-08-15', '2024-08-16',
                            '2024-08-20', '2024-08-21', '2024-08-28', '2024-08-29', '2024-08-30'
                        ];
                        
                        // Demo statistics for each date
                        const demoStats = [
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 1, losses: 0, breakeven: 0, total: 1, rate: 100, avgWin: 2500, avgLoss: 0, netPnl: 2500 },
                            { wins: 1, losses: 2, breakeven: 0, total: 3, rate: 33.33, avgWin: 1800, avgLoss: -1200, netPnl: -600 },
                            { wins: 1, losses: 0, breakeven: 0, total: 1, rate: 100, avgWin: 3200, avgLoss: 0, netPnl: 3200 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 2, losses: 1, breakeven: 0, total: 3, rate: 66.67, avgWin: 2100, avgLoss: -1500, netPnl: 2700 },
                            { wins: 1, losses: 0, breakeven: 0, total: 1, rate: 100, avgWin: 2800, avgLoss: 0, netPnl: 2800 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 1, losses: 1, breakeven: 0, total: 2, rate: 50, avgWin: 1900, avgLoss: -1100, netPnl: 800 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 2, losses: 1, breakeven: 0, total: 3, rate: 66.67, avgWin: 2200, avgLoss: -1800, netPnl: 2600 },
                            { wins: 3, losses: 1, breakeven: 0, total: 4, rate: 75, avgWin: 1950, avgLoss: -1400, netPnl: 4450 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 1, losses: 0, breakeven: 0, total: 1, rate: 100, avgWin: 3100, avgLoss: 0, netPnl: 3100 },
                            { wins: 1, losses: 1, breakeven: 0, total: 2, rate: 50, avgWin: 2400, avgLoss: -1600, netPnl: 800 },
                            { wins: 0, losses: 0, breakeven: 0, total: 0, rate: 0, avgWin: 0, avgLoss: 0, netPnl: 0 },
                            { wins: 1, losses: 2, breakeven: 0, total: 3, rate: 33.33, avgWin: 1700, avgLoss: -1300, netPnl: -900 },
                            { wins: 1, losses: 1, breakeven: 0, total: 2, rate: 50, avgWin: 2600, avgLoss: -1200, netPnl: 1400 },
                            { wins: 3, losses: 1, breakeven: 0, total: 4, rate: 75, avgWin: 2100, avgLoss: -1900, netPnl: 4400 }
                        ];
                        
                        chartLabels = demoDates.map(date => formatDateDDMMYYYY(date));
                        dailyWinRateData = demoStats.map(stat => stat.rate);
                        tooltipData = demoStats.map((stat, index) => ({
                            date: chartLabels[index],
                            dailyWins: stat.wins,
                            dailyLosses: stat.losses,
                            dailyBreakeven: stat.breakeven,
                            totalTrades: stat.total,
                            dailyRatePct: stat.rate,
                            avgWinSize: stat.avgWin,
                            avgLossSize: stat.avgLoss,
                            netPnl: stat.netPnl
                        }));
                    } else {
                        console.log('Processing actual trade data for Daily Win Rate Chart');
                        
                        // Process actual trade data
                        chartLabels = sortedDates.map(date => formatDateDDMMYYYY(date));
                        dailyWinRateData = [];
                        tooltipData = [];
                        
                        sortedDates.forEach(date => {
                            const stats = calculateDailyWinRateStats(closedTrades, date);
                            dailyWinRateData.push(stats.dailyRatePct);
                            tooltipData.push(stats);
                        });
                    }
                    
                    console.log('Creating Daily Win Rate Chart with data:', {
                        labels: chartLabels,
                        dailyWinRateData: dailyWinRateData,
                        labelsLength: chartLabels.length,
                        dataLength: dailyWinRateData.length
                    });
                    
                    // Ensure we have data to display
                    if (chartLabels.length === 0 || dailyWinRateData.length === 0) {
                        console.error('Daily Win Rate Chart: No data to display');
                        clearTimeout(loadingTimeout);
                        if (dailyWinRateMessage) {
                            dailyWinRateMessage.textContent = 'No data available';
                            dailyWinRateMessage.classList.remove('hidden');
                        }
                        return;
                    }
                    
                    // Validate data arrays
                    if (!Array.isArray(chartLabels) || !Array.isArray(dailyWinRateData)) {
                        console.error('Daily Win Rate Chart: Invalid data format', {
                            chartLabels: typeof chartLabels,
                            dailyWinRateData: typeof dailyWinRateData
                        });
                        clearTimeout(loadingTimeout);
                        if (dailyWinRateMessage) {
                            dailyWinRateMessage.textContent = 'Invalid data format';
                            dailyWinRateMessage.classList.remove('hidden');
                        }
                        return;
                    }
                    
                    // Ensure tooltipData is properly aligned with chart data
                    if (tooltipData.length !== chartLabels.length) {
                        console.warn('Daily Win Rate Chart: tooltipData length mismatch, adjusting...');
                        tooltipData = tooltipData.slice(0, chartLabels.length);
                    }
                    
                    try {
                        console.log('Creating Daily Win Rate Chart with config:', {
                            labels: chartLabels.length,
                            data: dailyWinRateData.length,
                            tooltipData: tooltipData.length,
                            ctx: !!dailyWinRateCtx
                        });
                        
                        
                        const dailyWinRateChart = new Chart(dailyWinRateCtx, {
                        type: 'line',
                        data: {
                            labels: chartLabels,
                            datasets: [
                                {
                                    label: 'Daily Win Rate',
                                    data: dailyWinRateData,
                                    borderColor: 'rgba(59, 130, 246, 1)',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    borderWidth: 2,
                                    fill: false,
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointHoverRadius: 6
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20,
                                        color: themeColors.chartText || '#212529',
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: getContinuousTooltipConfig(themeColors, {
                                    callbacks: {
                                        title: function(context) {
                                            const index = context[0].dataIndex;
                                            const data = tooltipData[index];
                                            return `Date: ${data.date}`;
                                        },
                                        label: function(context) {
                                            const index = context.dataIndex;
                                            const data = tooltipData[index];
                                            const lines = [
                                                `Win Rate: ${data.dailyRatePct.toFixed(2)}%`,
                                                `Wins/Losses: ${data.dailyWins}/${data.dailyLosses}`,
                                                `Breakeven: ${data.dailyBreakeven}`,
                                                `Total Trades: ${data.totalTrades}`,
                                                `Avg Win: ₹${data.avgWinSize.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`,
                                                `Avg Loss: ₹${data.avgLossSize.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`,
                                                `Net P&L: ₹${data.netPnl.toLocaleString('en-IN', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`
                                            ];
                                            return lines;
                                        }
                                    }
                                }),
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        },
                                        color: themeColors.chartText || '#212529',
                                        font: {
                                            size: 11
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(128, 128, 128, 0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: themeColors.chartText || '#212529',
                                        font: {
                                            size: 11
                                        },
                                        callback: function(value, index, ticks) {
                                            const label = this.getLabelForValue(value);
                                            if (label) {
                                                if (label.includes('-') && label.split('-').length === 3) {
                                                    return label;
                                                }
                                                const date = new Date(label);
                                                return date.toLocaleDateString('en-IN', { 
                                                    day: '2-digit', 
                                                    month: '2-digit', 
                                                    year: '2-digit' 
                                                });
                                            }
                                            return label;
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(128, 128, 128, 0.1)'
                                    }
                                }
                            }
                        }
                        });
                        chartInstances['dailyWinRateChart'] = dailyWinRateChart;
                        console.log('Daily Win Rate Chart created successfully:', dailyWinRateChart);
                        
                        // Clear the loading timeout
                        clearTimeout(loadingTimeout);
                        
                        // Hide loading message on success
                        if (dailyWinRateMessage) {
                            dailyWinRateMessage.classList.add('hidden');
                        }
                    } catch (error) {
                        console.error('Error creating Daily Win Rate Chart:', error);
                        console.error('Error details:', {
                            message: error.message,
                            stack: error.stack,
                            chartLabels: chartLabels,
                            dailyWinRateData: dailyWinRateData,
                            tooltipData: tooltipData,
                            themeColors: themeColors
                        });
                        
                        // Clear the loading timeout
                        clearTimeout(loadingTimeout);
                        
                        // Show error message
                        if (dailyWinRateMessage) {
                            dailyWinRateMessage.textContent = `Error loading chart: ${error.message}`;
                            dailyWinRateMessage.classList.remove('hidden');
                        }
                    }
                } else {
                    if (!dailyWinRateCtx) {
                        console.log('Daily Win Rate Chart canvas not found - canvas element missing');
                    } else if (typeof Chart === 'undefined') {
                        console.error('Chart.js not loaded - cannot create Daily Win Rate Chart');
                        if (dailyWinRateMessage) {
                            dailyWinRateMessage.textContent = 'Chart library not loaded';
                            dailyWinRateMessage.classList.remove('hidden');
                        }
                    }
                }
                
                // Strategy vs P&L Chart
                const strategyCtx = getCtx('strategyPnlChart');
                if (strategyCtx) {
                    if (chartInstances['strategyPnlChart']) {
                        chartInstances['strategyPnlChart'].destroy();
                    }
                    
                    // Calculate P&L by strategy
                    const strategyData = {};
                    closedTrades.forEach(trade => {
                        const strategy = trade.strategy || 'No Strategy';
                        const pnl = calculateNetPnl(trade);
                        if (!strategyData[strategy]) {
                            strategyData[strategy] = { totalPnl: 0, tradeCount: 0 };
                        }
                        strategyData[strategy].totalPnl += pnl;
                        strategyData[strategy].tradeCount += 1;
                    });
                    
                    let strategyLabels = Object.keys(strategyData);
                    let strategyPnlValues = strategyLabels.map(strategy => strategyData[strategy].totalPnl);
                    
                    // If no trades, show sample data matching the image
                    if (strategyLabels.length === 0) {
                        strategyLabels = ['Trend', 'Reversal', 'Breakout', 'Pullback'];
                        strategyPnlValues = [43000, 19000, 1500, 1200];
                    }
                    
                    // Use consistent purple color for all bars as shown in the image
                    const strategyColors = strategyLabels.map(() => 'rgba(147, 51, 234, 0.7)'); // purple-600 with opacity
                    const strategyBorderColors = strategyLabels.map(() => 'rgba(147, 51, 234, 1)'); // purple-600 solid
                    
                    const strategyChart = new Chart(strategyCtx, {
                        type: 'bar',
                        data: {
                            labels: strategyLabels,
                            datasets: [{
                                label: 'P&L by Strategy',
                                data: strategyPnlValues,
                                backgroundColor: strategyColors,
                                borderColor: strategyBorderColors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: { display: false },
                                tooltip: getContinuousTooltipConfig(themeColors, {
                                    borderColor: 'rgba(147, 51, 234, 1)',
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.y;
                                            return `P&L: ₹${value.toLocaleString()}`;
                                        },
                                        afterLabel: function(context) {
                                            const strategy = context.label;
                                            const data = strategyData[strategy];
                                            if (data && data.tradeCount > 0) {
                                                return `Trades: ${data.tradeCount}`;
                                            }
                                            return '';
                                        }
                                    }
                                }),
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString();
                                        },
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                x: {
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        maxRotation: 0,
                                        minRotation: 0,
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances['strategyPnlChart'] = strategyChart;
                }
                
                // Monthly Commission/Charges Chart
                const monthlyChargesCtx = getCtx('monthlyChargesChart');
                if (monthlyChargesCtx) {
                    if (chartInstances['monthlyChargesChart']) {
                        chartInstances['monthlyChargesChart'].destroy();
                    }
                    
                    // Calculate monthly charges from trades
                    const monthlyChargesData = {};
                    closedTrades.forEach(trade => {
                        if (trade.exit_date) {
                            const date = new Date(trade.exit_date);
                            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                            
                            const brokerage = trade.brokerage || 0;
                            const otherFees = trade.other_fees || 0;
                            const totalCharges = brokerage + otherFees;
                            
                            if (!monthlyChargesData[monthKey]) {
                                monthlyChargesData[monthKey] = { 
                                    totalCharges: 0, 
                                    brokerage: 0, 
                                    otherFees: 0, 
                                    tradeCount: 0 
                                };
                            }
                            
                            monthlyChargesData[monthKey].totalCharges += totalCharges;
                            monthlyChargesData[monthKey].brokerage += brokerage;
                            monthlyChargesData[monthKey].otherFees += otherFees;
                            monthlyChargesData[monthKey].tradeCount += 1;
                        }
                    });
                    
                    const sortedMonths = Object.keys(monthlyChargesData).sort();
                    const labels = sortedMonths.length > 0 ? sortedMonths.map(month => {
                        // Convert "2024-01" to "JAN 2024"
                        const [year, monthNum] = month.split('-');
                        const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                                          'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
                        const monthName = monthNames[parseInt(monthNum) - 1];
                        return `${monthName} ${year}`;
                    }) : [];
                    
                    const totalChargesData = sortedMonths.length > 0 ? sortedMonths.map(month => monthlyChargesData[month].totalCharges) : [];
                    const brokerageData = sortedMonths.length > 0 ? sortedMonths.map(month => monthlyChargesData[month].brokerage) : [];
                    const otherFeesData = sortedMonths.length > 0 ? sortedMonths.map(month => monthlyChargesData[month].otherFees) : [];
                    
                    // If no data, show sample data
                    if (totalChargesData.length === 0) {
                        labels.push('JAN 2024', 'FEB 2024', 'MAR 2024', 'APR 2024');
                        totalChargesData.push(1200, 1800, 1500, 2100);
                        brokerageData.push(800, 1200, 1000, 1400);
                        otherFeesData.push(400, 600, 500, 700);
                    }
                    
                    const monthlyChargesChart = new Chart(monthlyChargesCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Brokerage',
                                    data: brokerageData,
                                    backgroundColor: 'rgba(239, 68, 68, 0.7)', // Red for brokerage
                                    borderColor: 'rgba(239, 68, 68, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Charges',
                                    data: otherFeesData,
                                    backgroundColor: 'rgba(245, 158, 11, 0.7)', // Amber for charges                                                                                                         
                                    borderColor: 'rgba(245, 158, 11, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            aspectRatio: 2,
                            plugins: {
                                legend: { 
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                tooltip: {
                                    enabled: true,
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: '#111827',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: 'rgba(255, 255, 255, 0.06)',
                                    borderWidth: 1,
                                    cornerRadius: 6,
                                    displayColors: false,
                                    padding: 12,
                                    titleFont: {
                                        size: 13,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    animation: {
                                        duration: 0
                                    },
                                    callbacks: {
                                        title: function(context) {
                                            const monthKey = sortedMonths[context[0].dataIndex];
                                            return monthKey;
                                        },
                                        label: function(context) {
                                            // Only show custom content for the first dataset to avoid duplication
                                            if (context.datasetIndex === 0) {
                                                const monthKey = sortedMonths[context.dataIndex];
                                                const data = monthlyChargesData[monthKey];
                                                if (data && data.tradeCount > 0) {
                                                    return [
                                                        `Brokerage: ₹${data.brokerage.toLocaleString()}`,
                                                        `Charges: ₹${data.otherFees.toLocaleString()}`,
                                                        `Trades: ${data.tradeCount}`,
                                                        `Total Charges: ₹${data.totalCharges.toLocaleString()}`
                                                    ];
                                                }
                                            }
                                            return ''; // Hide default dataset labels
                                        }
                                    }
                                },
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    stacked: true,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '₹' + value.toLocaleString();
                                        },
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                x: {
                                    stacked: true,
                                    grid: { 
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 0,
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 11
                                        }
                                    }
                                }
                            }
                        }
                    });
                    chartInstances['monthlyChargesChart'] = monthlyChargesChart;
                }
                
                // Net P&L by Mood Chart
                const netPnlByMoodCtx = getCtx('netPnlByMoodChart');
                const netPnlByMoodMessage = document.getElementById('netPnlByMoodMessage');
                if (netPnlByMoodCtx) {
                    if (chartInstances['netPnlByMoodChart']) {
                        chartInstances['netPnlByMoodChart'].destroy();
                    }
                    
                    // Show loading message
                    if (netPnlByMoodMessage) {
                        netPnlByMoodMessage.classList.remove('hidden');
                    }
                    
                    // Get trades to analyze (use filtered trades if available, otherwise all trades)
                    const tradesToAnalyze = appState.trades || [];
                    
                    // Calculate Net P&L by mood
                    const moodPnl = {};
                    const moodTradeCounts = {};
                    
                    // Define all possible moods
                    const allMoods = ['Calm', 'Confident', 'Neutral', 'Anxious', 'Panicked', 'Excited', 'Frustrated', 'Greedy', 'Fearful'];
                    
                    // Initialize all moods with zero values
                    allMoods.forEach(mood => {
                        moodPnl[mood] = 0;
                        moodTradeCounts[mood] = 0;
                    });
                    
                    // Calculate P&L for each mood
                    tradesToAnalyze.forEach(trade => {
                        if (trade.emotionalState && trade.exit_date && trade.exit_price) {
                            const pnl = calculateNetPnl(trade);
                            moodPnl[trade.emotionalState] = (moodPnl[trade.emotionalState] || 0) + pnl;
                            moodTradeCounts[trade.emotionalState] = (moodTradeCounts[trade.emotionalState] || 0) + 1;
                        }
                    });
                    
                    // Filter out moods with no trades and sort by P&L
                    const moodData = Object.entries(moodPnl)
                        .filter(([mood, pnl]) => moodTradeCounts[mood] > 0)
                        .sort(([,a], [,b]) => b - a); // Sort by P&L descending
                    
                    if (moodData.length === 0) {
                        // Show message if no mood data
                        if (netPnlByMoodMessage) {
                            if (appState.trades.length === 0) {
                                netPnlByMoodMessage.textContent = 'No trades found. Add some trades first.';
                            } else {
                                netPnlByMoodMessage.textContent = 'No emotional state data found. Select emotional state while adding trades to see analysis.';
                            }
                            netPnlByMoodMessage.classList.remove('hidden');
                        }
                        return;
                    }
                    
                    const labels = moodData.map(([mood]) => mood);
                    const data = moodData.map(([, pnl]) => pnl);
                    const tradeCounts = moodData.map(([mood]) => moodTradeCounts[mood]);
                    
                    // Hide loading message
                    if (netPnlByMoodMessage) {
                        netPnlByMoodMessage.classList.add('hidden');
                    }
                    
                    const netPnlByMoodChart = new Chart(netPnlByMoodCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Net P&L',
                                data: data,
                                backgroundColor: data.map(pnl => pnl >= 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                                borderColor: data.map(pnl => pnl >= 0 ? 'rgba(16, 185, 129, 1)' : 'rgba(239, 68, 68, 1)'),
                                borderWidth: 1,
                                borderRadius: 4,
                                borderSkipped: false,
                            }]
                        },
                        options: {
                            indexAxis: 'y', // Horizontal bar chart
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: '#111827',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: 'rgba(255, 255, 255, 0.06)',
                                    borderWidth: 1,
                                    cornerRadius: 6,
                                    padding: 12,
                                    titleFont: {
                                        size: 13,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    animation: {
                                        duration: 0
                                    },
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label;
                                        },
                                        label: function(context) {
                                            const pnl = context.parsed.x;
                                            const mood = context.label;
                                            const tradeCount = moodTradeCounts[mood];
                                            return `Net P&L: ${formatCurrency(pnl)}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 12
                                        },
                                        callback: function(value) {
                                            return formatCurrency(value);
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    title: {
                                        display: false
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 12
                                        }
                                    },
                                    grid: {
                                        display: false
                                    },
                                    title: {
                                        display: false
                                    }
                                }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });
                    
                    chartInstances['netPnlByMoodChart'] = netPnlByMoodChart;
                }
                
                // Most Common Mistakes Chart
                const mostCommonMistakesCtx = getCtx('mostCommonMistakesChart');
                const mostCommonMistakesMessage = document.getElementById('mostCommonMistakesMessage');
                if (mostCommonMistakesCtx) {
                    if (chartInstances['mostCommonMistakesChart']) {
                        chartInstances['mostCommonMistakesChart'].destroy();
                    }
                    
                    // Show loading message
                    if (mostCommonMistakesMessage) {
                        mostCommonMistakesMessage.classList.remove('hidden');
                    }
                    
                    // Calculate mistakes from trades in the last month
                    const oneMonthAgo = new Date();
                    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
                    
                    console.log('All trades in appState:', appState.trades.length);
                    console.log('One month ago date:', oneMonthAgo);
                    
                    // Include ALL trades (both open and closed) from the last month
                    const recentTrades = appState.trades.filter(trade => {
                        if (!trade.entry_date) {
                            console.log('Trade without entry_date:', trade);
                            return false;
                        }
                        const tradeDate = new Date(trade.entry_date);
                        const isRecent = tradeDate >= oneMonthAgo;
                        console.log('Trade date:', trade.entry_date, 'isRecent:', isRecent);
                        return isRecent;
                    });
                    
                    // Count mistakes
                    const mistakeCounts = {};
                    console.log('Recent trades for mistakes analysis:', recentTrades.length);
                    
                    // If no recent trades, use all trades for debugging
                    let tradesToAnalyze = recentTrades.length > 0 ? recentTrades : appState.trades;
                    console.log('Trades to analyze:', tradesToAnalyze.length);
                    
                    // For testing: if no trades at all, create some demo data
                    if (tradesToAnalyze.length === 0) {
                        console.log('No trades found, creating demo data for testing');
                        tradesToAnalyze = [
                            {
                                id: 'demo1',
                                entry_date: new Date().toISOString().split('T')[0],
                                mistakes: ['Exited Too Early', 'FOMO Entry']
                            },
                            {
                                id: 'demo2', 
                                entry_date: new Date().toISOString().split('T')[0],
                                mistakes: ['Exited Too Early', 'Ignored Stop Loss']
                            },
                            {
                                id: 'demo3',
                                entry_date: new Date().toISOString().split('T')[0],
                                mistakes: ['Overtrading']
                            }
                        ];
                    }
                    
                    tradesToAnalyze.forEach(trade => {
                        console.log('Trade mistakes:', trade.mistakes, 'Trade ID:', trade.id);
                        if (trade.mistakes && Array.isArray(trade.mistakes)) {
                            trade.mistakes.forEach(mistake => {
                                if (mistake !== 'No Mistakes') { // Exclude "No Mistakes" from the chart
                                    mistakeCounts[mistake] = (mistakeCounts[mistake] || 0) + 1;
                                }
                            });
                        }
                    });
                    
                    console.log('Mistake counts:', mistakeCounts);
                    
                    // Sort mistakes by count (descending) and take top 5
                    const sortedMistakes = Object.entries(mistakeCounts)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 5);
                    
                    if (sortedMistakes.length === 0) {
                        // Show message if no mistakes data
                        if (mostCommonMistakesMessage) {
                            if (appState.trades.length === 0) {
                                mostCommonMistakesMessage.textContent = 'No trades found. Add some trades first.';
                            } else if (recentTrades.length === 0) {
                                mostCommonMistakesMessage.textContent = `No trades found in the last month. Found ${appState.trades.length} total trades.`;
                            } else {
                                mostCommonMistakesMessage.textContent = 'No mistakes recorded in recent trades. Select mistakes while adding trades to see analysis.';
                            }
                            mostCommonMistakesMessage.classList.remove('hidden');
                        }
                        
                        return;
                    }
                    
                    const labels = sortedMistakes.map(([mistake]) => mistake);
                    const data = sortedMistakes.map(([, count]) => count);
                    
                    // Hide loading message
                    if (mostCommonMistakesMessage) {
                        mostCommonMistakesMessage.classList.add('hidden');
                    }
                    
                    const mostCommonMistakesChart = new Chart(mostCommonMistakesCtx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Number of Trades',
                                data: data,
                                backgroundColor: 'rgba(239, 68, 68, 0.8)', // Red color matching the image
                                borderColor: 'rgba(239, 68, 68, 1)',
                                borderWidth: 1,
                                borderRadius: 4,
                                borderSkipped: false,
                            }]
                        },
                        options: {
                            indexAxis: 'y', // Horizontal bar chart
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: '#111827',
                                    titleColor: '#ffffff',
                                    bodyColor: '#ffffff',
                                    borderColor: 'rgba(255, 255, 255, 0.06)',
                                    borderWidth: 1,
                                    cornerRadius: 6,
                                    padding: 12,
                                    titleFont: {
                                        size: 13,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    animation: {
                                        duration: 0
                                    },
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label;
                                        },
                                        label: function(context) {
                                            return `${context.parsed.x} trades`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 12
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(128, 128, 128, 0.1)',
                                        drawBorder: false
                                    },
                                    title: {
                                        display: false
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: (themeColors || getThemeColors()).chartText || (themeColors || getThemeColors()).textColor,
                                        font: {
                                            size: 12
                                        }
                                    },
                                    grid: {
                                        display: false
                                    },
                                    title: {
                                        display: false
                                    }
                                }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeInOutQuart'
                            }
                        }
                    });
                    
                    chartInstances['mostCommonMistakesChart'] = mostCommonMistakesChart;
                }
                
                // Challenge Progress Chart is handled by updateChallengeProgress function
                // No need to create it here as it's already created in the challenge section
            } catch (e) {
                console.error('renderAllCharts error', e);
            }
        };
        
        // --- FORM LOGIC (ALL FILLED IN) ---
        const tradeForm = document.getElementById('manual-trade-form');
        const updateCalculations = () => {
            const entryPrice = parseFloat(document.getElementById('entry-price').value) || 0;
            const qty = parseFloat(document.getElementById('quantity').value) || 0;
            const exitPrice = parseFloat(document.getElementById('exit-price').value) || 0;
            const exitQuantity = parseFloat(document.getElementById('exit-quantity').value) || 0;
            const stopLoss = parseFloat(document.getElementById('stop-loss').value) || 0;
            const target = parseFloat(document.getElementById('target').value) || 0;
            const brokerage = parseFloat(document.getElementById('brokerage').value) || 0;
            const otherFees = parseFloat(document.getElementById('other-fees').value) || 0;
            
            // Calculate total amount
            const total = entryPrice * qty;
            
            // Get direction from active button or default to Long
            const direction = document.querySelector('#direction-group .active')?.dataset?.value || 'Long';
            const directionMultiplier = direction === 'Short' ? -1 : 1;
            
            // Calculate stop loss percentage (adjusted for short positions)
            let stopLossPercent = (entryPrice && stopLoss) ? 
                ((stopLoss - entryPrice) / entryPrice) * 100 : 0;
            
            // Calculate target percentage (adjusted for short positions)
            let targetPercent = (entryPrice && target) ? 
                ((target - entryPrice) / entryPrice) * 100 : 0;
            
            // For short positions, invert the percentages to show correct perspective
            if (direction === 'Short') {
                stopLossPercent = -stopLossPercent;  // Higher stop loss = negative % (loss)
                targetPercent = -targetPercent;      // Lower target = positive % (profit)
            }
            const exitQty = exitQuantity > 0 ? exitQuantity : qty; // Use exit quantity if specified, otherwise full quantity
            const grossPnl = (exitPrice && exitQty) ? (exitPrice - entryPrice) * exitQty * directionMultiplier : 0;
            
            // Calculate net P&L (after brokerage and charges)
            const totalCharges = brokerage + otherFees;
            const netPnl = grossPnl - totalCharges;
            
            // Calculate P&L percentage based on total investment and total return
            // This shows the actual return percentage on the total investment
            // For partial exits: shows what percentage of total investment was returned
            const totalInvestment = entryPrice * qty; // Always use full entry quantity for total investment
            const pnlPct = (entryPrice && qty && exitPrice) ? (netPnl / totalInvestment) * 100 : 0;
            
            // Update total amount
            const totalEl = document.getElementById('total-amount');
            if (totalEl) totalEl.textContent = formatCurrency(total);
            
            // Update stop loss percentage (adjusted for short positions)
            const stopLossPercentEl = document.getElementById('stop-loss-percent');
            if (stopLossPercentEl) {
                if (stopLoss && entryPrice) {
                    stopLossPercentEl.textContent = `(${stopLossPercent >= 0 ? '+' : ''}${stopLossPercent.toFixed(2)}%)`;
                    // Now both Long and Short use the same logic since percentages are inverted for Short
                    stopLossPercentEl.style.color = stopLossPercent < 0 ? '#ef4444' : '#22c55e';
                } else {
                    stopLossPercentEl.textContent = '';
                }
            }
            
            // Update target percentage (adjusted for short positions)
            const targetPercentEl = document.getElementById('target-percent');
            if (targetPercentEl) {
                if (target && entryPrice) {
                    targetPercentEl.textContent = `(${targetPercent >= 0 ? '+' : ''}${targetPercent.toFixed(2)}%)`;
                    // Now both Long and Short use the same logic since percentages are inverted for Short
                    targetPercentEl.style.color = targetPercent > 0 ? '#22c55e' : '#ef4444';
                } else {
                    targetPercentEl.textContent = '';
                }
            }
            
            // Update Gross P&L
            const grossPnlEl = document.getElementById('gross-pnl-amount');
            if (grossPnlEl) {
                grossPnlEl.textContent = formatCurrency(grossPnl);
                grossPnlEl.style.color = grossPnl >= 0 ? '#22c55e' : '#ef4444';
            }
            
            // Update Total Charges
            const totalChargesEl = document.getElementById('total-charges');
            if (totalChargesEl) {
                totalChargesEl.textContent = formatCurrency(totalCharges);
            }
            
            // Update Net P&L Amount (after charges)
            const pnlAmtEl = document.getElementById('pnl-amount');
            if (pnlAmtEl) {
                pnlAmtEl.textContent = formatCurrency(netPnl);
                pnlAmtEl.style.color = netPnl >= 0 ? '#22c55e' : '#ef4444';
            }
            
            // Update P&L Percentage
            const pnlPctEl = document.getElementById('pnl-percent');
            if (pnlPctEl) {
                pnlPctEl.textContent = `${pnlPct.toFixed(2)}%`;
                pnlPctEl.style.color = pnlPct >= 0 ? '#22c55e' : '#ef4444';
            }
        };
        const clearTradeForm = () => {
            if (!tradeForm) return;
            tradeForm.reset();
            
            // Reset button groups to default active states
            document.querySelectorAll('.form-btn-group').forEach(group => {
                group.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active', 'active-long', 'active-short', 'active-green');
                });
            });
            
            // Set default active buttons with proper classes
            const longBtn = document.querySelector('#direction-group button[data-value="Long"]');
            const equityBtn = document.querySelector('#segment-group button[data-value="Equity"]');
            const intradayBtn = document.querySelector('#trading-style-group button[data-value="Intraday"]');
            
            if (longBtn) {
                longBtn.classList.add('active', 'active-long');
            }
            if (equityBtn) {
                equityBtn.classList.add('active', 'active-green');
            }
            if (intradayBtn) {
                intradayBtn.classList.add('active', 'active-green');
            }
            
            // Clear Psychology fields
            const emotionalStateSelect = document.getElementById('emotional-state');
            if (emotionalStateSelect) {
                emotionalStateSelect.value = '';
            }
            
            // Clear all mistake checkboxes
            document.querySelectorAll('input[name="mistakes"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateCalculations();
        };
        // Add event listeners for all calculation inputs
        const calculationInputs = [
            'entry-price', 'quantity', 'exit-price', 'exit-quantity', 'stop-loss', 'target', 
            'brokerage', 'other-fees'
        ];
        
        calculationInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', updateCalculations);
                input.addEventListener('change', updateCalculations);
            }
        });
        
        // Also listen to form input events as fallback
        tradeForm.addEventListener('input', e => {
            updateCalculations();
        });
        // Button group functionality
        const setupButtonGroups = () => {
            const groups = document.querySelectorAll('.form-btn-group');
            console.log('Found button groups:', groups.length);
            
            groups.forEach(group => {
                console.log('Setting up group:', group.id);
                group.addEventListener('click', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('Group clicked:', group.id, 'Target:', e.target);
                    
                    const btn = e.target.closest('button');
                    if (!btn || btn.tagName !== 'BUTTON') {
                        console.log('No button found or not a button element');
                        return;
                    }
                    
                    console.log('Button clicked:', btn.dataset.value, 'in group:', group.id);
                    
                    // Remove active class from all buttons in this group
                    group.querySelectorAll('button').forEach(b => {
                        b.classList.remove('active', 'active-long', 'active-short', 'active-green');
                    });
                    
                    // Add active class to clicked button
                    btn.classList.add('active');
                    
                    // Add specific classes for direction buttons
                    if (group.id === 'direction-group') {
                        if (btn.dataset.value === 'Long') {
                            btn.classList.add('active-long');
                        } else if (btn.dataset.value === 'Short') {
                            btn.classList.add('active-short');
                        }
                    } else {
                        btn.classList.add('active-green');
                    }
                    
                    // Update form calculations
                    updateCalculations();
                    
                    console.log('Button state updated:', btn.className);
                });
            });
        };
        
        // Setup button groups will be called on DOM ready
        
        document.getElementById('clear-trade-form-btn').addEventListener('click', clearTradeForm);
        tradeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = new FormData(tradeForm);
            // Collect mistakes made (checkboxes)
            const mistakes = [];
            document.querySelectorAll('input[name="mistakes"]:checked').forEach(checkbox => {
                mistakes.push(checkbox.value);
            });
            
            const trade = {
                id: document.getElementById('trade-id').value || `${Date.now()}`,
                asset: form.get('asset') || '',
                direction: document.querySelector('#direction-group .active')?.dataset?.value || form.get('direction') || 'Long',
                segment: document.querySelector('#segment-group .active')?.dataset?.value || form.get('segment') || 'Equity',
                trading_style: document.querySelector('#trading-style-group .active')?.dataset?.value || form.get('tradingStyle') || 'Intraday',
                entry_date: (form.get('entryDate') && form.get('entryTime')) ? `${form.get('entryDate')}T${form.get('entryTime')}` : '',
                entry_price: parseFloat(form.get('entryPrice')) || 0,
                quantity: parseFloat(form.get('quantity')) || 0,
                stop_loss: form.get('stopLoss') ? parseFloat(form.get('stopLoss')) : null,
                target: form.get('target') ? parseFloat(form.get('target')) : null,
                exit_date: (form.get('exitDate') && form.get('exitTime')) ? `${form.get('exitDate')}T${form.get('exitTime')}` : '',
                exit_price: form.get('exitPrice') ? parseFloat(form.get('exitPrice')) : null,
                exit_quantity: form.get('exitQuantity') ? parseFloat(form.get('exitQuantity')) : null,
                brokerage: form.get('brokerage') ? parseFloat(form.get('brokerage')) : 0,
                other_fees: form.get('otherFees') ? parseFloat(form.get('otherFees')) : 0,
                strategy: form.get('strategy') || '',
                outcomeSummary: form.get('outcomeSummary') || '',
                reasons: form.get('reasons') || '',
                emotionalState: form.get('emotionalState') || '',
                mistakes: mistakes
            };
            try {
                await dataStore.upsertTrade(trade);
                appState.trades = await dataStore.getTrades();
                clearTradeForm();
                renderDashboard();
                renderTradeHistory();
                feather.replace();
                showTradeSavedModal();
            } catch (err) {
                console.error('Failed to save trade', err);
                showToast('Failed to save trade. Please try again.', 'error');
            }
        });

        // --- INITIAL LOAD ---
        applyTheme();
        feather.replace();
        // Ensure export buttons are wired on initial load as well
        wireCsvButtons();
        
        // Wait for Chart.js to load, then render charts
        setTimeout(() => {
            if (typeof Chart !== 'undefined') {
                renderAllCharts();
            } else {
                console.warn('Chart.js not loaded, retrying...');
                setTimeout(() => renderAllCharts(), 1000);
            }
        }, 500);

        // --- DEMO DATA CONTROLS ---
        const seedBtn = document.getElementById('seed-demo-data');
        const clearBtn = document.getElementById('clear-demo-data');
        const setKeysBtn = document.getElementById('set-supabase-keys');

        // Supabase client and datastore
        let sbClient = null;
        const initSupabase = () => {
            const url = localStorage.getItem('SUPABASE_URL');
            const key = localStorage.getItem('SUPABASE_ANON_KEY');
            if (window.supabase && url && key) {
                sbClient = window.supabase.createClient(url, key);
            } else {
                sbClient = null;
            }
        };
        initSupabase();

        const dataStore = {
            async getTrades() {
                if (sbClient) {
                    const { data, error } = await sbClient.from('trades').select('*').order('entry_date', { ascending: true });
                    if (!error) return data || [];
                }
                return JSON.parse(localStorage.getItem('trades') || '[]') || [];
            },
            async upsertTrade(trade) {
                if (sbClient) {
                    const { error } = await sbClient.from('trades').upsert(trade);
                    if (!error) return true;
                }
                const arr = await this.getTrades();
                const idx = arr.findIndex(x => String(x.id) === String(trade.id));
                if (idx >= 0) arr[idx] = trade; else arr.push(trade);
                localStorage.setItem('trades', JSON.stringify(arr));
                return true;
            },
            async deleteTrade(id) {
                if (sbClient) {
                    await sbClient.from('trades').delete().eq('id', id);
                }
                const arr = await this.getTrades();
                const updated = arr.filter(x => String(x.id) !== String(id));
                localStorage.setItem('trades', JSON.stringify(updated));
                return true;
            },
            async getLedger() {
                if (sbClient) {
                    const { data, error } = await sbClient.from('ledger').select('*').order('date', { ascending: true });
                    if (!error) return data || [];
                }
                return JSON.parse(localStorage.getItem('ledger') || '[]') || [];
            },
            async upsertLedger(entry) {
                if (sbClient) {
                    const { error } = await sbClient.from('ledger').upsert(entry);
                    if (!error) return true;
                }
                const arr = await this.getLedger();
                const idx = arr.findIndex(x => String(x.id) === String(entry.id));
                if (idx >= 0) arr[idx] = entry; else arr.push(entry);
                localStorage.setItem('ledger', JSON.stringify(arr));
                return true;
            },
            async deleteLedger(id) {
                if (sbClient) {
                    await sbClient.from('ledger').delete().eq('id', id);
                }
                const arr = await this.getLedger();
                const updated = arr.filter(x => String(x.id) !== String(id));
                localStorage.setItem('ledger', JSON.stringify(updated));
                return true;
            }
        };
        seedBtn?.addEventListener('click', () => {
            try {
                const now = new Date();
                const makeDate = (daysAgo) => {
                    const date = new Date(now.getFullYear(), now.getMonth(), now.getDate() - daysAgo, 10, 0, 0);
                    return formatDateDDMMYYYY(date.toISOString());
                };
                const trades = [
                    { id: 't1', asset:'NIFTY', direction:'Long', entry_date: makeDate(10), entry_price:22000, quantity:50, exit_date: makeDate(9), exit_price:22120, brokerage:20, other_fees:10, strategy:'Trend Following', trading_style:'Scalping', outcomeSummary:'Target Hit', reasons:'', stop_loss:21950 },
                    { id: 't2', asset:'RELIANCE', direction:'Short', entry_date: makeDate(8), entry_price:3050, quantity:20, exit_date: makeDate(7), exit_price:3000, brokerage:15, other_fees:5, strategy:'Price Action', trading_style:'Intraday', outcomeSummary:'Stop Loss Hit', reasons:'', stop_loss:3070 },
                    { id: 't3', asset:'HDFCBANK', direction:'Long', entry_date: makeDate(6), entry_price:1550, quantity:30, exit_date: makeDate(5), exit_price:1565, brokerage:12, other_fees:4, strategy:'Breakout', trading_style:'Swing', outcomeSummary:'Exited Early (Profit)', reasons:'' },
                    { id: 't4', asset:'INFY', direction:'Long', entry_date: makeDate(3), entry_price:1450, quantity:25, exit_date: makeDate(2), exit_price:1440, brokerage:10, other_fees:3, strategy:'Other', trading_style:'Position', outcomeSummary:'Exited Early (Loss)', reasons:'' }
                ];
                const ledger = [
                    { id:'l1', type:'Deposit', amount:100000, date:formatDateDDMMYYYY(new Date(now.getFullYear(), now.getMonth(), 1).toISOString()), notes:'Initial' },
                    { id:'l2', type:'Withdrawal', amount:5000, date:formatDateDDMMYYYY(new Date(now.getFullYear(), now.getMonth(), 15).toISOString()), notes:'Partial' }
                ];
                localStorage.setItem('trades', JSON.stringify(trades));
                localStorage.setItem('ledger', JSON.stringify(ledger));
                appState.trades = trades;
                appState.ledger = ledger;
                renderDashboard();
                renderTradeHistory();
                renderFundManagement();
                renderStatement();
                renderReports();
                renderCalendar();
                showToast('Demo data seeded.', 'success');
            } catch (e) { console.error('seed failed', e); }
        });
        clearBtn?.addEventListener('click', () => {
            try {
                localStorage.removeItem('trades');
                localStorage.removeItem('ledger');
                appState.trades = [];
                appState.ledger = [];
                renderDashboard();
                renderTradeHistory();
                renderFundManagement();
                renderStatement();
                renderReports();
                renderCalendar();
                showToast('All data cleared.', 'success');
            } catch (e) { console.error('clear failed', e); }
        });
        setKeysBtn?.addEventListener('click', async () => {
            const url = prompt('Enter SUPABASE_URL');
            if (!url) return;
            const key = prompt('Enter SUPABASE_ANON_KEY');
            if (!key) return;
            localStorage.setItem('SUPABASE_URL', url);
            localStorage.setItem('SUPABASE_ANON_KEY', key);
            initSupabase();
            showToast('Supabase keys saved. Data will sync on next actions.', 'success');
        });

        // --- CHALLENGE MODAL LOGIC ---
        const challengeModal = document.getElementById('challenge-modal');
        const challengeForm = document.getElementById('challenge-form');
        const setChallengeBtn = document.getElementById('set-challenge-btn');
        const setChallengeBtnInactive = document.getElementById('set-challenge-btn-inactive');

        const openChallengeModal = () => {
            challengeForm.reset();
            challengeModal.classList.remove('hidden');
        };

        const closeChallengeModal = () => {
            challengeModal.classList.add('hidden');
        };

        // Wire challenge buttons
        setChallengeBtn?.addEventListener('click', openChallengeModal);
        setChallengeBtnInactive?.addEventListener('click', openChallengeModal);
        document.querySelectorAll('#challenge-modal .close-modal-btn').forEach(btn => 
            btn.addEventListener('click', closeChallengeModal));

        // Handle challenge form submission
        challengeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const startingCapital = parseFloat(document.getElementById('starting-capital').value) || 0;
            const targetCapital = parseFloat(document.getElementById('target-capital').value) || 0;
            const timeframe = parseInt(document.getElementById('timeframe').value) || 30;
            const maxRisk = parseFloat(document.getElementById('max-risk').value) || 2;

            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + timeframe);

            const challenge = {
                id: `challenge_${Date.now()}`,
                startingCapital,
                targetCapital,
                timeframe,
                maxRisk,
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString(),
                completed: false,
                success: false
            };

            try {
                // Save active challenge
                localStorage.setItem('activeChallenge', JSON.stringify(challenge));
                
                // Add to history
                const history = JSON.parse(localStorage.getItem('challengeHistory') || '[]');
                history.push(challenge);
                localStorage.setItem('challengeHistory', JSON.stringify(history));

                closeChallengeModal();
                renderChallenge();
                renderChallengeHistory();
                showToast('Challenge set successfully!', 'success');
            } catch (err) {
                console.error('Failed to save challenge', err);
                showToast('Failed to save challenge. Please try again.', 'error');
            }
        });

        // Initialize info tooltips functionality
        const initializeInfoTooltips = () => {
            const tooltipTriggers = document.querySelectorAll('.info-tooltip-trigger');
            
            tooltipTriggers.forEach(trigger => {
                const tooltip = trigger.nextElementSibling;
                
                // Click to show/hide tooltip
                trigger.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Hide all other tooltips
                    document.querySelectorAll('.info-tooltip').forEach(t => {
                        if (t !== tooltip) {
                            t.classList.remove('show');
                        }
                    });
                    
                    // Toggle current tooltip
                    tooltip.classList.toggle('show');
                });
                
                // Hide tooltip when clicking outside
                document.addEventListener('click', (e) => {
                    if (!trigger.contains(e.target) && !tooltip.contains(e.target)) {
                        tooltip.classList.remove('show');
                    }
                });
                
                // Hide tooltip on escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        tooltip.classList.remove('show');
                    }
                });
            });
        };

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, setting up button groups...');
            setupButtonGroups();
            
            // Initialize info tooltips
            initializeInfoTooltips();
            
            // Initialize default button states
            setTimeout(() => {
                document.querySelector('#direction-group button[data-value="Long"]')?.classList.add('active', 'active-long');
                document.querySelector('#segment-group button[data-value="Equity"]')?.classList.add('active', 'active-green');
                document.querySelector('#trading-style-group button[data-value="Intraday"]')?.classList.add('active', 'active-green');
                console.log('Default button states initialized');
            }, 200);
        });

        // External Tooltip Support for Chart.js
        const externalTooltipHandler = (context) => {
            const { chart, tooltip } = context;
            const tooltipEl = document.getElementById('chartjs-custom-tooltip');

            // Hide if no tooltip
            if (tooltip.opacity === 0) {
                tooltipEl.style.opacity = '0';
                tooltipEl.setAttribute('aria-hidden', 'true');
                return;
            }

            // Set caret Position
            tooltipEl.classList.remove('above', 'below', 'no-transform');
            if (tooltip.yAlign) {
                tooltipEl.classList.add(tooltip.yAlign);
            }

            // Set Text
            if (tooltip.body) {
                const titleLines = tooltip.title || [];
                const bodyLines = tooltip.body.map(b => b.lines);

                let innerHtml = '';

                titleLines.forEach(title => {
                    innerHtml += `<div class="tooltip-title">${title}</div>`;
                });

                bodyLines.forEach((body, i) => {
                    const colors = tooltip.labelColors[i];
                    let style = `background:${colors.backgroundColor}`;
                    style += `; border-color:${colors.borderColor}`;
                    style += `; border-width: 2px`;
                    const span = `<span class="tooltip-color" style="${style}"></span>`;
                    innerHtml += `<div class="tooltip-body">${span}${body}</div>`;
                });

                tooltipEl.innerHTML = innerHtml;
            }

            const position = Chart.helpers.getRelativePosition(tooltip.caretX, tooltip.caretY, chart);
            tooltipEl.style.left = position.x + tooltip.caretX + 'px';
            tooltipEl.style.top = position.y + tooltip.caretY + 'px';
            tooltipEl.style.opacity = '1';
            tooltipEl.setAttribute('aria-hidden', 'false');
        };

        // Touch and Mouse Event Handlers for Tooltips
        const setupTooltipEvents = () => {
            const tooltipEl = document.getElementById('chartjs-custom-tooltip');
            
            // Hide tooltip on mouseout
            document.addEventListener('mouseout', (e) => {
                if (!e.relatedTarget || !e.relatedTarget.closest('canvas')) {
                    tooltipEl.style.opacity = '0';
                    tooltipEl.setAttribute('aria-hidden', 'true');
                }
            });

            // Touch support
            document.addEventListener('touchstart', (e) => {
                if (e.target.closest('canvas')) {
                    // Touch events will be handled by Chart.js
                }
            });

            // Hide tooltip on blur
            document.addEventListener('blur', () => {
                tooltipEl.style.opacity = '0';
                tooltipEl.setAttribute('aria-hidden', 'true');
            });
        };

        // Initialize tooltip events
        setupTooltipEvents();

        // Exit Trade Modal Functions
        let currentExitTrade = null;

        const showExitTradeModal = (trade) => {
            currentExitTrade = trade;
            const modal = document.getElementById('exit-trade-modal');
            
            // Populate trade details
            document.getElementById('exit-trade-symbol').textContent = trade.asset || 'Unknown';
            document.getElementById('exit-trade-type').value = trade.direction || 'Long';
            document.getElementById('exit-trade-quantity').value = trade.quantity || 0;
            document.getElementById('exit-trade-entry-price').value = trade.entry_price || 0;
            document.getElementById('exit-trade-stop-loss').value = trade.stop_loss || 0;
            document.getElementById('exit-trade-target').value = trade.target || 0;
            document.getElementById('exit-trade-total-amount').value = formatCurrency((trade.entry_price || 0) * (trade.quantity || 0));
            
            // Set default exit quantity to full quantity
            document.getElementById('exit-trade-exit-quantity').value = trade.quantity || 0;
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('exit-trade-date').value = today;
            
            // Clear exit fields
            document.getElementById('exit-trade-price').value = '';
            document.getElementById('exit-trade-brokerage').value = '';
            document.getElementById('exit-trade-charges').value = '';
            
            // Clear additional fields
            document.getElementById('exit-strategy').value = trade.strategy || 'Price Action';
            document.getElementById('exit-outcome-summary').value = 'Select Outcome Summary';
            document.getElementById('exit-emotional-state').value = '';
            document.getElementById('exit-trade-notes').value = '';
            
            // Clear mistake checkboxes
            document.querySelectorAll('input[name="exit-mistakes"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Clear P&L calculations
            document.getElementById('exit-gross-pnl').value = '₹0.00';
            document.getElementById('exit-total-charges').value = '₹0.00';
            document.getElementById('exit-net-pnl').value = '₹0.00';
            document.getElementById('exit-pnl-percentage').value = '0.00%';
            
            modal.classList.remove('hidden');
        };

        const hideExitTradeModal = () => {
            const modal = document.getElementById('exit-trade-modal');
            modal.classList.add('hidden');
            currentExitTrade = null;
        };

        const updateExitCalculations = () => {
            if (!currentExitTrade) return;
            
            const entryPrice = parseFloat(currentExitTrade.entry_price) || 0;
            const quantity = parseFloat(currentExitTrade.quantity) || 0;
            const exitPrice = parseFloat(document.getElementById('exit-trade-price').value) || 0;
            const exitQuantity = parseFloat(document.getElementById('exit-trade-exit-quantity').value) || 0;
            const brokerage = parseFloat(document.getElementById('exit-trade-brokerage').value) || 0;
            const charges = parseFloat(document.getElementById('exit-trade-charges').value) || 0;
            
            if (entryPrice && exitPrice && exitQuantity) {
                const directionMultiplier = currentExitTrade.direction === 'Short' ? -1 : 1;
                const grossPnl = (exitPrice - entryPrice) * exitQuantity * directionMultiplier;
                const totalCharges = brokerage + charges;
                const netPnl = grossPnl - totalCharges;
                const totalInvestment = entryPrice * quantity; // Always use full quantity for percentage
                const pnlPercentage = totalInvestment > 0 ? (netPnl / totalInvestment) * 100 : 0;
                
                document.getElementById('exit-gross-pnl').value = formatCurrency(grossPnl);
                document.getElementById('exit-total-charges').value = formatCurrency(totalCharges);
                document.getElementById('exit-net-pnl').value = formatCurrency(netPnl);
                document.getElementById('exit-pnl-percentage').value = `${pnlPercentage.toFixed(2)}%`;
            }
        };

        // Event listeners for exit trade modal
        document.addEventListener('DOMContentLoaded', () => {
            const exitModal = document.getElementById('exit-trade-modal');
            const exitCloseBtn = document.getElementById('exit-trade-close');
            const exitCancelBtn = document.getElementById('exit-trade-cancel');
            const exitSubmitBtn = document.getElementById('exit-trade-submit');
            
            // Close modal events
            exitCloseBtn?.addEventListener('click', hideExitTradeModal);
            exitCancelBtn?.addEventListener('click', hideExitTradeModal);
            
            // Close modal when clicking outside
            exitModal?.addEventListener('click', (e) => {
                if (e.target === exitModal) {
                    hideExitTradeModal();
                }
            });
            
            // Real-time calculations
            const calculationInputs = ['exit-trade-price', 'exit-trade-exit-quantity', 'exit-trade-brokerage', 'exit-trade-charges'];
            calculationInputs.forEach(id => {
                document.getElementById(id)?.addEventListener('input', updateExitCalculations);
            });
            
            // Submit exit trade
            exitSubmitBtn?.addEventListener('click', async () => {
                if (!currentExitTrade) return;
                
                const exitDate = document.getElementById('exit-trade-date').value;
                const exitTime = document.getElementById('exit-trade-time').value;
                const exitPrice = parseFloat(document.getElementById('exit-trade-price').value);
                const exitQuantity = parseFloat(document.getElementById('exit-trade-exit-quantity').value);
                const brokerage = parseFloat(document.getElementById('exit-trade-brokerage').value) || 0;
                const charges = parseFloat(document.getElementById('exit-trade-charges').value) || 0;
                
                if (!exitDate || !exitPrice || !exitQuantity) {
                    alert('Please fill in all required fields (Exit Date, Exit Price, Exit Quantity)');
                    return;
                }
                
                if (exitQuantity > currentExitTrade.quantity) {
                    alert('Exit quantity cannot be greater than the original quantity');
                    return;
                }
                
                try {
                    // Prepare exit data
                    const exitData = {
                        ...currentExitTrade,
                        exit_date: (exitDate && exitTime) ? `${exitDate}T${exitTime}` : exitDate,
                        exit_price: exitPrice,
                        exit_quantity: exitQuantity,
                        brokerage: brokerage,
                        other_fees: charges,
                        strategy: document.getElementById('exit-strategy').value,
                        outcomeSummary: document.getElementById('exit-outcome-summary').value,
                        emotionalState: document.getElementById('exit-emotional-state').value,
                        reasons: document.getElementById('exit-trade-notes').value,
                        mistakes: Array.from(document.querySelectorAll('input[name="exit-mistakes"]:checked')).map(cb => cb.value)
                    };
                    
                    // Determine if it's a partial exit
                    const isPartialExit = exitQuantity < currentExitTrade.quantity;
                    
                    if (isPartialExit) {
                        // For partial exit, update the existing trade
                        await dataStore.upsertTrade(exitData);
                        showToast('Partial exit recorded successfully!', 'success');
                    } else {
                        // For full exit, mark as closed
                        exitData.status = 'Closed';
                        await dataStore.upsertTrade(exitData);
                        showToast('Trade exited successfully!', 'success');
                    }
                    
                    // Refresh data
                    appState.trades = await dataStore.getTrades();
                    renderTradeHistory();
                    renderDashboard();
                    renderFundManagement();
                    
                    hideExitTradeModal();
                } catch (error) {
                    console.error('Error exiting trade:', error);
                    showToast('Error exiting trade. Please try again.', 'error');
                }
            });
        });

        // Partial Exit Details Modal
        const showPartialExitDetailsModal = (trade) => {
            const modal = document.getElementById('partial-exit-details-modal');
            if (!modal) {
                // Create modal if it doesn't exist
                createPartialExitDetailsModal();
            }
            
            // Populate symbol
            document.getElementById('partial-exit-symbol').textContent = trade.asset || 'Unknown';
            
            // For now, we'll simulate multiple exits since we don't have a separate exits table
            // In a real implementation, you'd have a separate table for partial exits
            const exits = [];
            
            // If this is a partial exit trade, create exit data
            if (trade.exit_quantity && trade.exit_quantity > 0) {
                const exitQty = trade.exit_quantity;
                const entryPrice = trade.entry_price || 0;
                const exitPrice = trade.exit_price || 0;
                const directionMultiplier = trade.direction === 'Short' ? -1 : 1;
                
                // Calculate P&L for this exit
                const grossPnl = (exitPrice - entryPrice) * exitQty * directionMultiplier;
                const totalCharges = (trade.brokerage || 0) + (trade.other_fees || 0);
                const netPnl = grossPnl - totalCharges;
                const totalInvestment = entryPrice * trade.quantity; // Use full quantity for percentage calculation
                const pnlPercentage = totalInvestment > 0 ? (netPnl / totalInvestment) * 100 : 0;
                
                exits.push({
                    date: trade.exit_date || '—',
                    price: exitPrice,
                    quantity: exitQty,
                    pnl: netPnl,
                    pnlPercentage: pnlPercentage
                });
            }
            
            // Update exit count
            document.getElementById('partial-exit-count').textContent = `${exits.length} Exit${exits.length !== 1 ? 's' : ''}`;
            
            // Calculate summary
            const totalExited = exits.reduce((sum, exit) => sum + exit.quantity, 0);
            const remaining = (trade.quantity || 0) - totalExited;
            const cumulativePnl = exits.reduce((sum, exit) => sum + exit.pnl, 0);
            
            // Update summary
            document.getElementById('partial-exit-total-exited').textContent = `${totalExited} units`;
            document.getElementById('partial-exit-remaining').textContent = `${remaining} units`;
            document.getElementById('partial-exit-cumulative-pnl').textContent = formatCurrency(cumulativePnl);
            
            // Color code cumulative P&L
            const cumulativePnlElement = document.getElementById('partial-exit-cumulative-pnl');
            if (cumulativePnl > 0) {
                cumulativePnlElement.style.color = '#10b981'; // Green for profit
            } else if (cumulativePnl < 0) {
                cumulativePnlElement.style.color = '#ef4444'; // Red for loss
            } else {
                cumulativePnlElement.style.color = 'var(--text-primary)'; // Default color
            }
            
            // Populate exits table
            const tableBody = document.getElementById('partial-exit-table-body');
            if (exits.length > 0) {
                tableBody.innerHTML = exits.map(exit => {
                    const pnlColor = exit.pnl > 0 ? '#10b981' : exit.pnl < 0 ? '#ef4444' : 'var(--text-primary)';
                    const pnlSign = exit.pnl > 0 ? '+' : '';
                    const pnlPercentageSign = exit.pnlPercentage > 0 ? '+' : '';
                    
                    return `
                        <tr>
                            <td class="px-4 py-3 text-sm" style="color: var(--text-primary);">${exit.date}</td>
                            <td class="px-4 py-3 text-sm" style="color: var(--text-primary);">₹${exit.price.toFixed(2)}</td>
                            <td class="px-4 py-3 text-sm" style="color: var(--text-primary);">${exit.quantity}</td>
                            <td class="px-4 py-3 text-sm font-semibold" style="color: ${pnlColor};">${pnlSign}₹${exit.pnl.toFixed(2)}</td>
                            <td class="px-4 py-3 text-sm font-semibold" style="color: ${pnlColor};">${pnlPercentageSign}${exit.pnlPercentage.toFixed(3)}%</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-sm" style="color: var(--text-secondary);">
                            No exits recorded
                        </td>
                    </tr>
                `;
            }
            
            modal.classList.remove('hidden');
        };

        const createPartialExitDetailsModal = () => {
            const modalHTML = `
                <div id="partial-exit-details-modal" class="modal-overlay hidden">
                    <div class="modal-content max-w-4xl" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                        <!-- Header -->
                        <div class="flex justify-between items-center mb-6 pb-4 border-b" style="border-color: var(--border-color);">
                            <div class="flex items-center space-x-3">
                                <h2 class="text-2xl font-bold" style="color: var(--text-primary);">Partial Exit Breakdown</h2>
                                <span id="partial-exit-symbol" class="px-3 py-1 text-sm font-semibold rounded-full" style="background-color: var(--bg-secondary); color: var(--text-primary);"></span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span id="partial-exit-count" class="px-2 py-1 text-xs font-semibold rounded-full" style="background-color: var(--bg-secondary); color: var(--text-primary);">0 Exits</span>
                                <button id="partial-exit-close" class="p-2 rounded-full hover:bg-gray-100" style="color: var(--text-secondary);">
                                    <i data-feather="x" class="h-5 w-5"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Summary Section -->
                        <div class="mb-6 p-4 rounded-lg" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
                            <div class="grid grid-cols-3 gap-6">
                                <div class="text-center">
                                    <p class="text-sm font-medium mb-1" style="color: var(--text-secondary);">Total Exited</p>
                                    <p id="partial-exit-total-exited" class="text-lg font-bold" style="color: var(--text-primary);">0 units</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm font-medium mb-1" style="color: var(--text-secondary);">Remaining</p>
                                    <p id="partial-exit-remaining" class="text-lg font-bold" style="color: var(--text-primary);">0 units</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm font-medium mb-1" style="color: var(--text-secondary);">Cumulative P&L</p>
                                    <p id="partial-exit-cumulative-pnl" class="text-lg font-bold" style="color: var(--text-primary);">₹0.00</p>
                                </div>
                            </div>
                        </div>

                        <!-- Exits Table -->
                        <div class="rounded-lg overflow-hidden" style="border: 1px solid var(--border-color);">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead style="background-color: var(--bg-secondary);">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Exit Date</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Price</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">Quantity</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">P&L</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">P&L %</th>
                                        </tr>
                                    </thead>
                                    <tbody id="partial-exit-table-body" class="divide-y" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                                        <!-- Exit rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end mt-6 pt-4 border-t" style="border-color: var(--border-color);">
                            <button id="partial-exit-close-btn" class="px-4 py-2 text-sm font-medium text-white rounded-md hover:bg-gray-600" style="background-color: var(--text-primary);">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add event listeners
            document.getElementById('partial-exit-close')?.addEventListener('click', () => {
                document.getElementById('partial-exit-details-modal').classList.add('hidden');
            });
            document.getElementById('partial-exit-close-btn')?.addEventListener('click', () => {
                document.getElementById('partial-exit-details-modal').classList.add('hidden');
            });
            document.getElementById('partial-exit-details-modal')?.addEventListener('click', (e) => {
                if (e.target.id === 'partial-exit-details-modal') {
                    document.getElementById('partial-exit-details-modal').classList.add('hidden');
                }
            });
        };

        // Date Filter Functionality (Optimized for Speed)
        document.addEventListener('DOMContentLoaded', function() {
            const dateFilter = document.getElementById('dateFilter');
            const customDateRange = document.getElementById('customDateRange');
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            // Cache for performance optimization
            let lastFilterValue = 'all-time';
            let cachedFilteredTrades = null;
            // Show/hide custom date range inputs and refresh data instantly
            dateFilter.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customDateRange.classList.remove('hidden');
                } else {
                    customDateRange.classList.add('hidden');
                }
                // Instant data refresh when filter changes
                refreshDashboardData();
            });

            // Handle custom date range changes with instant updates
            startDate.addEventListener('change', function() {
                if (dateFilter.value === 'custom') {
                    refreshDashboardData();
                }
            });

            endDate.addEventListener('change', function() {
                if (dateFilter.value === 'custom') {
                    refreshDashboardData();
                }
            });

            // Function to get date range based on selected filter
            function getDateRange() {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                switch (dateFilter.value) {
                    case 'today':
                        return {
                            start: today,
                            end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                        };
                    case 'yesterday':
                        const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                        return {
                            start: yesterday,
                            end: new Date(yesterday.getTime() + 24 * 60 * 60 * 1000 - 1)
                        };
                    case 'last-7-days':
                        return {
                            start: new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000),
                            end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                        };
                    case 'last-30-days':
                        return {
                            start: new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000),
                            end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                        };
                    case 'last-3-months':
                        const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, now.getDate());
                        return {
                            start: threeMonthsAgo,
                            end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                        };
                    case 'last-6-months':
                        const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, now.getDate());
                        return {
                            start: sixMonthsAgo,
                            end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                        };
                    case 'last-1-year':
                        const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
                        return {
                            start: oneYearAgo,
                            end: new Date(today.getTime() + 24 * 60 * 60 * 1000 - 1)
                        };
                    case 'custom':
                        if (startDate.value && endDate.value) {
                            return {
                                start: new Date(startDate.value),
                                end: new Date(endDate.value + 'T23:59:59')
                            };
                        }
                        return null;
                    case 'all-time':
                    default:
                        return null; // No date filtering
                }
            }

            // Function to refresh dashboard data based on date filter (optimized for speed)
            function refreshDashboardData() {
                const currentFilterValue = dateFilter.value;
                
                // Use cache if filter hasn't changed
                if (currentFilterValue === lastFilterValue && cachedFilteredTrades) {
                    updateDashboardStats(cachedFilteredTrades);
                    updateCharts(cachedFilteredTrades);
                    return;
                }
                
                const dateRange = getDateRange();
                
                // Filter trades based on date range
                const filteredTrades = filterTradesByDateRange(dateRange);
                
                // Cache the results
                lastFilterValue = currentFilterValue;
                cachedFilteredTrades = filteredTrades;
                
                // Update dashboard stats instantly
                updateDashboardStats(filteredTrades);
                
                // Update charts with optimized rendering
                updateCharts(filteredTrades);
            }

            // Function to filter trades by date range
            function filterTradesByDateRange(dateRange) {
                const trades = appState.trades || [];
                if (!dateRange) {
                    return trades; // Return all trades if no date range
                }

                return trades.filter(trade => {
                    const tradeDate = new Date(trade.exit_date || trade.entry_date);
                    return tradeDate >= dateRange.start && tradeDate <= dateRange.end;
                });
            }

            // Function to update dashboard stats
            function updateDashboardStats(filteredTrades) {
                // Only consider closed trades (with exit_date and exit_price)
                const closedTrades = filteredTrades.filter(t => t.exit_price && t.exit_date);
                
                // Calculate stats from filtered trades
                let netPnl = 0, grossProfit = 0, grossLoss = 0, wins = 0, losses = 0;
                
                closedTrades.forEach(trade => {
                    const pnl = calculateNetPnl(trade);
                    netPnl += pnl;
                    if (pnl > 0) {
                        wins++;
                        grossProfit += pnl;
                    } else if (pnl < 0) {
                        losses++;
                        grossLoss += Math.abs(pnl);
                    }
                });
                
                const totalTrades = closedTrades.length;
                const winRate = totalTrades > 0 ? (wins / totalTrades * 100).toFixed(1) : 0;
                const profitFactor = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : (grossProfit > 0 ? '∞' : '0.00');
                const avgWin = wins > 0 ? (grossProfit / wins).toFixed(2) : '0.00';
                const avgLoss = losses > 0 ? (grossLoss / losses).toFixed(2) : '0.00';
                const avgWinLoss = totalTrades > 0 ? (netPnl / totalTrades).toFixed(2) : '0.00';

                // Update DOM elements
                const netPnlEl = document.getElementById('db-net-pnl');
                if (netPnlEl) {
                    netPnlEl.textContent = formatCurrency(netPnl);
                    netPnlEl.className = `text-2xl font-bold mt-2 ${netPnl >= 0 ? 'text-green-500' : 'text-red-500'}`;
                }
                
                const totalTradesEl = document.getElementById('db-total-trades');
                if (totalTradesEl) totalTradesEl.textContent = `${totalTrades} trades`;
                
                const winRateEl = document.getElementById('db-win-rate');
                if (winRateEl) winRateEl.textContent = `${winRate}%`;
                
                const wonTradesEl = document.getElementById('db-won-trades');
                if (wonTradesEl) wonTradesEl.textContent = `${wins} won`;
                
                const lostTradesEl = document.getElementById('db-lost-trades');
                if (lostTradesEl) lostTradesEl.textContent = `${losses} lost`;
                
                const profitFactorEl = document.getElementById('db-profit-factor');
                if (profitFactorEl) profitFactorEl.textContent = profitFactor;
                
                const avgWinLossEl = document.getElementById('db-avg-win-loss');
                if (avgWinLossEl) avgWinLossEl.textContent = avgWinLoss;
                
                // Update account summary with filtered data
                updateAccountSummary(filteredTrades, netPnl);
            }
            
            // Function to update account summary with filtered data
            function updateAccountSummary(filteredTrades, netPnl) {
                const ledger = appState.ledger || [];
                const deposits = ledger.filter(l => l.type === 'deposit').reduce((sum, l) => sum + (l.amount || 0), 0);
                const withdrawals = ledger.filter(l => l.type === 'withdrawal').reduce((sum, l) => sum + (l.amount || 0), 0);
                const deployedCapital = filteredTrades.filter(t => t.exit_price && t.exit_date).reduce((sum, t) => sum + (t.quantity * t.entry_price), 0);
                
                const accountValue = deposits - withdrawals + netPnl;
                const availableCash = Math.max(0, accountValue - deployedCapital);
                
                // Calculate open risk percentage and amount from active trades (same as Fund Management)
                const openRiskData = (() => {
                    const activeTrades = filteredTrades.filter(trade => !trade.exit_date || !trade.exit_price);
                    if (activeTrades.length === 0) return { percentage: 0, amount: 0 };
                    
                    const totalRiskAmount = activeTrades.reduce((total, trade) => {
                        // Risk is the potential loss if trade goes against us
                        // For Long: risk = entry_price * quantity (if price goes to 0)
                        // For Short: risk = (current_price - entry_price) * quantity (if price goes to infinity)
                        const tradeValue = trade.entry_price * trade.quantity;
                        return total + tradeValue;
                    }, 0);
                    
                    const totalAccountValue = accountValue > 0 ? accountValue : 1; // Avoid division by zero
                    const percentage = (totalRiskAmount / totalAccountValue) * 100;
                    
                    return { percentage, amount: totalRiskAmount };
                })();
                
                const summaryEl = document.getElementById('db-account-summary');
                if (summaryEl) {
                    const txt = "text-2xl font-bold";
                    summaryEl.innerHTML = `
                        <div><p class="text-sm" style="color: var(--text-secondary);">NET ACCOUNT VALUE</p><p class="${txt} ${accountValue >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(accountValue)}</p></div>
                        <div><p class="text-sm" style="color: var(--text-secondary);">NET REALIZED P&L</p><p class="${txt} ${netPnl >= 0 ? 'text-green-500' : 'text-red-500'}">${formatCurrency(netPnl)}</p></div>
                        <div><p class="text-sm" style="color: var(--text-secondary);">AVAILABLE CASH</p><p class="${txt}">${formatCurrency(availableCash)}</p></div>
                        <div><p class="text-sm" style="color: var(--text-secondary);">DEPLOYED CAPITAL</p><p class="${txt}">${formatCurrency(deployedCapital)}</p></div>
                        <div><p class="text-sm" style="color: var(--text-secondary);">TOTAL DEPOSITS</p><p class="${txt}">${formatCurrency(deposits)}</p></div>
                        <div><p class="text-sm" style="color: var(--text-secondary);">TOTAL WITHDRAWN</p><p class="${txt}">${formatCurrency(withdrawals)}</p></div>
                        <div><p class="text-sm" style="color: var(--text-secondary);">STARTING BALANCE</p><p class="${txt}">₹0.00</p></div>
                        <div><p class="text-sm font-medium" style="color: var(--text-secondary);">TOTAL OPEN RISK <span class="text-xs">(${openRiskData.percentage.toFixed(1)}%)</span></p><p class="${txt}">${formatCurrency(openRiskData.amount)}</p></div>`;
                }
            }

            // Function to update charts with filtered data (optimized)
            function updateCharts(filteredTrades) {
                // Only update charts if they exist and are initialized
                if (typeof renderAllCharts === 'function' && chartInstances) {
                    // Store the filtered trades temporarily for chart rendering
                    const originalTrades = appState.trades;
                    appState.trades = filteredTrades;
                    
                    // Re-render all charts with filtered data
                    renderAllCharts();
                    
                    // Restore original trades
                    appState.trades = originalTrades;
                }
            }

            // Function to clear cache when new data is available
            function clearFilterCache() {
                cachedFilteredTrades = null;
                lastFilterValue = null;
            }
            
            // Initialize with default "All Time" selection
            dateFilter.value = 'all-time';
            lastFilterValue = 'all-time';
            
            // Clear cache when trades data changes (for real-time updates)
            const originalUpdateTradeDependentUI = window.updateTradeDependentUI;
            if (originalUpdateTradeDependentUI) {
                window.updateTradeDependentUI = function() {
                    clearFilterCache();
                    return originalUpdateTradeDependentUI.apply(this, arguments);
                };
            }
        });

        // Tab functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tradeTab = document.getElementById('trade-tab');
            const journalTab = document.getElementById('journal-tab');
            const tradeTabContent = document.getElementById('trade-tab-content');
            const journalTabContent = document.getElementById('journal-tab-content');
            
            if (tradeTab && journalTab && tradeTabContent && journalTabContent) {
                // Set initial state - Trade tab active
                tradeTab.style.backgroundColor = 'var(--bg-primary)';
                tradeTab.style.color = 'var(--text-primary)';
                journalTab.style.backgroundColor = 'transparent';
                journalTab.style.color = 'var(--text-secondary)';
                tradeTabContent.classList.remove('hidden');
                journalTabContent.classList.add('hidden');
                
                // Trade tab click handler
                tradeTab.addEventListener('click', function() {
                    tradeTab.style.backgroundColor = 'var(--bg-primary)';
                    tradeTab.style.color = 'var(--text-primary)';
                    journalTab.style.backgroundColor = 'transparent';
                    journalTab.style.color = 'var(--text-secondary)';
                    tradeTabContent.classList.remove('hidden');
                    journalTabContent.classList.add('hidden');
                });
                
                // Journal tab click handler
                journalTab.addEventListener('click', function() {
                    journalTab.style.backgroundColor = 'var(--bg-primary)';
                    journalTab.style.color = 'var(--text-primary)';
                    tradeTab.style.backgroundColor = 'transparent';
                    tradeTab.style.color = 'var(--text-secondary)';
                    journalTabContent.classList.remove('hidden');
                    tradeTabContent.classList.add('hidden');
                });
            }
        });


    </script>

    <!-- Exit Trade Modal -->
    <div id="exit-trade-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-5xl" style="background-color: var(--bg-primary); border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 pb-4 border-b" style="border-color: var(--border-color);">
                <div class="flex items-center space-x-3">
                    <h2 id="exit-trade-title" class="text-2xl font-bold" style="color: var(--text-primary);">Exit Trade</h2>
                    <span id="exit-trade-symbol" class="px-3 py-1 text-sm font-semibold rounded-full" style="background-color: var(--bg-secondary); color: var(--text-primary);"></span>
                    <span id="exit-trade-status" class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Open</span>
                </div>
                <button id="exit-trade-close" class="p-2 rounded-full hover:bg-gray-100" style="color: var(--text-secondary);">
                    <i data-feather="x" class="h-5 w-5"></i>
                </button>
            </div>

            <!-- Main Content -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Trade Details (Left Column) -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold" style="color: var(--text-primary);">Trade Details</h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Type</label>
                                <input type="text" id="exit-trade-type" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Quantity</label>
                                <input type="text" id="exit-trade-quantity" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Entry Price</label>
                                <input type="text" id="exit-trade-entry-price" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Stop Loss</label>
                                <input type="text" id="exit-trade-stop-loss" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Target Price</label>
                                <input type="text" id="exit-trade-target" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Total Amount</label>
                                <input type="text" id="exit-trade-total-amount" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Exit Details (Middle Column) -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold" style="color: var(--text-primary);">Exit Details</h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Exit Date</label>
                                <input type="date" id="exit-trade-date" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Exit Time</label>
                                <input type="time" id="exit-trade-time" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Exit Price</label>
                            <input type="number" id="exit-trade-price" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);" step="0.01" placeholder="Enter exit price">
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Exit Quantity</label>
                            <input type="number" id="exit-trade-exit-quantity" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);" step="1" placeholder="Enter exit quantity">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Brokerage</label>
                                <input type="number" id="exit-trade-brokerage" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);" step="0.01" placeholder="0">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Charges</label>
                                <input type="number" id="exit-trade-charges" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);" step="0.01" placeholder="0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- P&L Summary (Right Column) -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold" style="color: var(--text-primary);">P&L Summary</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Gross P&L</label>
                            <input type="text" id="exit-gross-pnl" class="w-full px-3 py-2 text-sm border rounded-md font-semibold" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Total Charges</label>
                            <input type="text" id="exit-total-charges" class="w-full px-3 py-2 text-sm border rounded-md font-semibold" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Net P&L Amount</label>
                            <input type="text" id="exit-net-pnl" class="w-full px-3 py-2 text-sm border rounded-md font-semibold" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">P&L (%)</label>
                            <input type="text" id="exit-pnl-percentage" class="w-full px-3 py-2 text-sm border rounded-md font-semibold" style="background-color: var(--bg-secondary); border-color: var(--border-color); color: var(--text-primary);" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Fields -->
            <div class="mt-6 pt-6 border-t" style="border-color: var(--border-color);">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Strategy Tag</label>
                        <select id="exit-strategy" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
                            <option value="Price Action">Price Action</option>
                            <option value="Support/Resistance">Support/Resistance</option>
                            <option value="Trend Following">Trend Following</option>
                            <option value="Breakout">Breakout</option>
                            <option value="Reversal">Reversal</option>
                            <option value="Scalping">Scalping</option>
                            <option value="Swing Trading">Swing Trading</option>
                            <option value="News Trading">News Trading</option>
                            <option value="Technical Analysis">Technical Analysis</option>
                            <option value="Fundamental Analysis">Fundamental Analysis</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Outcome Summary</label>
                        <select id="exit-outcome-summary" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
                            <option value="Select Outcome Summary">Select Outcome Summary</option>
                            <option value="Target Hit">Target Hit</option>
                            <option value="Stop Loss Hit">Stop Loss Hit</option>
                            <option value="Exited Early (Profit)">Exited Early (Profit)</option>
                            <option value="Exited Early (Loss)">Exited Early (Loss)</option>
                            <option value="Break Even">Break Even</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Emotional State</label>
                        <select id="exit-emotional-state" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
                            <option value="">Select Emotional State</option>
                            <option value="Confident">Confident</option>
                            <option value="Nervous">Nervous</option>
                            <option value="Excited">Excited</option>
                            <option value="Fearful">Fearful</option>
                            <option value="Greedy">Greedy</option>
                            <option value="Calm">Calm</option>
                            <option value="Frustrated">Frustrated</option>
                            <option value="Overconfident">Overconfident</option>
                            <option value="Indecisive">Indecisive</option>
                            <option value="Patient">Patient</option>
                            <option value="Impatient">Impatient</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Mistakes Made</label>
                        <div class="grid grid-cols-1 gap-1 max-h-20 overflow-y-auto">
                            <label class="flex items-center text-xs">
                                <input type="checkbox" name="exit-mistakes" value="FOMO" class="mr-2 h-3 w-3">
                                <span style="color: var(--text-primary);">FOMO</span>
                            </label>
                            <label class="flex items-center text-xs">
                                <input type="checkbox" name="exit-mistakes" value="Revenge Trading" class="mr-2 h-3 w-3">
                                <span style="color: var(--text-primary);">Revenge Trading</span>
                            </label>
                            <label class="flex items-center text-xs">
                                <input type="checkbox" name="exit-mistakes" value="Overtrading" class="mr-2 h-3 w-3">
                                <span style="color: var(--text-primary);">Overtrading</span>
                            </label>
                            <label class="flex items-center text-xs">
                                <input type="checkbox" name="exit-mistakes" value="No Stop Loss" class="mr-2 h-3 w-3">
                                <span style="color: var(--text-primary);">No Stop Loss</span>
                            </label>
                            <label class="flex items-center text-xs">
                                <input type="checkbox" name="exit-mistakes" value="Emotional Trading" class="mr-2 h-3 w-3">
                                <span style="color: var(--text-primary);">Emotional Trading</span>
                            </label>
                            <label class="flex items-center text-xs">
                                <input type="checkbox" name="exit-mistakes" value="Poor Risk Management" class="mr-2 h-3 w-3">
                                <span style="color: var(--text-primary);">Poor Risk Management</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-xs font-medium mb-1" style="color: var(--text-secondary);">Trade Journal & Notes</label>
                    <textarea id="exit-trade-notes" rows="2" class="w-full px-3 py-2 text-sm border rounded-md" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);" placeholder="Enter your trade notes and observations..."></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3 mt-6 pt-4 border-t" style="border-color: var(--border-color);">
                <button id="exit-trade-cancel" class="px-4 py-2 text-sm font-medium border rounded-md hover:bg-gray-50" style="background-color: var(--bg-primary); border-color: var(--border-color); color: var(--text-primary);">
                    Cancel
                </button>
                <button id="exit-trade-submit" class="px-4 py-2 text-sm font-medium text-white rounded-md hover:bg-gray-800" style="background-color: var(--text-primary);">
                    Exit Trade
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Tooltip Container for Accessibility -->
    <div id="chartjs-custom-tooltip" aria-live="polite" role="tooltip" aria-hidden="true"></div>
</body>
</html>

</html>


